<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Build an API Server in Go - Part 4: Access Control | Bartlomiej Mika</title><meta name=keywords content="Golang,API,Security,HOWTO"><meta name=description content="Learn how to protect API endpoints with access and refresh tokens using the third-party jwt-go library."><meta name=author content="Bartlomiej Mika"><link rel=canonical href=https://bartlomiejmika.com/posts/2021/how-to-build-an-api-server-in-go-part-4-access-control/><meta name=google-site-verification content="UA-172742383-1"><link crossorigin=anonymous href=/assets/css/stylesheet.8b523f1730c922e314350296d83fd666efa16519ca136320a93df674d00b6325.css integrity="sha256-i1I/FzDJIuMUNQKW2D/WZu+hZRnKE2MgqT32dNALYyU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://bartlomiejmika.com/img/favicon.ico><link rel=apple-touch-icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=mask-icon href=https://bartlomiejmika.com/img/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-172742383-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="How to Build an API Server in Go - Part 4: Access Control"><meta property="og:description" content="Learn how to protect API endpoints with access and refresh tokens using the third-party jwt-go library."><meta property="og:type" content="article"><meta property="og:url" content="https://bartlomiejmika.com/posts/2021/how-to-build-an-api-server-in-go-part-4-access-control/"><meta property="og:image" content="https://bartlomiejmika.com/img/2021/common/go-banner.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-31T00:02:30-04:00"><meta property="article:modified_time" content="2021-01-31T00:02:30-04:00"><meta property="og:site_name" content="Bartlomiej Mika"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bartlomiejmika.com/img/2021/common/go-banner.png"><meta name=twitter:title content="How to Build an API Server in Go - Part 4: Access Control"><meta name=twitter:description content="Learn how to protect API endpoints with access and refresh tokens using the third-party jwt-go library."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bartlomiejmika.com/posts/"},{"@type":"ListItem","position":2,"name":"How to Build an API Server in Go - Part 4: Access Control","item":"https://bartlomiejmika.com/posts/2021/how-to-build-an-api-server-in-go-part-4-access-control/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Build an API Server in Go - Part 4: Access Control","name":"How to Build an API Server in Go - Part 4: Access Control","description":"Learn how to protect API endpoints with access and refresh tokens using the third-party jwt-go library.\n","keywords":["Golang","API","Security","HOWTO"],"articleBody":"Learn how to protect API endpoints with access and refresh tokens using the third-party jwt-go library.\nThis post belongs to the following series:\nHow to Build an API Server in Go - Part 1: Basic Server How to Build an API Server in Go - Part 2: Simple Database How to Build an API Server in Go - Part 3: Postgres Database How to Build an API Server in Go - Part 4: Access Control Authentication Just as a reminder this is part 4 of the series, you’ll need to finish part 3 before continuing.\nStructure 📦mulberry-server │ 📄README.md │ 📄Makefile │ └───📁cmd │ | | └───📁serve | 📄main.go │ └───📁internal | │ | └───📁controllers | │ 📄controller.go | │ 📄middleware.go | │ 📄tsd.go | │ 📄user.go | │ 📄version.go | | | └───📁repositories | 📄tsd.go | 📄user.go | └───📁pkg | └───📁db | 📄db.go | └───📁models | 📄tsd.go | 📄user.go | └───📁utils 📄jwt.go 📄password.go models package user.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 // github.com/bartmika/mulberry-server/internal/models/user.go package models import ( \"context\" ) // The definition of the user record we will saving in our database. type User struct { Uuid string `json:\"uuid\"` Name string `json:\"name\"` Email string `json:\"email\"` PasswordHash string `json:\"password_hash\"` } // The interface that *must* be implemented. type UserRepository interface { Create(ctx context.Context, uuid string, name string, email string, passwordHash string) error FindByUuid(ctx context.Context, uuid string) (*User, error) FindByEmail(ctx context.Context, email string) (*User, error) Save(ctx context.Context, user *User) error } // The struct used to represent the user's `register` POST request data. type RegisterRequest struct { Name string `json:\"name\"` Email string `json:\"email\"` Password string `json:\"password\"` } // The struct used to represent the system's response when the `register` POST request was a success. type RegisterResponse struct { Message string `json:\"message\"` } // The struct used to represent the user's `login` POST request data. type LoginRequest struct { Email string `json:\"email\"` Password string `json:\"password\"` } // The struct used to represent the system's response when the `login` POST request was a success. type LoginResponse struct { AccessToken string `json:\"access_token\"` RefreshToken string `json:\"refresh_token\"` } // The struct used to represent the user's `refresh token` POST request data. type RefreshTokenRequest struct { Value string `json:\"value\"` } // The struct used to represent the system's response when the `refresh token` POST request was a success. type RefreshTokenResponse struct { AccessToken string `json:\"access_token\"` RefreshToken string `json:\"refresh_token\"` } utils package jwt.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 // github.com/bartmika/mulberry-server/pkg/utils/jwt.go package utils import ( \"time\" jwt \"github.com/dgrijalva/jwt-go\" ) // Generate the `access token` and `refresh token` for the secret key. func GenerateJWTTokenPair(hmacSecret []byte, clientUuid string) (string, string, error) { // // Generate token. // token := jwt.New(jwt.SigningMethodHS256) claims := token.Claims.(jwt.MapClaims) claims[\"user_uuid\"] = clientUuid claims[\"exp\"] = time.Now().Add(time.Hour * 1).Unix() tokenString, err := token.SignedString(hmacSecret) if err != nil { return \"\", \"\", err } // // Generate refresh token. // refreshToken := jwt.New(jwt.SigningMethodHS256) rtClaims := refreshToken.Claims.(jwt.MapClaims) rtClaims[\"user_uuid\"] = clientUuid rtClaims[\"exp\"] = time.Now().Add(time.Hour * 72).Unix() refreshTokenString, err := refreshToken.SignedString(hmacSecret) if err != nil { return \"\", \"\", err } return tokenString, refreshTokenString, nil } // Validates either the `access token` or `refresh token` and returns either the // `user_uuid` if success or error on failure. func ProcessJWTToken(hmacSecret []byte, reqToken string) (string, error){ token, err := jwt.Parse(reqToken, func(t *jwt.Token) (interface{}, error) { return hmacSecret, nil }) if err == nil \u0026\u0026 token.Valid { if claims, ok := token.Claims.(jwt.MapClaims); ok \u0026\u0026 token.Valid { user_uuid := claims[\"user_uuid\"].(string) // m[\"exp\"] := string(claims[\"exp\"].(float64)) return user_uuid, nil } else { return \"\", err } } else { return \"\", err } return \"\", nil } controllers package middleware.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 // github.com/bartmika/mulberry-server/internal/controllers/middleware.go package controllers import ( \"os\" \"context\" \"strings\" \"log\" \"net/http\" \"github.com/bartmika/mulberry-server/pkg/utils\" ) // Middleware will split the full URL path into slash-sperated parts and save to // the context to flow downstream in the app for this particular request. func URLProcessorMiddleware(fn http.HandlerFunc) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { // Split path into slash-separated parts, for example, path \"/foo/bar\" // gives p==[\"foo\", \"bar\"] and path \"/\" gives p==[\"\"]. Our API starts with // \"/api/v1\", as a result we will start the array slice at \"3\". p := strings.Split(r.URL.Path, \"/\")[3:] // log.Println(p) // For debugging purposes only. // Open our program's context based on the request and save the // slash-seperated array from our URL path. ctx := r.Context() ctx = context.WithValue(ctx, \"url_split\", p) // Flow to the next middleware. fn(w, r.WithContext(ctx)) } } func JWTProcessorMiddleware(fn http.HandlerFunc) http.HandlerFunc { return func(w http.ResponseWriter, r *http.Request) { ctx := r.Context() // Read our application's signing key and attach it to the application // context so it can flow downstream in all our applications. mySigningKey := []byte(os.Getenv(\"MULBERRY_APP_SIGNING_KEY\")) ctx = context.WithValue(ctx, \"jwt_signing_key\", mySigningKey) reqToken := r.Header.Get(\"Authorization\") if reqToken != \"\" { // Special thanks to \"poise\" via https://stackoverflow.com/a/44700761 splitToken := strings.Split(reqToken, \"Bearer \") reqToken = splitToken[1] // log.Println(reqToken) // For debugging purposes only. user_uuid, err := utils.ProcessJWTToken(mySigningKey, reqToken) if err == nil { ctx = context.WithValue(ctx, \"is_authorized\", true) ctx = context.WithValue(ctx, \"user_uuid\", user_uuid) // Flow to the next middleware with our JWT token saved. fn(w, r.WithContext(ctx)) return } log.Println(\"JWTProcessorMiddleware | ProcessJWT | err\", err) } // Flow to the next middleware without anything done. ctx = context.WithValue(ctx, \"is_authorized\", false) fn(w, r.WithContext(ctx)) } } func ChainMiddleware(fn http.HandlerFunc) http.HandlerFunc { // Attach our middleware fn = URLProcessorMiddleware(fn) fn = JWTProcessorMiddleware(fn) return func(w http.ResponseWriter, r *http.Request) { // Flow to the next middleware. fn(w, r) } } controller.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 // github.com/bartmika/mulberry-server/internal/controllers/controller.go package controllers import ( \"net/http\" \"github.com/bartmika/mulberry-server/internal/repositories\" ) type Controller struct { UserRepo *repositories.UserRepo TsdRepo *repositories.TimeSeriesDatumRepo } func New(u *repositories.UserRepo, tsd *repositories.TimeSeriesDatumRepo) (*Controller) { return \u0026Controller{ UserRepo: u, TsdRepo: tsd, } } func (c *Controller) HandleRequests(w http.ResponseWriter, r *http.Request) { w.Header().Set(\"Content-Type\", \"application/json\") // Get our URL paths which are slash-seperated. ctx := r.Context() p := ctx.Value(\"url_split\").([]string) n := len(p) // Get our authorization information. isAuthorized := ctx.Value(\"is_authorized\").(bool) switch { case n == 1 \u0026\u0026 p[0] == \"version\" \u0026\u0026 r.Method == http.MethodGet: c.getVersion(w, r) case n == 1 \u0026\u0026 p[0] == \"login\" \u0026\u0026 r.Method == http.MethodPost: c.postLogin(w, r) case n == 1 \u0026\u0026 p[0] == \"register\" \u0026\u0026 r.Method == http.MethodPost: c.postRegister(w, r) case n == 1 \u0026\u0026 p[0] == \"refresh-token\" \u0026\u0026 r.Method == http.MethodPost: c.postRefreshToken(w, r) case n == 1 \u0026\u0026 p[0] == \"time-series-data\" \u0026\u0026 r.Method == http.MethodGet: if isAuthorized { c.getTimeSeriesData(w, r) } else { http.Error(w, \"Unauthorized - access token expired or invalid\", http.StatusUnauthorized) } case n == 1 \u0026\u0026 p[0] == \"time-series-data\" \u0026\u0026 r.Method == http.MethodPost: if isAuthorized { c.postTimeSeriesData(w, r) } else { http.Error(w, \"Unauthorized - access token expired or invalid\", http.StatusUnauthorized) } case n == 2 \u0026\u0026 p[0] == \"time-series-datum\" \u0026\u0026 r.Method == http.MethodGet: if isAuthorized { c.getTimeSeriesDatum(w, r, p[1]) } else { http.Error(w, \"Unauthorized - access token expired or invalid\", http.StatusUnauthorized) } case n == 2 \u0026\u0026 p[0] == \"time-series-datum\" \u0026\u0026 r.Method == http.MethodPut: if isAuthorized { c.putTimeSeriesDatum(w, r, p[1]) } else { http.Error(w, \"Unauthorized - access token expired or invalid\", http.StatusUnauthorized) } case n == 2 \u0026\u0026 p[0] == \"time-series-datum\" \u0026\u0026 r.Method == http.MethodDelete: if isAuthorized { c.deleteTimeSeriesDatum(w, r, p[1]) } else { http.Error(w, \"Unauthorized - access token expired or invalid\", http.StatusUnauthorized) } default: http.NotFound(w, r) } } user.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 // FILE LOCATION: github.com/bartmika/mulberry-server/internal/controllers/user.go package controllers import ( \"encoding/json\" \"log\" \"net/http\" \"github.com/google/uuid\" \"github.com/bartmika/mulberry-server/pkg/models\" \"github.com/bartmika/mulberry-server/pkg/utils\" ) // To run this API, try running in your console: // $ http post 127.0.0.1:5000/api/v1/register email=\"fherbert@dune.com\" password=\"the-spice-must-flow\" name=\"Frank Herbert\" func (c *Controller) postRegister(w http.ResponseWriter, r *http.Request) { ctx := r.Context() // Initialize our array which will store all the results from the remote server. var requestData models.RegisterRequest // Read the JSON string and convert it into our golang stuct else we need // to send a `400 Bad Request` errror message back to the client, err := json.NewDecoder(r.Body).Decode(\u0026requestData) // [1] if err != nil { http.Error(w, err.Error(), http.StatusBadRequest) return } // // For debugging purposes, print our output so you can see the code working. // fmt.Println(requestData.Name) // fmt.Println(requestData.Email) // fmt.Println(requestData.Password) // Lookup the email and if it is not unique we need to generate a `400 Bad Request` response. if userFound, _ := c.UserRepo.FindByEmail(ctx, requestData.Email); userFound != nil { http.Error(w, \"Email alread exists\", http.StatusBadRequest) return } // Generate a `UUID` for our record. uid := uuid.New().String() // Secure our password. passwordHash, err := utils.HashPassword(requestData.Password) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } // Save our new user account. if err := c.UserRepo.Create(ctx, uid, requestData.Name, requestData.Email, passwordHash); err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } // Generate our response. responseData := models.RegisterResponse{ Message: \"You have successfully registered an account.\", } if err := json.NewEncoder(w).Encode(\u0026responseData); err != nil { // [2] http.Error(w, err.Error(), http.StatusInternalServerError) return } } // To run this API, try running in your console: // $ http post 127.0.0.1:5000/api/v1/login email=\"fherbert@dune.com\" password=\"the-spice-must-flow\" func (c *Controller) postLogin(w http.ResponseWriter, r *http.Request) { ctx := r.Context() var requestData models.LoginRequest err := json.NewDecoder(r.Body).Decode(\u0026requestData) if err != nil { http.Error(w, err.Error(), http.StatusBadRequest) return } // // For debugging purposes, print our output so you can see the code working. // fmt.Println(requestData.Email) // fmt.Println(requestData.Password) // Lookup the user in our database, else return a `400 Bad Request` error. user, err := c.UserRepo.FindByEmail(ctx, requestData.Email) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } if user == nil { http.Error(w, \"Email does not exist\", http.StatusBadRequest) return } // Verify the inputted password and hashed password match. passwordMatch := utils.CheckPasswordHash(requestData.Password, user.PasswordHash) if passwordMatch == false { http.Error(w, \"Incorrect password\", http.StatusBadRequest) return } // Generate our JWT token. mySigningKey := ctx.Value(\"jwt_signing_key\").([]byte) accessToken, refreshToken, err := utils.GenerateJWTTokenPair(mySigningKey, user.Uuid) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } // Finally return success. responseData := models.LoginResponse{ AccessToken: accessToken, RefreshToken: refreshToken, } if err := json.NewEncoder(w).Encode(\u0026responseData); err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } } // To run this API, try running in your console: // $ http post 127.0.0.1:5000/api/v1/refresh-token value=\"xxx\" func (c *Controller) postRefreshToken(w http.ResponseWriter, r *http.Request) { var requestData models.RefreshTokenRequest err := json.NewDecoder(r.Body).Decode(\u0026requestData) if err != nil { http.Error(w, err.Error(), http.StatusBadRequest) return } // // For debugging purposes, print our output so you can see the code working. log.Println(requestData.Value) ctx := r.Context() mySigningKey := ctx.Value(\"jwt_signing_key\").([]byte) // Verify our refresh token. user_uuid, err := utils.ProcessJWTToken(mySigningKey, requestData.Value) if err != nil { http.Error(w, \"Unauthorized - refresh token expired or invalid\", http.StatusUnauthorized) return } // Generate our JWT token. accessToken, refreshToken, err := utils.GenerateJWTTokenPair(mySigningKey, user_uuid) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } // Finally return success. responseData := models.RefreshTokenResponse{ AccessToken: accessToken, RefreshToken: refreshToken, } if err := json.NewEncoder(w).Encode(\u0026responseData); err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } } // SPECIAL THANKS: // [1][2]: Learned from: // a. https://blog.golang.org/json // b. https://stackoverflow.com/questions/21197239/decoding-json-using-json-unmarshal-vs-json-newdecoder-decode tsd.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 // FILE LOCATION: github.com/bartmika/mulberry-server/internal/controllers/tsd.go package controllers import ( // \"fmt\" \"net/http\" \"encoding/json\" \"github.com/google/uuid\" \"github.com/bartmika/mulberry-server/pkg/models\" ) // To run this API, try running in your console: // $ http get 127.0.0.1:5000/api/v1/time-series-data func (c *Controller) getTimeSeriesData(w http.ResponseWriter, r *http.Request) { ctx := r.Context() userUuid := ctx.Value(\"user_uuid\").(string) results, err := c.TsdRepo.FilterByUserUuid(ctx, userUuid) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } // Encode our results if err := json.NewEncoder(w).Encode(\u0026results); err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } } // To run this API, try running in your console: // $ http post 127.0.0.1:5000/api/v1/time-series-data instrument_uuid=\"lalala\" value=\"123\" timestamp=\"2021-01-30T10:20:10.000Z\" user_uuid=\"lalala\" func (c *Controller) postTimeSeriesData(w http.ResponseWriter, r *http.Request) { ctx := r.Context() userUuid := ctx.Value(\"user_uuid\").(string) var requestData models.TimeSeriesDatumCreateRequest if err := json.NewDecoder(r.Body).Decode(\u0026requestData); err != nil { http.Error(w, err.Error(), http.StatusBadRequest) return } // // For debugging purposes only. // fmt.Println(requestData.InstrumentUuid) // fmt.Println(requestData.Value) // fmt.Println(requestData.Timestamp) // fmt.Println(requestData.UserUuid) // Generate a `UUID` for our record. uid := uuid.New().String() // Save to our database. err := c.TsdRepo.Create(ctx, uid, requestData.InstrumentUuid, requestData.Value, requestData.Timestamp, userUuid) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } w.WriteHeader(http.StatusCreated) // Return our record. responseData := models.TimeSeriesDatumCreateResponse{ Uuid: uid, InstrumentUuid: requestData.InstrumentUuid, Value: requestData.Value, Timestamp: requestData.Timestamp, UserUuid: userUuid, } if err := json.NewEncoder(w).Encode(\u0026responseData); err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } } // To run this API, try running in your console: // $ http get 127.0.0.1:5000/api/v1/time-series-datum/f3e7b442-f3d4-4c2f-8f8d-d347982c1569 func (c *Controller) getTimeSeriesDatum(w http.ResponseWriter, r *http.Request, uuid string) { ctx := r.Context() userUuid := ctx.Value(\"user_uuid\").(string) // Lookup our record. tsd, err := c.TsdRepo.FindByUuid(ctx, uuid) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } // Enforce account access. if tsd.UserUuid != userUuid { http.Error(w, \"Forbidden\", http.StatusForbidden) return } // Return our record to the user as a response. if err := json.NewEncoder(w).Encode(\u0026tsd); err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } } // To run this API, try running in your console: // $ http put 127.0.0.1:5000/api/v1/time-series-datum/f3e7b442-f3d4-4c2f-8f8d-d347982c1569 instrument_uuid=\"lalala\" value=\"321\" timestamp=\"2021-01-30T10:20:10.000Z\" user_uuid=\"lalala\" func (c *Controller) putTimeSeriesDatum(w http.ResponseWriter, r *http.Request, uid string) { ctx := r.Context() userUuid := ctx.Value(\"user_uuid\").(string) // Lookup our record and enforce account access. tsd, err := c.TsdRepo.FindByUuid(ctx, uid) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } if tsd.UserUuid != userUuid { http.Error(w, \"Forbidden\", http.StatusForbidden) return } var requestData models.TimeSeriesDatumPutRequest if err := json.NewDecoder(r.Body).Decode(\u0026requestData); err != nil { http.Error(w, err.Error(), http.StatusBadRequest) return } // // For debugging purposes only. // fmt.Println(uid) // fmt.Println(requestData.InstrumentUuid) // fmt.Println(requestData.Value) // fmt.Println(requestData.Timestamp) // fmt.Println(requestData.UserUuid) // Update our record. tsd = \u0026models.TimeSeriesDatum{ Uuid: uid, InstrumentUuid: requestData.InstrumentUuid, Value: requestData.Value, Timestamp: requestData.Timestamp, UserUuid: userUuid, } err = c.TsdRepo.Save(ctx, tsd) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } // Return our record to the user as a response. if err := json.NewEncoder(w).Encode(\u0026tsd); err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } } // To run this API, try running in your console: // $ http delete 127.0.0.1:5000/api/v1/time-series-datum/f3e7b442-f3d4-4c2f-8f8d-d347982c1569 func (c *Controller) deleteTimeSeriesDatum(w http.ResponseWriter, r *http.Request, uid string) { ctx := r.Context() userUuid := ctx.Value(\"user_uuid\").(string) // Lookup our record and enforce account access. tsd, err := c.TsdRepo.FindByUuid(ctx, uid) if err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) return } if tsd.UserUuid != userUuid { http.Error(w, \"Forbidden\", http.StatusForbidden) return } if err := c.TsdRepo.DeleteByUuid(ctx, uid); err != nil { http.Error(w, err.Error(), http.StatusInternalServerError) } w.WriteHeader(http.StatusOK) // Note: https://tools.ietf.org/html/rfc7231#section-6.3.1 } serve package main.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 // github.com/bartmika/mulberry-server/cmd/serve/main.go package main import ( \"context\" \"fmt\" \"log\" \"net/http\" \"os\" \"os/signal\" \"syscall\" \"time\" sqldb \"github.com/bartmika/mulberry-server/pkg/db\" \"github.com/bartmika/mulberry-server/internal/repositories\" \"github.com/bartmika/mulberry-server/internal/controllers\" ) func main() { // Get our environment variables which will used to configure our application. databaseHost := os.Getenv(\"MULBERRY_DB_HOST\") databasePort := os.Getenv(\"MULBERRY_DB_PORT\") databaseUser := os.Getenv(\"MULBERRY_DB_USER\") databasePassword := os.Getenv(\"MULBERRY_DB_PASSWORD\") databaseName := os.Getenv(\"MULBERRY_DB_NAME\") db, err := sqldb.ConnectDB(databaseHost, databasePort, databaseUser, databasePassword, databaseName) if err != nil { log.Fatal(err) } defer db.Close() userRepo := repositories.NewUserRepo(db) tsdRepo := repositories.NewTimeSeriesDatumRepo(db) c := controllers.New(userRepo, tsdRepo) mux := http.NewServeMux() mux.HandleFunc(\"/\", controllers.ChainMiddleware(c.HandleRequests)) srv := \u0026http.Server{ Addr: fmt.Sprintf(\"%s:%s\", \"localhost\", \"5000\"), Handler: mux, } done := make(chan os.Signal, 1) signal.Notify(done, os.Interrupt, syscall.SIGINT, syscall.SIGTERM) go runMainRuntimeLoop(srv) log.Print(\"Server Started\") // Run the main loop blocking code. \u003c-done stopMainRuntimeLoop(srv) } func runMainRuntimeLoop(srv *http.Server) { if err := srv.ListenAndServe(); err != nil \u0026\u0026 err != http.ErrServerClosed { log.Fatalf(\"listen: %s\\n\", err) } } func stopMainRuntimeLoop(srv *http.Server) { log.Printf(\"Starting graceful shutdown now...\") // Execute the graceful shutdown sub-routine which will terminate any // active connections and reject any new connections. ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second) defer func() { // extra handling here cancel() }() if err := srv.Shutdown(ctx); err != nil { log.Fatalf(\"Server Shutdown Failed:%+v\", err) } log.Printf(\"Graceful shutdown finished.\") log.Print(\"Server Exited\") } Testing Starting the Server We are going to use environment variables to load configuration settings for our application.\nexport MULBERRY_DB_HOST=localhost export MULBERRY_DB_PORT=5432 export MULBERRY_DB_USER=golang export MULBERRY_DB_PASSWORD=123password export MULBERRY_DB_NAME=mulberry_db export MULBERRY_APP_SIGNING_KEY=PLEASE_REPLACE_ME And now you can run the code:\ngo run cmd/serve/main.go In another terminal run the following code to make a login call:\nbmika@MACMINI-AFA2131 mulberry-server % http post 127.0.0.1:5000/api/v1/login email=\"fherbert@dune.com\" password=\"the-spice-must-flow\" The return should look as follows:\nHTTP/1.1 200 OK Content-Length: 385 Content-Type: application/json Date: Mon, 01 Feb 2021 04:27:46 GMT { \"access_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTIxNTcyNjYsInVzZXJfdXVpZCI6IjlkZDJjYzBhLTkzNGQtNDc4OC04MzA0LTFlMGI4MmQ5YjZlNiJ9.ZKe5DargCrHZcAQQ71M46uUr0TWk9UYkiURijaKBABA\", \"refresh_token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI0MTI4NjYsInVzZXJfdXVpZCI6IjlkZDJjYzBhLTkzNGQtNDc4OC04MzA0LTFlMGI4MmQ5YjZlNiJ9.odXNQd1hm3cLPI9_e2jfjYXjgjf7wfxQ8hCx3-qqZYY\" } Please save the output the “access_token” so you can write in your console.\nexport MULBERRY_API_TOKEN=\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTIxNTcyNjYsInVzZXJfdXVpZCI6IjlkZDJjYzBhLTkzNGQtNDc4OC04MzA0LTFlMGI4MmQ5YjZlNiJ9.ZKe5DargCrHZcAQQ71M46uUr0TWk9UYkiURijaKBABA\" Next run the following call to a protected API:\nhttp get 127.0.0.1:5000/api/v1/time-series-data Authorization:\"Bearer $MULBERRY_API_TOKEN\" And your result should look like this:\nHTTP/1.1 200 OK Content-Length: 175 Content-Type: application/json Date: Sun, 31 Jan 2021 22:57:40 GMT [ { \"instrument_uuid\": \"lalala\", \"timestamp\": \"2021-01-30T10:20:10Z\", \"user_uuid\": \"9dd2cc0a-934d-4788-8304-1e0b82d9b6e6\", \"uuid\": \"923148e4-5dd9-4ec7-bf04-4a50f880c7db\", \"value\": 123 } ]","wordCount":"3313","inLanguage":"en","image":"https://bartlomiejmika.com/img/2021/common/go-banner.png","datePublished":"2021-01-31T00:02:30-04:00","dateModified":"2021-01-31T00:02:30-04:00","author":{"@type":"Person","name":"Bartlomiej Mika"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bartlomiejmika.com/posts/2021/how-to-build-an-api-server-in-go-part-4-access-control/"},"publisher":{"@type":"Organization","name":"Bartlomiej Mika","logo":{"@type":"ImageObject","url":"https://bartlomiejmika.com/img/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bartlomiejmika.com/ accesskey=h title="Bartlomiej Mika (Alt + H)"><img src=https://bartlomiejmika.com/img/bartlomiej_mika.jpeg alt=logo aria-label=logo height=35>Bartlomiej Mika</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bartlomiejmika.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://bartlomiejmika.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://bartlomiejmika.com/pages/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bartlomiejmika.com/>Home</a>&nbsp;»&nbsp;<a href=https://bartlomiejmika.com/posts/>Posts</a></div><h1 class=post-title>How to Build an API Server in Go - Part 4: Access Control</h1><div class=post-meta><span title='2021-01-31 00:02:30 -0400 -0400'>January 31, 2021</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;3313 words&nbsp;·&nbsp;Bartlomiej Mika&nbsp;|&nbsp;<a href=https://github.com/bartmika/bartlomiejmika-hugo/tree/master/content/posts/2021/how-to-build-an-api-server-in-go-part-4-access-control.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://bartlomiejmika.com/img/2021/common/go-banner.png alt=Go></figure><div class=post-content><p>Learn how to protect API endpoints with access and refresh tokens using the third-party <a href=https://github.com/dgrijalva/jwt-go>jwt-go</a> library.</p><p>This post belongs to the following series:</p><ol><li><a href=/posts/2021/how-to-build-an-api-server-in-go-part-1-basic-server/>How to Build an API Server in Go - Part 1: Basic Server</a></li><li><a href=/posts/2021/how-to-build-an-api-server-in-go-part-2-simple-database/>How to Build an API Server in Go - Part 2: Simple Database</a></li><li><a href=/posts/2021/how-to-build-an-api-server-in-go-part-3-postgres-database/>How to Build an API Server in Go - Part 3: Postgres Database</a></li><li><strong>How to Build an API Server in Go - Part 4: Access Control</strong></li></ol><h1 id=authentication>Authentication<a hidden class=anchor aria-hidden=true href=#authentication>#</a></h1><p>Just as a reminder this is part 4 of the series, you&rsquo;ll need to finish <a href=/posts/2021/how-to-write-a-webserver-in-golang-using-only-the-std-net-http-part-3/>part 3</a> before continuing.</p><h2 id=structure>Structure<a hidden class=anchor aria-hidden=true href=#structure>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>📦mulberry-server
</span></span><span class=line><span class=cl>│   📄README.md
</span></span><span class=line><span class=cl>│   📄Makefile
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>└───📁cmd
</span></span><span class=line><span class=cl>│   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   └───📁serve
</span></span><span class=line><span class=cl><span class=p>|</span>       📄main.go
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>└───📁internal
</span></span><span class=line><span class=cl><span class=p>|</span>   │
</span></span><span class=line><span class=cl><span class=p>|</span>   └───📁controllers
</span></span><span class=line><span class=cl><span class=p>|</span>   │   📄controller.go
</span></span><span class=line><span class=cl><span class=p>|</span>   │   📄middleware.go
</span></span><span class=line><span class=cl><span class=p>|</span>   │   📄tsd.go
</span></span><span class=line><span class=cl><span class=p>|</span>   │   📄user.go
</span></span><span class=line><span class=cl><span class=p>|</span>   │   📄version.go
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   └───📁repositories
</span></span><span class=line><span class=cl><span class=p>|</span>       📄tsd.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄user.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>└───📁pkg
</span></span><span class=line><span class=cl>    <span class=p>|</span>
</span></span><span class=line><span class=cl>    └───📁db
</span></span><span class=line><span class=cl>    <span class=p>|</span>   📄db.go
</span></span><span class=line><span class=cl>    <span class=p>|</span>
</span></span><span class=line><span class=cl>    └───📁models
</span></span><span class=line><span class=cl>    <span class=p>|</span>   📄tsd.go
</span></span><span class=line><span class=cl>    <span class=p>|</span>   📄user.go
</span></span><span class=line><span class=cl>    <span class=p>|</span>
</span></span><span class=line><span class=cl>    └───📁utils
</span></span><span class=line><span class=cl>        📄jwt.go
</span></span><span class=line><span class=cl>        📄password.go</span></span></code></pre></div><h2 id=models-package>models package<a hidden class=anchor aria-hidden=true href=#models-package>#</a></h2><h3 id=usergo>user.go<a hidden class=anchor aria-hidden=true href=#usergo>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/bartmika/mulberry-server/internal/models/user.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>models</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The definition of the user record we will saving in our database.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Uuid</span> <span class=kt>string</span>          <span class=s>`json:&#34;uuid&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span> <span class=kt>string</span>          <span class=s>`json:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Email</span> <span class=kt>string</span>         <span class=s>`json:&#34;email&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>PasswordHash</span> <span class=kt>string</span>  <span class=s>`json:&#34;password_hash&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The interface that *must* be implemented.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>UserRepository</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>uuid</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>email</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>passwordHash</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>FindByUuid</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>uuid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>User</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>FindByEmail</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>email</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>User</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>user</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The struct used to represent the user&#39;s `register` POST request data.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>RegisterRequest</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span> <span class=kt>string</span>     <span class=s>`json:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Email</span> <span class=kt>string</span>    <span class=s>`json:&#34;email&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Password</span> <span class=kt>string</span> <span class=s>`json:&#34;password&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The struct used to represent the system&#39;s response when the `register` POST request was a success.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>RegisterResponse</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Message</span> <span class=kt>string</span> <span class=s>`json:&#34;message&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The struct used to represent the user&#39;s `login` POST request data.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>LoginRequest</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Email</span> <span class=kt>string</span>    <span class=s>`json:&#34;email&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Password</span> <span class=kt>string</span> <span class=s>`json:&#34;password&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The struct used to represent the system&#39;s response when the `login` POST request was a success.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>LoginResponse</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>AccessToken</span> <span class=kt>string</span> <span class=s>`json:&#34;access_token&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>RefreshToken</span> <span class=kt>string</span> <span class=s>`json:&#34;refresh_token&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The struct used to represent the user&#39;s `refresh token` POST request data.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>RefreshTokenRequest</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Value</span> <span class=kt>string</span>     <span class=s>`json:&#34;value&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The struct used to represent the system&#39;s response when the `refresh token` POST request was a success.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>RefreshTokenResponse</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>AccessToken</span> <span class=kt>string</span> <span class=s>`json:&#34;access_token&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>RefreshToken</span> <span class=kt>string</span> <span class=s>`json:&#34;refresh_token&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=utils-package>utils package<a hidden class=anchor aria-hidden=true href=#utils-package>#</a></h2><h3 id=jwtgo>jwt.go<a hidden class=anchor aria-hidden=true href=#jwtgo>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/bartmika/mulberry-server/pkg/utils/jwt.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>utils</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>jwt</span> <span class=s>&#34;github.com/dgrijalva/jwt-go&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Generate the `access token` and `refresh token` for the secret key.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GenerateJWTTokenPair</span><span class=p>(</span><span class=nx>hmacSecret</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>clientUuid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Generate token.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>token</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>SigningMethodHS256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>claims</span> <span class=o>:=</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Claims</span><span class=p>.(</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>MapClaims</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>claims</span><span class=p>[</span><span class=s>&#34;user_uuid&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>clientUuid</span>
</span></span><span class=line><span class=cl>    <span class=nx>claims</span><span class=p>[</span><span class=s>&#34;exp&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span> <span class=o>*</span> <span class=mi>1</span><span class=p>).</span><span class=nf>Unix</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>tokenString</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>token</span><span class=p>.</span><span class=nf>SignedString</span><span class=p>(</span><span class=nx>hmacSecret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Generate refresh token.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>refreshToken</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>SigningMethodHS256</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rtClaims</span> <span class=o>:=</span> <span class=nx>refreshToken</span><span class=p>.</span><span class=nx>Claims</span><span class=p>.(</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>MapClaims</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rtClaims</span><span class=p>[</span><span class=s>&#34;user_uuid&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>clientUuid</span>
</span></span><span class=line><span class=cl>	<span class=nx>rtClaims</span><span class=p>[</span><span class=s>&#34;exp&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span> <span class=o>*</span> <span class=mi>72</span><span class=p>).</span><span class=nf>Unix</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>refreshTokenString</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>refreshToken</span><span class=p>.</span><span class=nf>SignedString</span><span class=p>(</span><span class=nx>hmacSecret</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>tokenString</span><span class=p>,</span> <span class=nx>refreshTokenString</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Validates either the `access token` or `refresh token` and returns either the
</span></span></span><span class=line><span class=cl><span class=c1>// `user_uuid` if success or error on failure.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ProcessJWTToken</span><span class=p>(</span><span class=nx>hmacSecret</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>reqToken</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nx>token</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>reqToken</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>Token</span><span class=p>)</span> <span class=p>(</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>hmacSecret</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>claims</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Claims</span><span class=p>.(</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>MapClaims</span><span class=p>);</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>token</span><span class=p>.</span><span class=nx>Valid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>user_uuid</span> <span class=o>:=</span> <span class=nx>claims</span><span class=p>[</span><span class=s>&#34;user_uuid&#34;</span><span class=p>].(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1>// m[&#34;exp&#34;] := string(claims[&#34;exp&#34;].(float64))
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=nx>user_uuid</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=controllers-package>controllers package<a hidden class=anchor aria-hidden=true href=#controllers-package>#</a></h2><h3 id=middlewarego>middleware.go<a hidden class=anchor aria-hidden=true href=#middlewarego>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/bartmika/mulberry-server/internal/controllers/middleware.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strings&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/mulberry-server/pkg/utils&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Middleware will split the full URL path into slash-sperated parts and save to
</span></span></span><span class=line><span class=cl><span class=c1>// the context to flow downstream in the app for this particular request.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>URLProcessorMiddleware</span><span class=p>(</span><span class=nx>fn</span> <span class=nx>http</span><span class=p>.</span><span class=nx>HandlerFunc</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Split path into slash-separated parts, for example, path &#34;/foo/bar&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// gives p==[&#34;foo&#34;, &#34;bar&#34;] and path &#34;/&#34; gives p==[&#34;&#34;]. Our API starts with
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// &#34;/api/v1&#34;, as a result we will start the array slice at &#34;3&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>p</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nx>Path</span><span class=p>,</span> <span class=s>&#34;/&#34;</span><span class=p>)[</span><span class=mi>3</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// log.Println(p) // For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>// Open our program&#39;s context based on the request and save the
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// slash-seperated array from our URL path.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;url_split&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Flow to the next middleware.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>fn</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>JWTProcessorMiddleware</span><span class=p>(</span><span class=nx>fn</span> <span class=nx>http</span><span class=p>.</span><span class=nx>HandlerFunc</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Read our application&#39;s signing key and attach it to the application
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// context so it can flow downstream in all our applications.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>mySigningKey</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;MULBERRY_APP_SIGNING_KEY&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;jwt_signing_key&#34;</span><span class=p>,</span> <span class=nx>mySigningKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>reqToken</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;Authorization&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>reqToken</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Special thanks to &#34;poise&#34; via https://stackoverflow.com/a/44700761
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>splitToken</span> <span class=o>:=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>Split</span><span class=p>(</span><span class=nx>reqToken</span><span class=p>,</span> <span class=s>&#34;Bearer &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>reqToken</span> <span class=p>=</span> <span class=nx>splitToken</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// log.Println(reqToken) // For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=nx>user_uuid</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>ProcessJWTToken</span><span class=p>(</span><span class=nx>mySigningKey</span><span class=p>,</span> <span class=nx>reqToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;is_authorized&#34;</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;user_uuid&#34;</span><span class=p>,</span> <span class=nx>user_uuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// Flow to the next middleware with our JWT token saved.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nf>fn</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;JWTProcessorMiddleware | ProcessJWT | err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Flow to the next middleware without anything done.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>ctx</span> <span class=p>=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=s>&#34;is_authorized&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>fn</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>ChainMiddleware</span><span class=p>(</span><span class=nx>fn</span> <span class=nx>http</span><span class=p>.</span><span class=nx>HandlerFunc</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>HandlerFunc</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Attach our middleware
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fn</span> <span class=p>=</span> <span class=nf>URLProcessorMiddleware</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>fn</span> <span class=p>=</span> <span class=nf>JWTProcessorMiddleware</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Flow to the next middleware.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>fn</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=controllergo>controller.go<a hidden class=anchor aria-hidden=true href=#controllergo>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/bartmika/mulberry-server/internal/controllers/controller.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/mulberry-server/internal/repositories&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Controller</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>UserRepo</span> <span class=o>*</span><span class=nx>repositories</span><span class=p>.</span><span class=nx>UserRepo</span>
</span></span><span class=line><span class=cl>    <span class=nx>TsdRepo</span> <span class=o>*</span><span class=nx>repositories</span><span class=p>.</span><span class=nx>TimeSeriesDatumRepo</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>repositories</span><span class=p>.</span><span class=nx>UserRepo</span><span class=p>,</span> <span class=nx>tsd</span> <span class=o>*</span><span class=nx>repositories</span><span class=p>.</span><span class=nx>TimeSeriesDatumRepo</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>Controller</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>UserRepo</span><span class=p>:</span> <span class=nx>u</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>TsdRepo</span><span class=p>:</span> <span class=nx>tsd</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>HandleRequests</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Get our URL paths which are slash-seperated.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>p</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;url_split&#34;</span><span class=p>).([]</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>n</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Get our authorization information.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>isAuthorized</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;is_authorized&#34;</span><span class=p>).(</span><span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;version&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodGet</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>getVersion</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;login&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>postLogin</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;register&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>postRegister</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;refresh-token&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>postRefreshToken</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;time-series-data&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodGet</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>isAuthorized</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>getTimeSeriesData</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Unauthorized - access token expired or invalid&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;time-series-data&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodPost</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>isAuthorized</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>postTimeSeriesData</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Unauthorized - access token expired or invalid&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;time-series-datum&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodGet</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>isAuthorized</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>getTimeSeriesDatum</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Unauthorized - access token expired or invalid&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;time-series-datum&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodPut</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>isAuthorized</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>putTimeSeriesDatum</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Unauthorized - access token expired or invalid&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>n</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>&amp;&amp;</span> <span class=nx>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s>&#34;time-series-datum&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span> <span class=o>==</span> <span class=nx>http</span><span class=p>.</span><span class=nx>MethodDelete</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>isAuthorized</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>c</span><span class=p>.</span><span class=nf>deleteTimeSeriesDatum</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>,</span> <span class=nx>p</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Unauthorized - access token expired or invalid&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>NotFound</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=usergo-1>user.go<a hidden class=anchor aria-hidden=true href=#usergo-1>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// FILE LOCATION: github.com/bartmika/mulberry-server/internal/controllers/user.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/google/uuid&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/mulberry-server/pkg/models&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/mulberry-server/pkg/utils&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// To run this API, try running in your console:
</span></span></span><span class=line><span class=cl><span class=c1>// $ http post 127.0.0.1:5000/api/v1/register email=&#34;fherbert@dune.com&#34; password=&#34;the-spice-must-flow&#34; name=&#34;Frank Herbert&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>postRegister</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Initialize our array which will store all the results from the remote server.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>requestData</span> <span class=nx>models</span><span class=p>.</span><span class=nx>RegisterRequest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Read the JSON string and convert it into our golang stuct else we need
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// to send a `400 Bad Request` errror message back to the client,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>requestData</span><span class=p>)</span> <span class=c1>// [1]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes, print our output so you can see the code working.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Name)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Email)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Password)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Lookup the email and if it is not unique we need to generate a `400 Bad Request` response.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>userFound</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>UserRepo</span><span class=p>.</span><span class=nf>FindByEmail</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Email</span><span class=p>);</span> <span class=nx>userFound</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Email alread exists&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Generate a `UUID` for our record.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>uid</span> <span class=o>:=</span> <span class=nx>uuid</span><span class=p>.</span><span class=nf>New</span><span class=p>().</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Secure our password.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>passwordHash</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>HashPassword</span><span class=p>(</span><span class=nx>requestData</span><span class=p>.</span><span class=nx>Password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Save our new user account.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>UserRepo</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Email</span><span class=p>,</span> <span class=nx>passwordHash</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Generate our response.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>responseData</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>RegisterResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;You have successfully registered an account.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>responseData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  <span class=c1>// [2]
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// To run this API, try running in your console:
</span></span></span><span class=line><span class=cl><span class=c1>// $ http post 127.0.0.1:5000/api/v1/login email=&#34;fherbert@dune.com&#34; password=&#34;the-spice-must-flow&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>postLogin</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>requestData</span> <span class=nx>models</span><span class=p>.</span><span class=nx>LoginRequest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>requestData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes, print our output so you can see the code working.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Email)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Password)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Lookup the user in our database, else return a `400 Bad Request` error.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>user</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>UserRepo</span><span class=p>.</span><span class=nf>FindByEmail</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Email</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>user</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Email does not exist&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Verify the inputted password and hashed password match.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>passwordMatch</span> <span class=o>:=</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>CheckPasswordHash</span><span class=p>(</span><span class=nx>requestData</span><span class=p>.</span><span class=nx>Password</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>PasswordHash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>passwordMatch</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Incorrect password&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Generate our JWT token.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>mySigningKey</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;jwt_signing_key&#34;</span><span class=p>).([]</span><span class=kt>byte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>accessToken</span><span class=p>,</span> <span class=nx>refreshToken</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>GenerateJWTTokenPair</span><span class=p>(</span><span class=nx>mySigningKey</span><span class=p>,</span> <span class=nx>user</span><span class=p>.</span><span class=nx>Uuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Finally return success.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>responseData</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>LoginResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>AccessToken</span><span class=p>:</span> <span class=nx>accessToken</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>RefreshToken</span><span class=p>:</span> <span class=nx>refreshToken</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>responseData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// To run this API, try running in your console:
</span></span></span><span class=line><span class=cl><span class=c1>// $ http post 127.0.0.1:5000/api/v1/refresh-token value=&#34;xxx&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>postRefreshToken</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>requestData</span> <span class=nx>models</span><span class=p>.</span><span class=nx>RefreshTokenRequest</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>requestData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes, print our output so you can see the code working.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>requestData</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>mySigningKey</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;jwt_signing_key&#34;</span><span class=p>).([]</span><span class=kt>byte</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Verify our refresh token.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>user_uuid</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>ProcessJWTToken</span><span class=p>(</span><span class=nx>mySigningKey</span><span class=p>,</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Unauthorized - refresh token expired or invalid&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Generate our JWT token.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>accessToken</span><span class=p>,</span> <span class=nx>refreshToken</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>GenerateJWTTokenPair</span><span class=p>(</span><span class=nx>mySigningKey</span><span class=p>,</span> <span class=nx>user_uuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Finally return success.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>responseData</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>RefreshTokenResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>AccessToken</span><span class=p>:</span> <span class=nx>accessToken</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>RefreshToken</span><span class=p>:</span> <span class=nx>refreshToken</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>responseData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SPECIAL THANKS:
</span></span></span><span class=line><span class=cl><span class=c1>// [1][2]: Learned from:
</span></span></span><span class=line><span class=cl><span class=c1>// a. https://blog.golang.org/json
</span></span></span><span class=line><span class=cl><span class=c1>// b. https://stackoverflow.com/questions/21197239/decoding-json-using-json-unmarshal-vs-json-newdecoder-decode
</span></span></span></code></pre></td></tr></table></div></div><h3 id=tsdgo>tsd.go<a hidden class=anchor aria-hidden=true href=#tsdgo>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// FILE LOCATION: github.com/bartmika/mulberry-server/internal/controllers/tsd.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>controllers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// &#34;fmt&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/google/uuid&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/mulberry-server/pkg/models&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// To run this API, try running in your console:
</span></span></span><span class=line><span class=cl><span class=c1>// $ http get 127.0.0.1:5000/api/v1/time-series-data
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>getTimeSeriesData</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>userUuid</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;user_uuid&#34;</span><span class=p>).(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>results</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TsdRepo</span><span class=p>.</span><span class=nf>FilterByUserUuid</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>userUuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Encode our results
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>results</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// To run this API, try running in your console:
</span></span></span><span class=line><span class=cl><span class=c1>// $ http post 127.0.0.1:5000/api/v1/time-series-data instrument_uuid=&#34;lalala&#34; value=&#34;123&#34; timestamp=&#34;2021-01-30T10:20:10.000Z&#34; user_uuid=&#34;lalala&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>postTimeSeriesData</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>userUuid</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;user_uuid&#34;</span><span class=p>).(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>requestData</span> <span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDatumCreateRequest</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>requestData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.InstrumentUuid)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Value)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Timestamp)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.UserUuid)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Generate a `UUID` for our record.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>uid</span> <span class=o>:=</span> <span class=nx>uuid</span><span class=p>.</span><span class=nf>New</span><span class=p>().</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Save to our database.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TsdRepo</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>uid</span><span class=p>,</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>InstrumentUuid</span><span class=p>,</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>,</span> <span class=nx>userUuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusCreated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Return our record.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>responseData</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDatumCreateResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Uuid</span><span class=p>:</span> <span class=nx>uid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>InstrumentUuid</span><span class=p>:</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>InstrumentUuid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Value</span><span class=p>:</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>UserUuid</span><span class=p>:</span> <span class=nx>userUuid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>responseData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// To run this API, try running in your console:
</span></span></span><span class=line><span class=cl><span class=c1>// $ http get 127.0.0.1:5000/api/v1/time-series-datum/f3e7b442-f3d4-4c2f-8f8d-d347982c1569
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>getTimeSeriesDatum</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>uuid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>userUuid</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;user_uuid&#34;</span><span class=p>).(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Lookup our record.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>tsd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TsdRepo</span><span class=p>.</span><span class=nf>FindByUuid</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>uuid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Enforce account access.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>UserUuid</span> <span class=o>!=</span> <span class=nx>userUuid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Forbidden&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusForbidden</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Return our record to the user as a response.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>tsd</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// To run this API, try running in your console:
</span></span></span><span class=line><span class=cl><span class=c1>// $ http put 127.0.0.1:5000/api/v1/time-series-datum/f3e7b442-f3d4-4c2f-8f8d-d347982c1569 instrument_uuid=&#34;lalala&#34; value=&#34;321&#34; timestamp=&#34;2021-01-30T10:20:10.000Z&#34; user_uuid=&#34;lalala&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>putTimeSeriesDatum</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>uid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>userUuid</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;user_uuid&#34;</span><span class=p>).(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Lookup our record and enforce account access.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>tsd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TsdRepo</span><span class=p>.</span><span class=nf>FindByUuid</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>uid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>UserUuid</span> <span class=o>!=</span> <span class=nx>userUuid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Forbidden&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusForbidden</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>requestData</span> <span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDatumPutRequest</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>requestData</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(uid)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.InstrumentUuid)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Value)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.Timestamp)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// fmt.Println(requestData.UserUuid)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Update our record.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>tsd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Uuid</span><span class=p>:</span> <span class=nx>uid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>InstrumentUuid</span><span class=p>:</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>InstrumentUuid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Value</span><span class=p>:</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>UserUuid</span><span class=p>:</span> <span class=nx>userUuid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TsdRepo</span><span class=p>.</span><span class=nf>Save</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Return our record to the user as a response.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>tsd</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// To run this API, try running in your console:
</span></span></span><span class=line><span class=cl><span class=c1>// $ http delete 127.0.0.1:5000/api/v1/time-series-datum/f3e7b442-f3d4-4c2f-8f8d-d347982c1569
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>Controller</span><span class=p>)</span> <span class=nf>deleteTimeSeriesDatum</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>uid</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>userUuid</span> <span class=o>:=</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=s>&#34;user_uuid&#34;</span><span class=p>).(</span><span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Lookup our record and enforce account access.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>tsd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TsdRepo</span><span class=p>.</span><span class=nf>FindByUuid</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>uid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>UserUuid</span> <span class=o>!=</span> <span class=nx>userUuid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Forbidden&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusForbidden</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>TsdRepo</span><span class=p>.</span><span class=nf>DeleteByUuid</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>uid</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>w</span><span class=p>.</span><span class=nf>WriteHeader</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>)</span> <span class=c1>// Note: https://tools.ietf.org/html/rfc7231#section-6.3.1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=serve-package>serve package<a hidden class=anchor aria-hidden=true href=#serve-package>#</a></h2><h3 id=maingo>main.go<a hidden class=anchor aria-hidden=true href=#maingo>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/bartmika/mulberry-server/cmd/serve/main.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;syscall&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>sqldb</span> <span class=s>&#34;github.com/bartmika/mulberry-server/pkg/db&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/mulberry-server/internal/repositories&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/mulberry-server/internal/controllers&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Get our environment variables which will used to configure our application.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>databaseHost</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;MULBERRY_DB_HOST&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>databasePort</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;MULBERRY_DB_PORT&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>databaseUser</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;MULBERRY_DB_USER&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>databasePassword</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;MULBERRY_DB_PASSWORD&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>databaseName</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Getenv</span><span class=p>(</span><span class=s>&#34;MULBERRY_DB_NAME&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>db</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sqldb</span><span class=p>.</span><span class=nf>ConnectDB</span><span class=p>(</span><span class=nx>databaseHost</span><span class=p>,</span> <span class=nx>databasePort</span><span class=p>,</span> <span class=nx>databaseUser</span><span class=p>,</span> <span class=nx>databasePassword</span><span class=p>,</span> <span class=nx>databaseName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>db</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>userRepo</span> <span class=o>:=</span> <span class=nx>repositories</span><span class=p>.</span><span class=nf>NewUserRepo</span><span class=p>(</span><span class=nx>db</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>tsdRepo</span> <span class=o>:=</span> <span class=nx>repositories</span><span class=p>.</span><span class=nf>NewTimeSeriesDatumRepo</span><span class=p>(</span><span class=nx>db</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>controllers</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>userRepo</span><span class=p>,</span> <span class=nx>tsdRepo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>mux</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>NewServeMux</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>mux</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>controllers</span><span class=p>.</span><span class=nf>ChainMiddleware</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>HandleRequests</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>srv</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Addr</span><span class=p>:</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s:%s&#34;</span><span class=p>,</span> <span class=s>&#34;localhost&#34;</span><span class=p>,</span> <span class=s>&#34;5000&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>Handler</span><span class=p>:</span> <span class=nx>mux</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>done</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>done</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Interrupt</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=nf>runMainRuntimeLoop</span><span class=p>(</span><span class=nx>srv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;Server Started&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Run the main loop blocking code.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=o>&lt;-</span><span class=nx>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>stopMainRuntimeLoop</span><span class=p>(</span><span class=nx>srv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>runMainRuntimeLoop</span><span class=p>(</span><span class=nx>srv</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;listen: %s\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>stopMainRuntimeLoop</span><span class=p>(</span><span class=nx>srv</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Starting graceful shutdown now...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Execute the graceful shutdown sub-routine which will terminate any
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// active connections and reject any new connections.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// extra handling here
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>ctx</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Server Shutdown Failed:%+v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Graceful shutdown finished.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;Server Exited&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h1 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h1><h2 id=starting-the-server>Starting the Server<a hidden class=anchor aria-hidden=true href=#starting-the-server>#</a></h2><p>We are going to use <em>environment variables</em> to load configuration settings for our application.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MULBERRY_DB_HOST</span><span class=o>=</span>localhost
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MULBERRY_DB_PORT</span><span class=o>=</span><span class=m>5432</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MULBERRY_DB_USER</span><span class=o>=</span>golang
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MULBERRY_DB_PASSWORD</span><span class=o>=</span>123password
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MULBERRY_DB_NAME</span><span class=o>=</span>mulberry_db
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MULBERRY_APP_SIGNING_KEY</span><span class=o>=</span>PLEASE_REPLACE_ME</span></span></code></pre></div><p>And now you can run the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go run cmd/serve/main.go</span></span></code></pre></div><p>In another terminal run the following code to make a login call:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>bmika@MACMINI-AFA2131 mulberry-server % http post 127.0.0.1:5000/api/v1/login <span class=nv>email</span><span class=o>=</span><span class=s2>&#34;fherbert@dune.com&#34;</span> <span class=nv>password</span><span class=o>=</span><span class=s2>&#34;the-spice-must-flow&#34;</span></span></span></code></pre></div><p>The return should look as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>Content-Length: <span class=m>385</span>
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Date: Mon, <span class=m>01</span> Feb <span class=m>2021</span> 04:27:46 GMT
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;access_token&#34;</span>: <span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTIxNTcyNjYsInVzZXJfdXVpZCI6IjlkZDJjYzBhLTkzNGQtNDc4OC04MzA0LTFlMGI4MmQ5YjZlNiJ9.ZKe5DargCrHZcAQQ71M46uUr0TWk9UYkiURijaKBABA&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;refresh_token&#34;</span>: <span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI0MTI4NjYsInVzZXJfdXVpZCI6IjlkZDJjYzBhLTkzNGQtNDc4OC04MzA0LTFlMGI4MmQ5YjZlNiJ9.odXNQd1hm3cLPI9_e2jfjYXjgjf7wfxQ8hCx3-qqZYY&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Please save the output the &ldquo;access_token&rdquo; so you can write in your console.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MULBERRY_API_TOKEN</span><span class=o>=</span><span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTIxNTcyNjYsInVzZXJfdXVpZCI6IjlkZDJjYzBhLTkzNGQtNDc4OC04MzA0LTFlMGI4MmQ5YjZlNiJ9.ZKe5DargCrHZcAQQ71M46uUr0TWk9UYkiURijaKBABA&#34;</span></span></span></code></pre></div><p>Next run the following call to a protected API:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>http get 127.0.0.1:5000/api/v1/time-series-data Authorization:<span class=s2>&#34;Bearer </span><span class=nv>$MULBERRY_API_TOKEN</span><span class=s2>&#34;</span></span></span></code></pre></div><p>And your result should look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>Content-Length: <span class=m>175</span>
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Date: Sun, <span class=m>31</span> Jan <span class=m>2021</span> 22:57:40 GMT
</span></span><span class=line><span class=cl><span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;instrument_uuid&#34;</span>: <span class=s2>&#34;lalala&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;timestamp&#34;</span>: <span class=s2>&#34;2021-01-30T10:20:10Z&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;user_uuid&#34;</span>: <span class=s2>&#34;9dd2cc0a-934d-4788-8304-1e0b82d9b6e6&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;uuid&#34;</span>: <span class=s2>&#34;923148e4-5dd9-4ec7-bf04-4a50f880c7db&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span>: <span class=m>123</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>]</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://bartlomiejmika.com/tags/golang/>Golang</a></li><li><a href=https://bartlomiejmika.com/tags/api/>API</a></li><li><a href=https://bartlomiejmika.com/tags/security/>Security</a></li><li><a href=https://bartlomiejmika.com/tags/howto/>HOWTO</a></li></ul><nav class=paginav><a class=prev href=https://bartlomiejmika.com/posts/2021/winter-sown-seeds-growlog-1/><span class=title>« Prev</span><br><span>Winter Sown Seeds Growlog #1</span></a>
<a class=next href=https://bartlomiejmika.com/posts/2021/how-to-build-an-api-server-in-go-part-3-postgres-database/><span class=title>Next »</span><br><span>How to Build an API Server in Go - Part 3: Postgres Database</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share How to Build an API Server in Go - Part 4: Access Control on twitter" href="https://twitter.com/intent/tweet/?text=How%20to%20Build%20an%20API%20Server%20in%20Go%20-%20Part%204%3a%20Access%20Control&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-an-api-server-in-go-part-4-access-control%2f&hashtags=Golang%2cAPI%2cSecurity%2cHOWTO"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build an API Server in Go - Part 4: Access Control on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-an-api-server-in-go-part-4-access-control%2f&title=How%20to%20Build%20an%20API%20Server%20in%20Go%20-%20Part%204%3a%20Access%20Control&summary=How%20to%20Build%20an%20API%20Server%20in%20Go%20-%20Part%204%3a%20Access%20Control&source=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-an-api-server-in-go-part-4-access-control%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build an API Server in Go - Part 4: Access Control on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-an-api-server-in-go-part-4-access-control%2f&title=How%20to%20Build%20an%20API%20Server%20in%20Go%20-%20Part%204%3a%20Access%20Control"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build an API Server in Go - Part 4: Access Control on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-an-api-server-in-go-part-4-access-control%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build an API Server in Go - Part 4: Access Control on whatsapp" href="https://api.whatsapp.com/send?text=How%20to%20Build%20an%20API%20Server%20in%20Go%20-%20Part%204%3a%20Access%20Control%20-%20https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-an-api-server-in-go-part-4-access-control%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build an API Server in Go - Part 4: Access Control on telegram" href="https://telegram.me/share/url?text=How%20to%20Build%20an%20API%20Server%20in%20Go%20-%20Part%204%3a%20Access%20Control&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-an-api-server-in-go-part-4-access-control%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://bartlomiejmika.com/>Bartlomiej Mika</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>