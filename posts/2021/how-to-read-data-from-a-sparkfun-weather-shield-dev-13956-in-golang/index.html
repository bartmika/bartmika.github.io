<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang | Bartlomiej Mika</title><meta name=keywords content="IoT,Golang"><meta name=description content="SparkFun Weather Shield monitoring dutifully a red mulberry seedling, the code is powered by what you will learn in this blog post.
The purpose of blog post is to explain how to write a Golang application which can poll time-series data from a SparkFun Weather Shield (DEV-13956)."><meta name=author content="Bartlomiej Mika"><link rel=canonical href=https://bartlomiejmika.com/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/><meta name=google-site-verification content="UA-172742383-1"><link crossorigin=anonymous href=/assets/css/stylesheet.8b523f1730c922e314350296d83fd666efa16519ca136320a93df674d00b6325.css integrity="sha256-i1I/FzDJIuMUNQKW2D/WZu+hZRnKE2MgqT32dNALYyU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://bartlomiejmika.com/img/favicon.ico><link rel=apple-touch-icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=mask-icon href=https://bartlomiejmika.com/img/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-172742383-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang"><meta property="og:description" content="SparkFun Weather Shield monitoring dutifully a red mulberry seedling, the code is powered by what you will learn in this blog post.
The purpose of blog post is to explain how to write a Golang application which can poll time-series data from a SparkFun Weather Shield (DEV-13956)."><meta property="og:type" content="article"><meta property="og:url" content="https://bartlomiejmika.com/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/"><meta property="og:image" content="https://bartlomiejmika.com/img/2021/07-09/red_mulberries_germination_with_sparkfun_weather_shield.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-09T13:27:03-04:00"><meta property="article:modified_time" content="2021-07-09T13:27:03-04:00"><meta property="og:site_name" content="Bartlomiej Mika"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bartlomiejmika.com/img/2021/07-09/red_mulberries_germination_with_sparkfun_weather_shield.jpg"><meta name=twitter:title content="How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang"><meta name=twitter:description content="SparkFun Weather Shield monitoring dutifully a red mulberry seedling, the code is powered by what you will learn in this blog post.
The purpose of blog post is to explain how to write a Golang application which can poll time-series data from a SparkFun Weather Shield (DEV-13956)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bartlomiejmika.com/posts/"},{"@type":"ListItem","position":2,"name":"How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang","item":"https://bartlomiejmika.com/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang","name":"How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang","description":"SparkFun Weather Shield monitoring dutifully a red mulberry seedling, the code is powered by what you will learn in this blog post.\nThe purpose of blog post is to explain how to write a Golang application which can poll time-series data from a SparkFun Weather Shield (DEV-13956).\n","keywords":["IoT","Golang"],"articleBody":"SparkFun Weather Shield monitoring dutifully a red mulberry seedling, the code is powered by what you will learn in this blog post.\nThe purpose of blog post is to explain how to write a Golang application which can poll time-series data from a SparkFun Weather Shield (DEV-13956).\nBefore you begin, I am assuming the following:\nYou are running either Linux or a Mac You have purchased 1x - SparkFun Weather Shield (DEV-13956) device. You have purchased 1x - Arduino Uno device. You have successfully assembled the Shield with the Arduino device and connected it through USB to your computer. You are running go1.16.3 or greater. Setup the Arduino Device First step after having assembled the shield is you will need to download the Arduino IDE to your computer, please do so now. Afterwards open the IDE. You should see something as follows:\nThen highlight all the code in the terminal and delete it. Afterwards copy and paste the following code:\n/* SparkFun Weather Shield (DEV-13956) Writer By: Bartlomiej Mika Date: July 9th, 2021 License: BSD 3-Clause License The source code which powers the Arduino device that collects time-series data that will be outputed to the USB serial device. The following data will be recorded: (1) Humidity/Temperature Sensor --- Si7021 (2) Barometric Pressure --- MPL3115A2 (3) Light Sensor --- ALS-PT19 This code based on utilizing the following Arduino shields / external sensor(s): - SparkFun Weather Shield (DEV-13956) */ #include #include //I2C needed for sensors #include \"SparkFunMPL3115A2.h\" //Pressure sensor - Search \"SparkFun MPL3115\" and install from Library Manager #include \"SparkFun_Si7021_Breakout_Library.h\" //Humidity sensor - Search \"SparkFun Si7021\" and install from Library Manager // Create instance of our sensors. MPL3115A2 myPressure; Weather myHumidity; // Hardware pin definitions const byte REFERENCE_3V3 = A3; const byte LIGHT = A1; // Set variables used by our application int id_incr_count = 1; // Variable used to keep track of the output count. char rx_byte = 0; /** * The main entry point into our application. */ void setup() { // Initialize Serial port Serial.begin(9600); while (!Serial) continue; // SETUP OUR INSTRUMENTS //------------------------------------ // --- Weather Shield --- pinMode(REFERENCE_3V3, INPUT); pinMode(LIGHT, INPUT); //Configure the pressure sensor myPressure.begin(); // Get sensor online myPressure.setModeBarometer(); // Measure pressure in Pascals from 20 to 110 kPa myPressure.setOversampleRate(7); // Set Oversample to the recommended 128 myPressure.enableEventFlags(); // Enable all three pressure and temp event flags //Configure the humidity sensor myHumidity.begin(); // FINISH SETTING UP // We must print this JSON string to let our service computer know this // code is ready to be polled. // Create our JSON object. StaticJsonDocument\u003c200\u003e doc; // Add system values in the document doc[\"status\"] = \"READY\"; doc[\"runtime\"] = millis(); doc[\"id\"] = id_incr_count++; // Add an array. JsonArray data = doc.createNestedArray(\"sensors\"); data.add(\"humidity\"); // relative humidity data.add(\"temperature\"); data.add(\"pressure\"); // barometric pressure data.add(\"illuminance\"); // Generate the minified JSON and send it to the Serial port. serializeJson(doc, Serial); // Start a new line Serial.println(); } /** * The main runtime loop of our application. */ void loop() { if (Serial.available() \u003e 0) { // is a character available? rx_byte = Serial.read(); // get the character // check if a number was received if ((rx_byte \u003e= '0') \u0026\u0026 (rx_byte \u003c= '9')) { poll_all_instruments(); } } } void poll_all_instruments() { //Check Humidity Sensor float humidity = myHumidity.getRH(); if (humidity == 998) //Humidty sensor failed to respond { Serial.println(\"I2C communication to sensors is not working. Check solder connections.\"); //Try re-initializing the I2C comm and the sensors myPressure.begin(); myPressure.setModeBarometer(); myPressure.setOversampleRate(7); myPressure.enableEventFlags(); myHumidity.begin(); } else { // Create our JSON object. StaticJsonDocument\u003c511\u003e doc; // Add system values in the document doc[\"status\"] = \"RUNNING\"; doc[\"runtime\"] = millis(); doc[\"id\"] = id_incr_count++; // HUMIDITY doc[\"humidity_value\"] = humidity; doc[\"humidity_unit\"] = \"%\"; // TEMPERATURE (FROM HUMIDITY INSTRUMENT) float temp_h = myHumidity.getTempF(); doc[\"temperature_primary_value\"] = temp_h; doc[\"temperature_primary_unit\"] = \"F\"; // PRESSURE float pressure = myPressure.readPressure(); doc[\"pressure_value\"] = pressure; doc[\"pressure_unit\"] = \"Pa\"; // TEMPERATURE (FROM PRESSURE INSTRUMENT) float temp_p = myPressure.readTempF(); doc[\"temperature_secondary_value\"] = temp_p; doc[\"temperature_secondary_unit\"] = \"F\"; // ALTITUDE float altitude = myPressure.readAltitudeFt(); doc[\"altitude_value\"] = altitude; doc[\"altitude_unit\"] = \"ft\"; // ILLUMINANCE float light_lvl = get_light_level(); doc[\"illuminance_value\"] = light_lvl; doc[\"illuminance_unit\"] = \"V\"; // Generate the minified JSON and send it to the Serial port. serializeJson(doc, Serial); // Start a new line Serial.println(); } } //Returns the voltage of the light sensor based on the 3.3V rail //This allows us to ignore what VCC might be (an Arduino plugged into USB has VCC of 4.5 to 5.2V) // https://learn.sparkfun.com/tutorials/arduino-weather-shield-hookup-guide-v12 float get_light_level() { float operatingVoltage = analogRead(REFERENCE_3V3); float lightSensor = analogRead(LIGHT); operatingVoltage = 3.3 / operatingVoltage; //The reference voltage is 3.3V lightSensor = operatingVoltage * lightSensor; return (lightSensor); } Please install the following libraries using the Arduino Library Manager:\nArduinoJson SparkFun MPL3115 SparkFun Si7021 Click save and save the file somewhere, afterwords click the Verify button and you should see a success message as follows:\nIf you have received the above message, please continue by clicking the Upload button. The IDE will compile and then upload to the device. Once uploaded the Arduino device is running with the code we‚Äôve written! Let‚Äôs test out our code, please click the Serial Monitor icon now:\nOnce you click it you should see the Serial Monitor as follows:\nIn the textfield, type in letter one (ex: 1) and hit Send. If everything works, you should see something like this:\nHurray! You have successfully connected and polled your first data from the SparkFun Weather Shield (DEV-13956) device. We‚Äôre not finished yet, close the Serial Monitor, go to the menu and click port. When you open the menu please write down the URL path of the Arduino Uno device.\nFor example, on my screen the value is /dev/cu.usbmodem14401.\nPlease save your value as you will need it next!\nSetup the Golang Code Start off by setting up the an empty repository in github.\nStart the project by calling it serialreader-cli. Here is how I setup the code:\ncd ~/go/src/github.com/bartmika git clone https://github.com/bartmika/serialreader-cli.git cd serialreader-cli Initialize golang modules.\ngo mod init github.com/bartmika/serialreader-cli Install our project‚Äôs dependencies.\ngo get github.com/spf13/cobra go get github.com/tarm/serial Setup the project structure - this means you will need to create the folders and empty files you see in the Project Hierarchy below:\nProject Hierarchy üìÅ serialreader-cli ‚îÇ üìÑ main.go ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ cmd | | | ‚îî‚îÄ‚îÄ‚îÄüìÑ read_once.go | üìÑ root.go | üìÑ version.go | ‚îî‚îÄ‚îÄ‚îÄüìÅ internal | ‚îî‚îÄ‚îÄ‚îÄüìÅ utils | ‚îî‚îÄ‚îÄ‚îÄüìÑ sparkfun_weather_shield_reader.go What are going to do? We want our project structured in such a way that it uses the spf13/cobra package so we can easily commands in our application.\nTo begin, please copy and paste the following code into those empty files.\n(1 of 5) main.go package main // github.com/bartmika/serialreader-cli/main.go import ( \"github.com/bartmika/serialreader-cli/cmd\" ) func main() { cmd.Execute() } (2 of 5) cmd/root.go package cmd // github.com/bartmika/serialreader-cli/cmd/root.go import ( \"fmt\" \"os\" \"github.com/spf13/cobra\" ) var rootCmd = \u0026cobra.Command{ Use: \"serialreader-cli\", Short: \"Read time-series data\", Long: `Read time-series data from a connected Arduino device with an attached 'SparkFun Weather Shield' device.`, Run: func(cmd *cobra.Command, args []string) { // Do nothing... }, } func Execute() { if err := rootCmd.Execute(); err != nil { fmt.Fprintln(os.Stderr, err) os.Exit(1) } } (3 of 5) cmd/version.go package cmd // github.com/bartmika/serialreader-cli/cmd/version.go import ( \"fmt\" \"github.com/spf13/cobra\" ) func init() { rootCmd.AddCommand(versionCmd) } var versionCmd = \u0026cobra.Command{ Use: \"version\", Short: \"Print the version number\", Long: `Print the current version that this cli is on.`, Run: func(cmd *cobra.Command, args []string) { fmt.Println(\"serialreader-cli v1.0\") }, } (4 of 5) internal/utils/sparkfun_weather_shield_reader.go package utils // github.com/bartmika/serialreader-cli/internal/utils/sparkfun_weather_shield_reader.go import ( \"fmt\" \"encoding/json\" \"log\" \"time\" \"github.com/tarm/serial\" ) const RX_BYTE = \"1\" // The time-series data structure used to store all the data that will be // returned by the `SparkFun Weather Shield` Arduino device. type TimeSeriesData struct { Status string `json:\"status,omitempty\"` Runtime int `json:\"runtime,omitempty\"` Id int `json:\"id,omitempty\"` HumidityValue float32 `json:\"humidity_value,omitempty\"` HumidityUnit string `json:\"humidity_unit,omitempty\"` TemperatureValue float32 `json:\"temperature_primary_value,omitempty\"` TemperatureUnit string `json:\"temperature_primary_unit,omitempty\"` PressureValue float32 `json:\"pressure_value,omitempty\"` PressureUnit string `json:\"pressure_unit,omitempty\"` TemperatureBackupValue float32 `json:\"temperature_secondary_value,omitempty\"` TemperatureBackupUnit string `json:\"temperature_secondary_unit,omitempty\"` AltitudeValue float32 `json:\"altitude_value,omitempty\"` AltitudeUnit string `json:\"altitude_unit,omitempty\"` IlluminanceValue float32 `json:\"illuminance_value,omitempty\"` IlluminanceUnit string `json:\"illuminance_unit,omitempty\"` // WeatherShieldMoistureValue float32 `json:\"weathershield_moisture_value,omitempty\"` // WeatherShieldMoistureUnit string `json:\"weathershield_moisture_unit,omitempty\"` Timestamp int64 `json:\"timestamp,omitempty\"` } // The abstraction of the `SparkFun Weather Shield` reader. type ArduinoReader struct { serialPort *serial.Port } // Constructor used to intialize the serial reader designed to communicate // with Arduino configured for the `SparkFun Weather Shield` settings. func NewSparkFunWeatherShieldReader(devicePath string) *ArduinoReader { log.Printf(\"READER: Attempting to connect Arduino device...\") c := \u0026serial.Config{Name: devicePath, Baud: 9600} s, err := serial.OpenPort(c) if err != nil { log.Fatal(err) } // DEVELOPERS NOTE: // The following code will warm up the Arduino device before we are // able to make calls to the external sensors. log.Printf(\"READER: Waiting for Arduino external sensors to warm up\") ar := \u0026ArduinoReader{serialPort: s} ar.Read() time.Sleep(5 * time.Second) ar.Read() time.Sleep(5 * time.Second) return ar } // Function returns the JSON data of the instrument readings from our Arduino // device configured for the `SparkFun Weather Shield` settings. func (ar *ArduinoReader) Read() *TimeSeriesData { // DEVELOPERS NOTE: // (1) The external device (Arduino) is setup to standby idle until it // receives a poll request from this code, once a poll request has // been submitted then all the sensors get polled and their data is // returned. // (2) Please look at the following code to understand how the external // device works in: // // (3) The reason for design is as follows: // (a) The external device does not have a real-time clock // (b) We don't want to add any real-time clock shields because // extra hardware means it costs more. // (c) We don't want to write complicated code of synching time // from this code because it will make the code complicated. // (d) Therefore we chose to make sensor polling be event based // and this code needs to send a \"poll request\". // STEP 1: // We need to send a single byte to the external device (Arduino) which // will trigger a polling event on all the sensors. n, err := ar.serialPort.Write([]byte(RX_BYTE)) if err != nil { log.Fatal(err) } // STEP 2: // The external device will poll the device, we need to make our main // runtime loop to be blocked so we wait until the device finishes and // returns all the sensor measurements. buf := make([]byte, 1028) n, err = ar.serialPort.Read(buf) if err != nil { log.Fatal(err) } // STEP 3: // Check to see if ANY data was returned from the external device, if // there was then we load up the string into a JSON object. var tsd TimeSeriesData err = json.Unmarshal(buf[:n], \u0026tsd) if err != nil { return nil } tsd.Timestamp = time.Now().Unix() return \u0026tsd } // Function used to print to the console the time series data. func PrettyPrintTimeSeriesData(tsd *TimeSeriesData) { fmt.Println(\"Status: \", tsd.Status) fmt.Println(\"Runtime: \", tsd.Runtime) fmt.Println(\"Status: \", tsd.Id) fmt.Println(\"HumidityValue: \", tsd.HumidityValue) fmt.Println(\"HumidityUnit: \", tsd.HumidityUnit) fmt.Println(\"TemperatureValue: \", tsd.TemperatureValue) fmt.Println(\"TemperatureUnit: \", tsd.TemperatureUnit) fmt.Println(\"PressureValue: \", tsd.PressureValue) fmt.Println(\"PressureUnit: \", tsd.PressureUnit) fmt.Println(\"TemperatureBackupValue: \", tsd.TemperatureBackupValue) fmt.Println(\"TemperatureBackupUnit: \", tsd.TemperatureBackupUnit) fmt.Println(\"AltitudeValue: \", tsd.AltitudeValue) fmt.Println(\"AltitudeUnit: \", tsd.AltitudeUnit) fmt.Println(\"IlluminanceValue: \", tsd.IlluminanceValue) fmt.Println(\"IlluminanceUnit: \", tsd.IlluminanceUnit) fmt.Println(\"Timestamp: \", tsd.Timestamp) } (5 of 5) cmd/read_once.go package cmd // github.com/bartmika/serialreader-cli/cmd/read_once.go import ( \"log\" // \"os\" // \"os/signal\" // \"syscall\" \"time\" \"github.com/spf13/cobra\" \"github.com/bartmika/serialreader-cli/internal/utils\" ) var ( arduinoDevicePath string ) func init() { // The following are required. readOnceCmd.Flags().StringVarP(\u0026arduinoDevicePath, \"arduino_path\", \"f\", \"/dev/cu.usbmodem14201\", \"The location of the connected arduino device on your computer.\") readOnceCmd.MarkFlagRequired(\"arduino_path\") rootCmd.AddCommand(readOnceCmd) } var readOnceCmd = \u0026cobra.Command{ Use: \"read_once\", Short: \"-\", Long: `-`, Run: func(cmd *cobra.Command, args []string) { doReadOnce() }, } func doReadOnce() { // Establish our device connection. reader := utils.NewSparkFunWeatherShieldReader(arduinoDevicePath) log.Println(\"READER: Wait a few seconds...\") time.Sleep(5000 * time.Millisecond) log.Println(\"READER: Polling device...\") tsd := reader.Read() log.Println(\"READER: Result:\") utils.PrettyPrintTimeSeriesData(tsd) } Let‚Äôs run the code! In your terminal please write the following and replace the /dev/cu.usbmodem14401 value with the value you‚Äôve saved previously. Hit *Enter and if everything works you should see something like this:\nIf you are having difficulty reading the above, the output text is as follows:\n2021/07/09 15:10:40 READER: Attempting to connect Arduino device... 2021/07/09 15:10:40 READER: Waiting for Arduino external sensors to warm up 2021/07/09 15:10:50 READER: Wait a few seconds... 2021/07/09 15:10:55 READER: Polling device... 2021/07/09 15:10:55 READER: Result: Status: RUNNING Runtime: 3581 Status: 2 HumidityValue: 60.52069 HumidityUnit: % TemperatureValue: 74.00308 TemperatureUnit: F PressureValue: 98247 PressureUnit: Pa TemperatureBackupValue: 71.825 TemperatureBackupUnit: F AltitudeValue: 80585.22 AltitudeUnit: ft IlluminanceValue: 0.054341 IlluminanceUnit: V Timestamp: 1625857855 Where do we go from here? You know how to read from the device, but how do you share the functionality between many applications? In the next post we will attach a gRPC service definition overtop of our code.\n","wordCount":"2081","inLanguage":"en","image":"https://bartlomiejmika.com/img/2021/07-09/red_mulberries_germination_with_sparkfun_weather_shield.jpg","datePublished":"2021-07-09T13:27:03-04:00","dateModified":"2021-07-09T13:27:03-04:00","author":{"@type":"Person","name":"Bartlomiej Mika"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bartlomiejmika.com/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/"},"publisher":{"@type":"Organization","name":"Bartlomiej Mika","logo":{"@type":"ImageObject","url":"https://bartlomiejmika.com/img/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bartlomiejmika.com/ accesskey=h title="Bartlomiej Mika (Alt + H)"><img src=https://bartlomiejmika.com/img/bartlomiej_mika.jpeg alt=logo aria-label=logo height=35>Bartlomiej Mika</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bartlomiejmika.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://bartlomiejmika.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://bartlomiejmika.com/pages/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bartlomiejmika.com/>Home</a>&nbsp;¬ª&nbsp;<a href=https://bartlomiejmika.com/posts/>Posts</a></div><h1 class=post-title>How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang</h1><div class=post-meta><span title='2021-07-09 13:27:03 -0400 -0400'>July 9, 2021</span>&nbsp;¬∑&nbsp;10 min&nbsp;¬∑&nbsp;2081 words&nbsp;¬∑&nbsp;Bartlomiej Mika&nbsp;|&nbsp;<a href=https://github.com/bartmika/bartlomiejmika-hugo/tree/master/content/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://bartlomiejmika.com/img/2021/07-09/red_mulberries_germination_with_sparkfun_weather_shield.jpg alt></figure><div class=post-content><p>SparkFun Weather Shield monitoring dutifully a red mulberry seedling, the code is powered by what you will learn in this blog post.</p><p>The purpose of blog post is to explain how to write a Golang application which can poll time-series data from a <a href=https://www.sparkfun.com/products/13956>SparkFun Weather Shield (DEV-13956)</a>.</p><p>Before you begin, I am assuming the following:</p><ul><li>You are running either Linux or a Mac</li><li>You have purchased 1x - <a href=https://www.sparkfun.com/products/13956>SparkFun Weather Shield (DEV-13956)</a> device.</li><li>You have purchased 1x - <a href=https://store.arduino.cc/usa/arduino-uno-rev3>Arduino Uno</a> device.</li><li>You have successfully assembled the Shield with the Arduino device and connected it through USB to your computer.</li><li>You are running <code>go1.16.3</code> or greater.</li></ul><h2 id=setup-the-arduino-device>Setup the Arduino Device<a hidden class=anchor aria-hidden=true href=#setup-the-arduino-device>#</a></h2><p>First step after having assembled the shield is you will need to <strong>download</strong> the <a href=https://www.arduino.cc/en/software>Arduino IDE</a> to your <strong>computer</strong>, please do so now. Afterwards open the <strong>IDE</strong>. You should see something as follows:</p><p><img loading=lazy src=/img/2021/07-09/1.png alt></p><p>Then highlight all the code in the <strong>terminal</strong> and delete it. Afterwards copy and paste the following code:</p><pre tabindex=0><code class=language-cplusplus data-lang=cplusplus>/*
 SparkFun Weather Shield (DEV-13956) Writer
 By: Bartlomiej Mika
 Date: July 9th, 2021
 License: BSD 3-Clause License

 The source code which powers the Arduino device that collects time-series data
 that will be outputed to the USB serial device.

 The following data will be recorded:
 (1) Humidity/Temperature Sensor --- Si7021
 (2) Barometric Pressure --- MPL3115A2
 (3) Light Sensor --- ALS-PT19

 This code based on utilizing the following Arduino shields / external sensor(s):
 - SparkFun Weather Shield (DEV-13956)
*/

#include &lt;ArduinoJson.h&gt;
#include &lt;Wire.h&gt; //I2C needed for sensors
#include &#34;SparkFunMPL3115A2.h&#34; //Pressure sensor - Search &#34;SparkFun MPL3115&#34; and install from Library Manager
#include &#34;SparkFun_Si7021_Breakout_Library.h&#34; //Humidity sensor - Search &#34;SparkFun Si7021&#34; and install from Library Manager

// Create instance of our sensors.
MPL3115A2 myPressure;
Weather myHumidity;

// Hardware pin definitions
const byte REFERENCE_3V3 = A3;
const byte LIGHT = A1;

// Set variables used by our application
int id_incr_count = 1; // Variable used to keep track of the output count.
char rx_byte = 0;

/**
 * The main entry point into our application.
 */
void setup() {
  // Initialize Serial port
  Serial.begin(9600);
  while (!Serial) continue;

  // SETUP OUR INSTRUMENTS
  //------------------------------------
  // --- Weather Shield ---
  pinMode(REFERENCE_3V3, INPUT);
  pinMode(LIGHT, INPUT);

  //Configure the pressure sensor
  myPressure.begin(); // Get sensor online
  myPressure.setModeBarometer(); // Measure pressure in Pascals from 20 to 110 kPa
  myPressure.setOversampleRate(7); // Set Oversample to the recommended 128
  myPressure.enableEventFlags(); // Enable all three pressure and temp event flags

  //Configure the humidity sensor
  myHumidity.begin();

  // FINISH SETTING UP
  // We must print this JSON string to let our service computer know this
  // code is ready to be polled.
  // Create our JSON object.
  StaticJsonDocument&lt;200&gt; doc;

  // Add system values in the document
  doc[&#34;status&#34;] = &#34;READY&#34;;
  doc[&#34;runtime&#34;] = millis();
  doc[&#34;id&#34;] = id_incr_count++;

  // Add an array.
  JsonArray data = doc.createNestedArray(&#34;sensors&#34;);
  data.add(&#34;humidity&#34;); // relative humidity
  data.add(&#34;temperature&#34;);
  data.add(&#34;pressure&#34;); // barometric pressure
  data.add(&#34;illuminance&#34;);

  // Generate the minified JSON and send it to the Serial port.
  serializeJson(doc, Serial);

  // Start a new line
  Serial.println();
}

/**
 * The main runtime loop of our application.
 */
void loop() {
  if (Serial.available() &gt; 0) {    // is a character available?
    rx_byte = Serial.read();       // get the character

    // check if a number was received
    if ((rx_byte &gt;= &#39;0&#39;) &amp;&amp; (rx_byte &lt;= &#39;9&#39;)) {
      poll_all_instruments();
    }
  }
}


void poll_all_instruments() {
  //Check Humidity Sensor
  float humidity = myHumidity.getRH();

  if (humidity == 998) //Humidty sensor failed to respond
  {
    Serial.println(&#34;I2C communication to sensors is not working. Check solder connections.&#34;);

    //Try re-initializing the I2C comm and the sensors
    myPressure.begin();
    myPressure.setModeBarometer();
    myPressure.setOversampleRate(7);
    myPressure.enableEventFlags();
    myHumidity.begin();
  }
  else
  {
    // Create our JSON object.
    StaticJsonDocument&lt;511&gt; doc;

    // Add system values in the document
    doc[&#34;status&#34;] = &#34;RUNNING&#34;;
    doc[&#34;runtime&#34;] = millis();
    doc[&#34;id&#34;] = id_incr_count++;

    // HUMIDITY
    doc[&#34;humidity_value&#34;] = humidity;
    doc[&#34;humidity_unit&#34;] = &#34;%&#34;;

    // TEMPERATURE (FROM HUMIDITY INSTRUMENT)
    float temp_h = myHumidity.getTempF();
    doc[&#34;temperature_primary_value&#34;] = temp_h;
    doc[&#34;temperature_primary_unit&#34;] = &#34;F&#34;;

    // PRESSURE
    float pressure = myPressure.readPressure();
    doc[&#34;pressure_value&#34;] = pressure;
    doc[&#34;pressure_unit&#34;] = &#34;Pa&#34;;

    // TEMPERATURE (FROM PRESSURE INSTRUMENT)
    float temp_p = myPressure.readTempF();
    doc[&#34;temperature_secondary_value&#34;] = temp_p;
    doc[&#34;temperature_secondary_unit&#34;] = &#34;F&#34;;

    // ALTITUDE
    float altitude = myPressure.readAltitudeFt();
    doc[&#34;altitude_value&#34;] = altitude;
    doc[&#34;altitude_unit&#34;] = &#34;ft&#34;;

    // ILLUMINANCE
    float light_lvl = get_light_level();
    doc[&#34;illuminance_value&#34;] = light_lvl;
    doc[&#34;illuminance_unit&#34;] = &#34;V&#34;;

    // Generate the minified JSON and send it to the Serial port.
    serializeJson(doc, Serial);

    // Start a new line
    Serial.println();
  }
}

//Returns the voltage of the light sensor based on the 3.3V rail
//This allows us to ignore what VCC might be (an Arduino plugged into USB has VCC of 4.5 to 5.2V)
// https://learn.sparkfun.com/tutorials/arduino-weather-shield-hookup-guide-v12
float get_light_level()
{
  float operatingVoltage = analogRead(REFERENCE_3V3);

  float lightSensor = analogRead(LIGHT);

  operatingVoltage = 3.3 / operatingVoltage; //The reference voltage is 3.3V

  lightSensor = operatingVoltage * lightSensor;

  return (lightSensor);
}</code></pre><p>Please install the following libraries using the <strong>Arduino Library Manager</strong>:</p><ul><li><a href=https://arduinojson.org/>ArduinoJson</a></li><li><a href=https://github.com/sparkfun/MPL3115A2_Breakout>SparkFun MPL3115</a></li><li><a href=https://github.com/sparkfun/SparkFun_Si701_Breakout_Arduino_Library>SparkFun Si7021</a></li></ul><p>Click save and save the file somewhere, afterwords click the <strong>Verify</strong> button and you should see a success message as follows:</p><p><img loading=lazy src=/img/2021/07-09/2.png alt></p><p>If you have received the above message, please continue by clicking the <strong>Upload</strong> button. The <strong>IDE</strong> will compile and then upload to the device. Once uploaded the Arduino device is running with the code we&rsquo;ve written! Let&rsquo;s test out our code, please click the <strong>Serial Monitor</strong> icon now:</p><p><img loading=lazy src=/img/2021/07-09/3.png alt></p><p>Once you click it you should see the <strong>Serial Monitor</strong> as follows:</p><p><img loading=lazy src=/img/2021/07-09/4.png alt></p><p>In the <strong>textfield</strong>, type in letter one (ex: <strong>1</strong>) and hit <strong>Send</strong>. If everything works, you should see something like this:</p><p><img loading=lazy src=/img/2021/07-09/5.png alt></p><p>Hurray! You have successfully connected and polled your first data from the <a href=https://www.sparkfun.com/products/13956>SparkFun Weather Shield (DEV-13956)</a> device. We&rsquo;re not finished yet, close the <strong>Serial Monitor</strong>, go to the <strong>menu</strong> and click <strong>port</strong>. When you open the <strong>menu</strong> please write down the URL path of the <a href=https://store.arduino.cc/usa/arduino-uno-rev3>Arduino Uno</a> device.</p><p><img loading=lazy src=/img/2021/07-09/6.png alt></p><p>For example, on my screen the value is <code>/dev/cu.usbmodem14401</code>.</p><p><strong>Please save your value as you will need it next!</strong></p><h2 id=setup-the-golang-code>Setup the Golang Code<a hidden class=anchor aria-hidden=true href=#setup-the-golang-code>#</a></h2><p>Start off by setting up the an empty repository in <a href=https://github.com/bartmika/serialreader-cli>github</a>.</p><p>Start the project by calling it <a href=https://github.com/bartmika/serialreader-cli><code>serialreader-cli</code></a>. Here is how I setup the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/go/src/github.com/bartmika
</span></span><span class=line><span class=cl>git clone https://github.com/bartmika/serialreader-cli.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> serialreader-cli</span></span></code></pre></div><p>Initialize golang modules.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod init github.com/bartmika/serialreader-cli</span></span></code></pre></div><p>Install our project&rsquo;s dependencies.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go get github.com/spf13/cobra
</span></span><span class=line><span class=cl>go get github.com/tarm/serial</span></span></code></pre></div><p>Setup the project structure - this means you will need to create the folders and empty files you see in the <em>Project Hierarchy</em> below:</p><h4 id=project-hierarchy>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>üìÅ serialreader-cli
</span></span><span class=line><span class=cl>‚îÇ   üìÑ main.go
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ cmd
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   ‚îî‚îÄ‚îÄ‚îÄüìÑ read_once.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ root.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ version.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ internal
</span></span><span class=line><span class=cl>    <span class=p>|</span>
</span></span><span class=line><span class=cl>    ‚îî‚îÄ‚îÄ‚îÄüìÅ utils
</span></span><span class=line><span class=cl>        <span class=p>|</span>
</span></span><span class=line><span class=cl>        ‚îî‚îÄ‚îÄ‚îÄüìÑ sparkfun_weather_shield_reader.go</span></span></code></pre></div><p>What are going to do? We want our project structured in such a way that it uses the <a href=https://github.com/spf13/cobra><code>spf13/cobra</code></a> package so we can easily commands in our application.</p><p>To begin, please copy and paste the following code into those empty files.</p><h4 id=1-of-5-maingo>(1 of 5) main.go<a hidden class=anchor aria-hidden=true href=#1-of-5-maingo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> <span class=c1>// github.com/bartmika/serialreader-cli/main.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/bartmika/serialreader-cli/cmd&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=2-of-5-cmdrootgo>(2 of 5) cmd/root.go<a hidden class=anchor aria-hidden=true href=#2-of-5-cmdrootgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-cli/cmd/root.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>rootCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serialreader-cli&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Read time-series data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Read time-series data from a connected Arduino device with an attached &#39;SparkFun Weather Shield&#39; device.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Do nothing...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Execute</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rootCmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintln</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=3-of-5-cmdversiongo>(3 of 5) cmd/version.go<a hidden class=anchor aria-hidden=true href=#3-of-5-cmdversiongo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-cli/cmd/version.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>versionCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>versionCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;version&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Print the version number&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Print the current version that this cli is on.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;serialreader-cli v1.0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=4-of-5-internalutilssparkfun_weather_shield_readergo>(4 of 5) internal/utils/sparkfun_weather_shield_reader.go<a hidden class=anchor aria-hidden=true href=#4-of-5-internalutilssparkfun_weather_shield_readergo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>utils</span> <span class=c1>// github.com/bartmika/serialreader-cli/internal/utils/sparkfun_weather_shield_reader.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/tarm/serial&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>RX_BYTE</span> <span class=p>=</span> <span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The time-series data structure used to store all the data that will be
</span></span></span><span class=line><span class=cl><span class=c1>// returned by the `SparkFun Weather Shield` Arduino device.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>TimeSeriesData</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Status</span>                     <span class=kt>string</span>  <span class=s>`json:&#34;status,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Runtime</span>                    <span class=kt>int</span>     <span class=s>`json:&#34;runtime,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Id</span>                         <span class=kt>int</span>     <span class=s>`json:&#34;id,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>HumidityValue</span>              <span class=kt>float32</span> <span class=s>`json:&#34;humidity_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>HumidityUnit</span>               <span class=kt>string</span>  <span class=s>`json:&#34;humidity_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>TemperatureValue</span>           <span class=kt>float32</span> <span class=s>`json:&#34;temperature_primary_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>TemperatureUnit</span>            <span class=kt>string</span>  <span class=s>`json:&#34;temperature_primary_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>PressureValue</span>              <span class=kt>float32</span> <span class=s>`json:&#34;pressure_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>PressureUnit</span>               <span class=kt>string</span>  <span class=s>`json:&#34;pressure_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>TemperatureBackupValue</span>     <span class=kt>float32</span> <span class=s>`json:&#34;temperature_secondary_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>TemperatureBackupUnit</span>      <span class=kt>string</span>  <span class=s>`json:&#34;temperature_secondary_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>AltitudeValue</span>              <span class=kt>float32</span> <span class=s>`json:&#34;altitude_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>AltitudeUnit</span>               <span class=kt>string</span>  <span class=s>`json:&#34;altitude_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>IlluminanceValue</span>           <span class=kt>float32</span> <span class=s>`json:&#34;illuminance_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>IlluminanceUnit</span>            <span class=kt>string</span>  <span class=s>`json:&#34;illuminance_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=c1>// WeatherShieldMoistureValue float32 `json:&#34;weathershield_moisture_value,omitempty&#34;`
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// WeatherShieldMoistureUnit  string  `json:&#34;weathershield_moisture_unit,omitempty&#34;`
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Timestamp</span>                  <span class=kt>int64</span>   <span class=s>`json:&#34;timestamp,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The abstraction of the `SparkFun Weather Shield` reader.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ArduinoReader</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>serialPort</span> <span class=o>*</span><span class=nx>serial</span><span class=p>.</span><span class=nx>Port</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Constructor used to intialize the serial reader designed to communicate
</span></span></span><span class=line><span class=cl><span class=c1>// with Arduino configured for the `SparkFun Weather Shield` settings.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewSparkFunWeatherShieldReader</span><span class=p>(</span><span class=nx>devicePath</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>ArduinoReader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;READER: Attempting to connect Arduino device...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>serial</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>devicePath</span><span class=p>,</span> <span class=nx>Baud</span><span class=p>:</span> <span class=mi>9600</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>serial</span><span class=p>.</span><span class=nf>OpenPort</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// DEVELOPERS NOTE:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The following code will warm up the Arduino device before we are
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// able to make calls to the external sensors.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;READER: Waiting for Arduino external sensors to warm up&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>ar</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ArduinoReader</span><span class=p>{</span><span class=nx>serialPort</span><span class=p>:</span> <span class=nx>s</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>ar</span><span class=p>.</span><span class=nf>Read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>ar</span><span class=p>.</span><span class=nf>Read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ar</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function returns the JSON data of the instrument readings from our Arduino
</span></span></span><span class=line><span class=cl><span class=c1>// device configured for the `SparkFun Weather Shield` settings.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ar</span> <span class=o>*</span><span class=nx>ArduinoReader</span><span class=p>)</span> <span class=nf>Read</span><span class=p>()</span> <span class=o>*</span><span class=nx>TimeSeriesData</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// DEVELOPERS NOTE:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (1) The external device (Arduino) is setup to standby idle until it
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     receives a poll request from this code, once a poll request has
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     been submitted then all the sensors get polled and their data is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     returned.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (2) Please look at the following code to understand how the external
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     device works in: &lt;TODO ADD&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (3) The reason for design is as follows:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     (a) The external device does not have a real-time clock
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     (b) We don&#39;t want to add any real-time clock shields because
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//         extra hardware means it costs more.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     (c) We don&#39;t want to write complicated code of synching time
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//         from this code because it will make the code complicated.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     (d) Therefore we chose to make sensor polling be event based
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//         and this code needs to send a &#34;poll request&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// STEP 1:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// We need to send a single byte to the external device (Arduino) which
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// will trigger a polling event on all the sensors.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>n</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ar</span><span class=p>.</span><span class=nx>serialPort</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>RX_BYTE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// STEP 2:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The external device will poll the device, we need to make our main
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// runtime loop to be blocked so we wait until the device finishes and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// returns all the sensor measurements.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>buf</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>1028</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>n</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>ar</span><span class=p>.</span><span class=nx>serialPort</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// STEP 3:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Check to see if ANY data was returned from the external device, if
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// there was then we load up the string into a JSON object.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>tsd</span> <span class=nx>TimeSeriesData</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>buf</span><span class=p>[:</span><span class=nx>n</span><span class=p>],</span> <span class=o>&amp;</span><span class=nx>tsd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>tsd</span><span class=p>.</span><span class=nx>Timestamp</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Unix</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>tsd</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function used to print to the console the time series data.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>PrettyPrintTimeSeriesData</span><span class=p>(</span><span class=nx>tsd</span> <span class=o>*</span><span class=nx>TimeSeriesData</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Status: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Runtime: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Runtime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Status: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;HumidityValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>HumidityValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;HumidityUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>HumidityUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;PressureValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>PressureValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;PressureUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>PressureUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureBackupValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureBackupValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureBackupUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureBackupUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;AltitudeValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>AltitudeValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;AltitudeUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>AltitudeUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;IlluminanceValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>IlluminanceValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;IlluminanceUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>IlluminanceUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Timestamp: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=5-of-5-cmdread_oncego>(5 of 5) cmd/read_once.go<a hidden class=anchor aria-hidden=true href=#5-of-5-cmdread_oncego>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-cli/cmd/read_once.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;os&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;os/signal&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;syscall&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/bartmika/serialreader-cli/internal/utils&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>arduinoDevicePath</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are required.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>readOnceCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>arduinoDevicePath</span><span class=p>,</span> <span class=s>&#34;arduino_path&#34;</span><span class=p>,</span> <span class=s>&#34;f&#34;</span><span class=p>,</span> <span class=s>&#34;/dev/cu.usbmodem14201&#34;</span><span class=p>,</span> <span class=s>&#34;The location of the connected arduino device on your computer.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>readOnceCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;arduino_path&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>readOnceCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>readOnceCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;read_once&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;-&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`-`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doReadOnce</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doReadOnce</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Establish our device connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>reader</span> <span class=o>:=</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>NewSparkFunWeatherShieldReader</span><span class=p>(</span><span class=nx>arduinoDevicePath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;READER: Wait a few seconds...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5000</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;READER: Polling device...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>tsd</span> <span class=o>:=</span> <span class=nx>reader</span><span class=p>.</span><span class=nf>Read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;READER: Result:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>utils</span><span class=p>.</span><span class=nf>PrettyPrintTimeSeriesData</span><span class=p>(</span><span class=nx>tsd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h2 id=lets-run-the-code>Let&rsquo;s run the code!<a hidden class=anchor aria-hidden=true href=#lets-run-the-code>#</a></h2><p>In your <strong>terminal</strong> please write the following and replace the <code>/dev/cu.usbmodem14401</code> value with the value you&rsquo;ve saved previously. Hit *<em>Enter</em> and if everything works you should see something like this:</p><p><img loading=lazy src=/img/2021/07-09/7.png alt></p><p>If you are having difficulty reading the above, the <strong>output text</strong> is as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>2021/07/09 15:10:40 READER: Attempting to connect Arduino device...
</span></span><span class=line><span class=cl>2021/07/09 15:10:40 READER: Waiting for Arduino external sensors to warm up
</span></span><span class=line><span class=cl>2021/07/09 15:10:50 READER: Wait a few seconds...
</span></span><span class=line><span class=cl>2021/07/09 15:10:55 READER: Polling device...
</span></span><span class=line><span class=cl>2021/07/09 15:10:55 READER: Result:
</span></span><span class=line><span class=cl>Status:  RUNNING
</span></span><span class=line><span class=cl>Runtime:  3581
</span></span><span class=line><span class=cl>Status:  2
</span></span><span class=line><span class=cl>HumidityValue:  60.52069
</span></span><span class=line><span class=cl>HumidityUnit:  %
</span></span><span class=line><span class=cl>TemperatureValue:  74.00308
</span></span><span class=line><span class=cl>TemperatureUnit:  F
</span></span><span class=line><span class=cl>PressureValue:  98247
</span></span><span class=line><span class=cl>PressureUnit:  Pa
</span></span><span class=line><span class=cl>TemperatureBackupValue:  71.825
</span></span><span class=line><span class=cl>TemperatureBackupUnit:  F
</span></span><span class=line><span class=cl>AltitudeValue:  80585.22
</span></span><span class=line><span class=cl>AltitudeUnit:  ft
</span></span><span class=line><span class=cl>IlluminanceValue:  0.054341
</span></span><span class=line><span class=cl>IlluminanceUnit:  V
</span></span><span class=line><span class=cl>Timestamp:  1625857855
</span></span></code></pre></div><h2 id=where-do-we-go-from-here>Where do we go from here?<a hidden class=anchor aria-hidden=true href=#where-do-we-go-from-here>#</a></h2><p>You know how to read from the device, but how do you share the functionality between many <strong>applications</strong>? In the <a href=/posts/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/>next post</a> we will attach a <a href=https://grpc.io><code>gRPC</code></a> service definition overtop of our code.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bartlomiejmika.com/tags/iot/>IoT</a></li><li><a href=https://bartlomiejmika.com/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/><span class=title>¬´ Prev</span><br><span>How to Build a gRPC Server for a SparkFun Weather Shield</span></a>
<a class=next href=https://bartlomiejmika.com/posts/2021/red-mulberry-growlog-2/><span class=title>Next ¬ª</span><br><span>Red Mulberry Growlog #2</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang on twitter" href="https://twitter.com/intent/tweet/?text=How%20to%20Read%20Data%20From%20a%20SparkFun%20Weather%20Shield%20%28DEV-13956%29%20in%20Golang&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang%2f&hashtags=IoT%2cGolang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang%2f&title=How%20to%20Read%20Data%20From%20a%20SparkFun%20Weather%20Shield%20%28DEV-13956%29%20in%20Golang&summary=How%20to%20Read%20Data%20From%20a%20SparkFun%20Weather%20Shield%20%28DEV-13956%29%20in%20Golang&source=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang%2f&title=How%20to%20Read%20Data%20From%20a%20SparkFun%20Weather%20Shield%20%28DEV-13956%29%20in%20Golang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang on whatsapp" href="https://api.whatsapp.com/send?text=How%20to%20Read%20Data%20From%20a%20SparkFun%20Weather%20Shield%20%28DEV-13956%29%20in%20Golang%20-%20https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang on telegram" href="https://telegram.me/share/url?text=How%20to%20Read%20Data%20From%20a%20SparkFun%20Weather%20Shield%20%28DEV-13956%29%20in%20Golang&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://bartlomiejmika.com/>Bartlomiej Mika</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>