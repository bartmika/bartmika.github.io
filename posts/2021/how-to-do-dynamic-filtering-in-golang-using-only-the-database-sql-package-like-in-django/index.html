<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django | Bartlomiej Mika</title><meta name=keywords content="Golang,SQL"><meta name=description content="Recently I had to do some advanced filtering using the database/sql package found in the Golang standard library. In this article I share how I handled advanced filtering. If you are a beginner in Golang wanting to learn how to improve your understanding of querying the database, this article is for you."><meta name=author content="Bartlomiej Mika"><link rel=canonical href=https://bartlomiejmika.com/posts/2021/how-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django/><meta name=google-site-verification content="UA-172742383-1"><link crossorigin=anonymous href=/assets/css/stylesheet.8b523f1730c922e314350296d83fd666efa16519ca136320a93df674d00b6325.css integrity="sha256-i1I/FzDJIuMUNQKW2D/WZu+hZRnKE2MgqT32dNALYyU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://bartlomiejmika.com/img/favicon.ico><link rel=apple-touch-icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=mask-icon href=https://bartlomiejmika.com/img/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-172742383-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django"><meta property="og:description" content="Recently I had to do some advanced filtering using the database/sql package found in the Golang standard library. In this article I share how I handled advanced filtering. If you are a beginner in Golang wanting to learn how to improve your understanding of querying the database, this article is for you."><meta property="og:type" content="article"><meta property="og:url" content="https://bartlomiejmika.com/posts/2021/how-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django/"><meta property="og:image" content="https://bartlomiejmika.com/img/2021/common/go-banner.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-07T15:15:47-04:00"><meta property="article:modified_time" content="2022-02-28T20:12:32-05:00"><meta property="og:site_name" content="Bartlomiej Mika"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bartlomiejmika.com/img/2021/common/go-banner.png"><meta name=twitter:title content="How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django"><meta name=twitter:description content="Recently I had to do some advanced filtering using the database/sql package found in the Golang standard library. In this article I share how I handled advanced filtering. If you are a beginner in Golang wanting to learn how to improve your understanding of querying the database, this article is for you."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bartlomiejmika.com/posts/"},{"@type":"ListItem","position":2,"name":"How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django","item":"https://bartlomiejmika.com/posts/2021/how-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django","name":"How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django","description":"Recently I had to do some advanced filtering using the database/sql package found in the Golang standard library. In this article I share how I handled advanced filtering. If you are a beginner in Golang wanting to learn how to improve your understanding of querying the database, this article is for you.\n","keywords":["Golang","SQL"],"articleBody":"Recently I had to do some advanced filtering using the database/sql package found in the Golang standard library. In this article I share how I handled advanced filtering. If you are a beginner in Golang wanting to learn how to improve your understanding of querying the database, this article is for you.\nThis article is broken up as follows:\nContext Setting up the problem in Python Setting up the problem in Golang Understand the problem First attempt (Static filtering) Second attempt (Too complicated) The “variadic function” to the rescue The Solution Extra Solutions Let’s begin!\nContext Before using Golang to write web-applications, I’ve was using Django Web Framework which is written in Python. Django provides a object relational-mapping (ORM) system to handle your python code interacting with the database. Through all my years, I still think the Django ORM is the best I have ever seen.\nNow that I switched my programming from Python to Golang, I no longer have access to this phenomenal library. There are other ORM solutions but none that I’ve found to my liking; as a result, I am using only the database/sql package.\nThe transition from Django to Golang has not been easy due to fact of how much Django spoiled me. Django has abstracted away a lot algorithms and computer science theory for me to use in a easy to use plug-in-play code! With the transition I am going through, this situation reminds me of a great article called Is Software Abstraction Killing Civilization? in which it details talks about how programmers lose certain knowledge through time because we keep using abstracted code; as a result, I’d I am writing this article to detail my learning.\nSetting up the problem in Django Let’s assume we have the following data-structure and you populated the table with some dummy data:\nCREATE TABLE things ( tenant_id BIGINT NOT NULL, id BIGSERIAL PRIMARY KEY, manufacturer_id BIGINT NOT NULL, part_id BIGINT NOT NULL, state SMALLINT NOT NULL, name VARCHAR (127) NOT NULL ); If we want to lookup “3D Printer” in the name then we would write:\nfrom django.db.models import Q series = Thing.objects.filter(name=\"3D Printer\") Or if we want to lookup a manufacturer_id which does NOT have a particular part_id, we would write:\nfrom django.db.models import Q series = Thing.objects.filter( Q(manufacturer_id=1) \u0026 ~Q(part_id=444) ) And how about if we lookup all the things with the name of 3D printers with a particular part_id?\nfrom django.db.models import Q series = Thing.objects.filter( Q(name=\"3D Printer\") \u0026 Q(part_id=123456789) ) So the Django ORM is quite good at being flexible enough to handle whatever filtering you can throw at it. How do we build something so flexible in Golang?\nSetting up the problem in Golang I will provide important code snippets to help demonstrate. Please note that this code is following the repository pattern so if you don’t understand then please read up before proceeding further.\nWhen following the repository pattern, I break up my code into the models and repositories packages.\nmodels - Is responsible strictly for the data structure. repositories - Will implement the interface from models. The code is as follows:\nmodels/thing.go // github.com/bartmika/hello-server/internal/models/thing.go package models import ( \"context\" \"time\" null \"gopkg.in/guregu/null.v4\" ) // Structure used to hold filtering request by the user. If using `null` package // then filter is optional, else the value is required! type ThingFilter struct { TenantId uint64 `json:\"tenant_id\"` ManufacturerId null.Int `json:\"manufacturer_id\"` PartId null.Int `json:\"part_id\"` State null.Int `json:\"state\"` LastSeenId uint64 `json:\"last_seen_id\"` Limit uint64 `json:\"limit\"` } // The interface we will be using for our `Thing` model. Please note we will be // using the `repository pattern` so we are adding `Repo` suffix to remind us. type ThingRepo interface { ListByFilter(ctx context.Context, filter *ThingFilter) ([]*Thing, error) CountByFilter(ctx context.Context, filter *ThingFilter) (uint64, error) // ... } // The model we will be using. type Thing struct { TenantId uint64 `db:\"tenant_id\" json:\"tenant_id\"` Id uint64 `db:\"id\" json:\"id\"` ManufacturerId uint64 `db:\"manufacturer_id\" json:\"manufacturer_id\"` PartId uint64 `db:\"part_id\" json:\"part_id\"` State uint `db:\"state\" json:\"state\"` Name string `db:\"state\" json:\"name\"` } repositories/thing.go // github.com/bartmika/hello-server/internal/repositories/thing.go package repositories import ( \"context\" \"database/sql\" \"time\" \"strconv\" // null \"gopkg.in/guregu/null.v4\" \"github.com/bartmika/hello-server/internal/models\" ) type ThingRepoImpl struct { db *sql.DB } func NewThingRepoImpl(db *sql.DB) *ThingRepoImpl { return \u0026ThingRepoImpl{db: db} } func (s *ThingRepoImpl) ListByFilter(ctx context.Context, filter *models.ThingFilter) ([]*models.Thing, error) { // TODO return nil, nil } func (s *ThingRepoImpl) CountByFilter(ctx context.Context, filter *models.ThingFilter) (uint64, error) { // TODO return 0, nil } Example Usage Filter only one column Here is how we lookup a single column:\n// Assume you setup the context // ctx := ... // Assume you connected to the database // db := ... thingRepo := repositories.NewThingRepoImpl(db) // Lookup all the `things` for a particular manufacturer. thingFilter := models.ThingFilter{ ManufacturerId: 1, } things, err := thingRepo.ListByFilter(ctx, thingFilter) log.Println(things, err) Filter more then one column Here is how we lookup three columns:\n// Assume you setup the context // ctx := ... // Assume you connected to the database // db := ... thingRepo := repositories.NewThingRepoImpl(db) // Lookup all the `things` for a particular manufacturer and part thingFilter := models.ThingFilter{ ManufacturerId: 1, PartId: 123, State: 1, } things, err := thingRepo.ListByFilter(ctx, thingFilter) log.Println(things, err) Now that we’ve seen filtering code prototype and usage, let’s discuss implementation of the TODO items in our repository.\nUnderstand the problem If we look at our ThingFilter structure we see that the user has the option of using three optional filters and 3 required:\nTenantId -\u003e Required ManufacturerId -\u003e Optional PartId -\u003e Optional State -\u003e Optional LastSeenId -\u003e Required Limit -\u003e Required Therefore our filtering code should handle these cases.\nFirst attempt (Static filtering) My first attempt at solving the problem was to create the dedicated functions for whatever filtering we will have. Take a look at the repositories/thing.go file:\n// github.com/bartmika/hello-server/internal/repositories/thing.go // ... func (s *ThingRepoImpl) ListAll(ctx context.Context) ([]*models.Thing, error) { // ... } func (s *ThingRepoImpl) ListByStateId(ctx context.Context, stateId uint64) ([]*models.Thing, error) { // ... } func (s *ThingRepoImpl) ListByManufacturerId(ctx context.Context, manufacturerId uint64) ([]*models.Thing, error) { // ... } func (s *ThingRepoImpl) ListByManufacturerIdAndState(ctx context.Context, manufacturerId uint64, stateId uint64) ([]*models.Thing, error) { // ... } func (s *ThingRepoImpl) ListByManufacturerIdAndPartId(ctx context.Context, manufacturerId uint64, partId uint64) ([]*models.Thing, error) { // ... } func (s *ThingRepoImpl) ListByManufacturerIdAndPartIdAndStateId(ctx context.Context, manufacturerId uint64, partId uint64, stateId uint64) ([]*models.Thing, error) { // ... } // Etc, etc // ... As you can see there are a number of problems to take into consideration:\nEvery time you want to add a new column to filter, a lot more functions need to be created. It’s not practical - The more filters you want to do, the more functions you have to write to maintain. What pattern do you notice? This pattern does not work, an alternate solutions needs to exist.\nSecond attempt (Too complicated) My second attempt involved creating a unified function which encapsulates all the filtering capability.\nTake a look at the repositories/thing.go file:\n// github.com/bartmika/hello-server/internal/repositories/thing.go // ... func (s *ThingRepoImpl) queryRowsWithFilter(ctx context.Context, querySelect string, filter *models.ThingFilter) (*sql.Rows, error) { if filter.ManufacturerId.IsZero() { if filter.PartId.IsZero() { if filter.State.IsZero() { log.Println(\"Filtering by: Nothing\") query := querySelect + ` WHERE tenant_id = $1 AND id \u003e $2 ORDER BY id DESC LIMIT $3` return s.db.QueryContext(ctx, query, filter.TenantId, filter.LastSeenId, filter.Limit) } else { log.Println(\"Filtering by: Only State\") query := querySelect + ` WHERE tenant_id = $1 AND id \u003e $2 AND state = $3 ORDER BY id DESC LIMIT $4` return s.db.QueryContext(ctx, query, filter.TenantId, filter.State, filter.LastSeenId, filter.Limit) } } else { if filter.State.IsZero() { // Not writing code ... } else { // Not writing code ... } } } else { if filter.PartId.IsZero() { if filter.PartId.State() { // Not writing code ... } else { // Not writing code ... } } else { if filter.PartId.State() { // Not writing code ... } else { // Not writing code ... } } } } func (s *ThingRepoImpl) ListByFilter(ctx context.Context, filter *models.ThingFilter) ([]*models.Thing, error) { ctx, cancel := context.WithTimeout(ctx, 7*time.Second) defer cancel() querySelect := ` SELECT tenant_id, id, manufacturer_id, part_id, state, name FROM things` rows, err := s.queryRowsWithFilter(ctx, querySelect, filter) if err != nil { return nil, err } var arr []*models.Thing defer rows.Close() for rows.Next() { m := new(models.Thing) err := rows.Scan( \u0026m.TenantId, \u0026m.Id, \u0026m.ManufacturerId, \u0026m.PartId, \u0026m.State, \u0026m.Name, ) if err != nil { return nil, err } arr = append(arr, m) } err = rows.Err() return arr, err } As you can see there are a number of problems to take into consideration:\nEvery time you want to add a new column to filter, the code get’s super complicated quickly with repetition. It’s complicated It’s not practical - The more filters you want to do, the more complex it becomes What pattern do you notice? The parameters we want to filter needs to change every time for the QueryContext function and we need to update the sql statement as well. The SQL statement is a string so we can easily modify the string, but how do we call the QueryContext function multiple times with different parameters?\nThe “variadic function” to the rescue In Golang, we have a variadic function which can be used to load up different parameters into the QueryContext function.\nThe Solution The solution which works is to utilize variadic functions and our code looks as follows.\nrepositories/thing.go // github.com/bartmika/hello-server/internal/repositories/thing.go package repositories import ( \"context\" \"database/sql\" \"time\" \"strconv\" \"github.com/bartmika/hello-server/internal/models\" ) type ThingRepoImpl struct { db *sql.DB } func NewThingRepoImpl(db *sql.DB) *ThingRepoImpl { return \u0026ThingRepoImpl{db: db} } func (s *ThingRepoImpl) queryRowsWithFilter(ctx context.Context, query string, filter *models.ThingFilter) (*sql.Rows, error) { // Array will hold all the unique values we want to add into the query. var filterValues []interface{} // The SQL query statement we will be calling in the database, start // by setting the `tenant_id` placeholder and then append our value to // the array. filterValues = append(filterValues, filter.TenantId) query += `WHERE tenant_id = $` + strconv.Itoa(len(filterValues)) // // The following code will add our OPTIONAL filters // if !filter.ManufacturerId.IsZero() { filterValues = append(filterValues, filter.ManufacturerId) query += `AND manufacturer_id = $` + strconv.Itoa(len(filterValues)) } if !filter.PartId.IsZero() { filterValues = append(filterValues, filter.PartId) query += `AND part_id = $` + strconv.Itoa(len(filterValues)) } if !filter.State.IsZero() { filterValues = append(filterValues, filter.State) query += `AND state = $` + strconv.Itoa(len(filterValues)) } // // The following code will add our REQUIRED filters // (Please note we use these for pagination purposes!) // if filter.LastSeenId \u003e 0 { filterValues = append(filterValues, filter.LastSeenId) query += `AND id \u003c $` + strconv.Itoa(len(filterValues)) } query += `ORDER BY id ` filterValues = append(filterValues, filter.Limit) query += `DESC LIMIT $` + strconv.Itoa(len(filterValues)) // // Execute our custom built SQL query to the database. // (Notice our usage of the `variadic function`?) // return s.db.QueryContext(ctx, query, filterValues...) } func (s *ThingRepoImpl) ListByFilter(ctx context.Context, filter *models.ThingFilter) ([]*models.Thing, error) { ctx, cancel := context.WithTimeout(ctx, 5*time.Second) defer cancel() querySelect := ` SELECT tenant_id, id, manufacturer_id, part_id, state, name FROM things` rows, err := s.queryRowsWithFilter(ctx, querySelect, filter) if err != nil { return nil, err } var arr []*models.Thing defer rows.Close() for rows.Next() { m := new(models.Thing) err := rows.Scan( \u0026m.TenantId, \u0026m.Id,\t\u0026m.ManufacturerId, \u0026m.PartId, \u0026m.State, \u0026m.Name, ) if err != nil { return nil, err } arr = append(arr, m) } err = rows.Err() return arr, err } func (s *ThingRepoImpl) CountByFilter(ctx context.Context, filter *models.ThingFilter) (uint64, error) { ctx, cancel := context.WithTimeout(ctx, 5*time.Second) defer cancel() // The result we are looking for. var count uint64 // Array will hold all the unique values we want to add into the query. var filterValues []interface{} // The SQL query statement we will be calling in the database, start // by setting the `tenant_id` placeholder and then append our value to // the array. filterValues = append(filterValues, filter.TenantId) query := ` SELECT COUNT(id) FROM things WHERE tenant_id = $` + strconv.Itoa(len(filterValues)) // // The following code will add our filters // if !filter.ManufacturerId.IsZero() { filterValues = append(filterValues, filter.ManufacturerId) query += `AND manufacturer_id = $` + strconv.Itoa(len(filterValues)) } if !filter.PartId.IsZero() { filterValues = append(filterValues, filter.PartId) query += `AND part_id = $` + strconv.Itoa(len(filterValues)) } if !filter.State.IsZero() { filterValues = append(filterValues, filter.State) query += `AND state = $` + strconv.Itoa(len(filterValues)) } // // Execute our custom built SQL query to the database. // err := s.db.QueryRowContext(ctx, query, filterValues...).Scan(\u0026count) return count, err } Extra Solutions 2022-02-28 UPDATE: Recently I had someone email me the following question in regards to this article:\nHow do you apply that approach to check for other than “=” conditions?\nI think that’s a great question! As a result, I’d like to expand this article to answer.\nIf you dear reader have any questions, don’t hesitate to reach out and contact me!\nHow do I filter by Date/time? Let’s setup the following SQL structure. Let’s assume the metric_id points to another table table with sensors (ex: UV Index), the implementation of that table doesn’t matter. Here is our time_series_data table:\nCREATE TABLE time_series_data ( metric_id BIGINT NOT NULL, timestamp TIMESTAMPTZ NOT NULL, value DOUBLE PRECISION NULL, FOREIGN KEY (metric_id) REFERENCES metrics(id) ON DELETE CASCADE, PRIMARY KEY(timestamp, metric_id) ); If we want to lookup all records before 2022/02/28 date then we would write:\nimport datetime series = TimeSeriesData.objects.filter(timestamp__lte=datetime.date(2022, 02, 28)) Furthermore if we want to find data within a range we can write the follow:\nfrom datetime import date, timedelta startdate = date.today() enddate = startdate + timedelta(days=6) series = TimeSeriesData.objects.filter(timestamp__range=[startdate, enddate]) Given the above cases, how do we support it? Let’s apply what we learned so far with a few additions. In Django’s ORM, if you want to filter, you have the following options:\nlte - Less then or equal to. lt - Less then. gte - Greater then or equal. gt - Greater then. As a result, we’ll create fields for each filter case so the code will look as follows:\nmodels/time_series_data.go // github.com/bartmika/hello-server/internal/models/time_series_data.go package models import ( \"context\" \"time\" null \"gopkg.in/guregu/null.v4\" ) type TimeSeriesDataFilter struct { // MetricID is used for filtering data from a particular sensor / instrument. MetricID uint64 `json:\"metric_id\"` // SortOrder is used for you to pick which ordering to use. Either use `asc` or `desc`. SortOrder string `json:\"sort_order\"` // SortField is used for the specific field to order by. SortField string `json:\"sort_field\"` Offset uint64 `json:\"offset\"` Limit uint64 `json:\"limit\"` // The following filters are to be used for specific date/time. TimestampGreaterThen null.Time `json:\"timestamp_gt,omitempty\"` TimestampGreaterThenOrEqual null.Time `json:\"timestamp_gte,omitempty\"` TimestampLessThen null.Time `json:\"timestamp_lt,omitempty\"` TimestampLessThenOrEqual null.Time `json:\"timestamp_lte,omitempty\"` } // TimeSeriesDatum is a row in the `time_series_data` table. type TimeSeriesDatum struct { MetricID uint64 `json:\"metric_id\"` Timestamp time.Time `json:\"timestamp\"` Value null.Float `json:\"value\"` } type TimeSeriesDatumRepository interface { ListByFilter(ctx context.Context, filter *TimeSeriesDataFilter) ([]*TimeSeriesDatum, error) } repositories/time_series_data.go // github.com/bartmika/hello-server/internal/repositories/time_series_data.go package repositories import ( \"context\" \"database/sql\" \"strconv\" \"time\" \"github.com/bartmika/hello-server/internal/models\" ) type TimeSeriesDatumRepo struct { db *sql.DB } func NewTimeSeriesDatumRepo(db *sql.DB) *TimeSeriesDatumRepo { return \u0026TimeSeriesDatumRepo{ db: db, } } func (s *TimeSeriesDatumRepo) listQueryRowsWithFilter(ctx context.Context, query string, f *models.TimeSeriesDataFilter) (*sql.Rows, error) { // Array will hold all the unique values we want to add into the query. var filterValues []interface{} // The SQL query statement we will be calling in the database, start // by setting the `tenant_id` placeholder and then append our value to // the array. filterValues = append(filterValues, f.MetricID) query += ` WHERE metric_id = $` + strconv.Itoa(len(filterValues)) // // The following code will add our filters // if !f.TimestampGreaterThenOrEqual.IsZero() { filterValues = append(filterValues, f.TimestampGreaterThenOrEqual) query += ` AND timestamp \u003e= $` + strconv.Itoa(len(filterValues)) } if !f.TimestampGreaterThen.IsZero() { filterValues = append(filterValues, f.TimestampGreaterThen) query += ` AND timestamp \u003e $` + strconv.Itoa(len(filterValues)) } if !f.TimestampLessThenOrEqual.IsZero() { filterValues = append(filterValues, f.TimestampLessThenOrEqual) query += ` AND timestamp \u003c= $` + strconv.Itoa(len(filterValues)) } if !f.TimestampLessThen.IsZero() { filterValues = append(filterValues, f.TimestampLessThen) query += ` AND timestamp \u003c $` + strconv.Itoa(len(filterValues)) } // // The following code will add our pagination. // if f.Offset \u003e 0 { // This step is necessary so please do not delete. f.Offset = f.Offset - 1 } query += ` ORDER BY ` + f.SortField + ` ` + f.SortOrder filterValues = append(filterValues, f.Limit) query += ` LIMIT $` + strconv.Itoa(len(filterValues)) filterValues = append(filterValues, f.Offset) query += ` OFFSET $` + strconv.Itoa(len(filterValues)) // // Execute our custom built SQL query to the database. // // // For debugging purposes only. // log.Println(\"TimeSeriesDatumRepo | query:\", query) // log.Println(\"TimeSeriesDatumRepo | filterValues:\", filterValues) // log.Println(\"TimeSeriesDatumRepo | f:\", f) return s.db.QueryContext(ctx, query, filterValues...) } func (s *TimeSeriesDatumRepo) ListByFilter(ctx context.Context, filter *models.TimeSeriesDataFilter) ([]*models.TimeSeriesDatum, error) { ctx, cancel := context.WithTimeout(ctx, 5*time.Second) defer cancel() querySelect := ` SELECT metric_id, timestamp, value FROM time_series_data ` rows, err := s.listQueryRowsWithFilter(ctx, querySelect, filter) if err != nil { return nil, err } var arr []*models.TimeSeriesDatum defer rows.Close() for rows.Next() { m := new(models.TimeSeriesDatum) err := rows.Scan( \u0026m.MetricID, \u0026m.Timestamp, \u0026m.Value, ) if err != nil { return nil, err } arr = append(arr, m) } err = rows.Err() if err != nil { return nil, err } if arr == nil { return []*models.TimeSeriesDatum{}, nil } return arr, err } Example of Filtering with Dates Filter by Less than or Equal to The following example is how you would get all the data from the beginning to yesterdays date for a particular metric:\n// ... var mid uint64 = 1 // Pretend its a UV Index meter. var nowDT time.Time = time.Now() var yesterdayDT time.Time = time.Date(nowDT.Year(), nowDT.Month(), nowDT.Day()-1, 0, 0, 0, 0, nowDT.Location()) f := models.TimeSeriesDataFilter{ MetricID: mid, SortField: \"timestamp\", SortOrder: \"DESC\", Offset: 0, Limit: 100, TimestampLessThenOrEqual: yesterdayDT, } arr, err := TimeSeriesDatumRepo.ListByFilter(ctx, \u0026f) if err != nil { return err } log.Println(arr) // Return your data. Filter by Range The following example is how you would get all the data from yesterday to today (a.k.a. range):\n// ... var mid uint64 = 1 // Pretend its a UV Index meter. var nowDT time.Time = time.Now() var yesterdayDT time.Time = time.Date(nowDT.Year(), nowDT.Month(), nowDT.Day()-1, 0, 0, 0, 0, nowDT.Location()) f := models.TimeSeriesDataFilter{ MetricID: mid, SortField: \"timestamp\", SortOrder: \"DESC\", Offset: 0, Limit: 100, TimestampGreaterThen: yesterdayDT, TimestampLessThenOrEqual: nowDT, } arr, err := TimeSeriesDatumRepo.ListByFilter(ctx, \u0026f) if err != nil { return err } log.Println(arr) // Return your data. ","wordCount":"2978","inLanguage":"en","image":"https://bartlomiejmika.com/img/2021/common/go-banner.png","datePublished":"2021-05-07T15:15:47-04:00","dateModified":"2022-02-28T20:12:32-05:00","author":{"@type":"Person","name":"Bartlomiej Mika"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bartlomiejmika.com/posts/2021/how-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django/"},"publisher":{"@type":"Organization","name":"Bartlomiej Mika","logo":{"@type":"ImageObject","url":"https://bartlomiejmika.com/img/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bartlomiejmika.com/ accesskey=h title="Bartlomiej Mika (Alt + H)"><img src=https://bartlomiejmika.com/img/bartlomiej_mika.jpeg alt=logo aria-label=logo height=35>Bartlomiej Mika</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bartlomiejmika.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://bartlomiejmika.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://bartlomiejmika.com/pages/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bartlomiejmika.com/>Home</a>&nbsp;»&nbsp;<a href=https://bartlomiejmika.com/posts/>Posts</a></div><h1 class=post-title>How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django</h1><div class=post-meta><span title='2021-05-07 15:15:47 -0400 -0400'>May 7, 2021</span>&nbsp;·&nbsp;14 min&nbsp;·&nbsp;2978 words&nbsp;·&nbsp;Bartlomiej Mika&nbsp;|&nbsp;<a href=https://github.com/bartmika/bartlomiejmika-hugo/tree/master/content/posts/2021/how-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://bartlomiejmika.com/img/2021/common/go-banner.png alt=Go></figure><div class=post-content><p>Recently I had to do some advanced filtering using the <a href=https://golang.org/pkg/database/sql/><code>database/sql</code></a> package found in the Golang standard library. In this article I share how I handled advanced filtering. If you are a beginner in Golang wanting to learn how to improve your understanding of querying the database, this article is for you.</p><p>This article is broken up as follows:</p><ul><li>Context</li><li>Setting up the problem in Python</li><li>Setting up the problem in Golang</li><li>Understand the problem</li><li>First attempt (Static filtering)</li><li>Second attempt (Too complicated)</li><li>The “variadic function” to the rescue</li><li>The Solution</li><li>Extra Solutions</li></ul><p>Let&rsquo;s begin!</p><h1 id=context>Context<a hidden class=anchor aria-hidden=true href=#context>#</a></h1><p>Before using Golang to write web-applications, I&rsquo;ve was using <a href=https://www.djangoproject.com><code>Django Web Framework</code></a> which is written in Python. Django provides a <a href=https://docs.djangoproject.com/en/3.2/topics/db/models/>object relational-mapping (ORM)</a> system to handle your python code interacting with the database. Through all my years, I still think the Django ORM is <em>the best I have ever seen</em>.</p><p>Now that I switched my programming from Python to Golang, I no longer have access to this <em>phenomenal library</em>. There are other ORM solutions but none that I&rsquo;ve found to my liking; as a result, I am using only the <a href=https://golang.org/pkg/database/sql/><code>database/sql</code></a> package.</p><p>The transition from Django to Golang has not been easy due to fact of how much Django <em>spoiled me</em>. Django has <em>abstracted away</em> a lot algorithms and computer science theory for me to use in a easy to use plug-in-play code! With the transition I am going through, this situation reminds me of a great article called <a href=https://www.datagubbe.se/endofciv/>Is Software Abstraction Killing Civilization?</a> in which it details talks about how programmers lose certain knowledge through time because we keep using abstracted code; as a result, I&rsquo;d I am writing this article to detail my learning.</p><h1 id=setting-up-the-problem-in-django>Setting up the problem in Django<a hidden class=anchor aria-hidden=true href=#setting-up-the-problem-in-django>#</a></h1><p>Let&rsquo;s assume we have the following data-structure and you populated the table with some dummy data:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>things</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tenant_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=n>BIGSERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>manufacturer_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>part_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>state</span><span class=w> </span><span class=nb>SMALLINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>VARCHAR</span><span class=w> </span><span class=p>(</span><span class=mi>127</span><span class=p>)</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span></span></span></code></pre></div><p>If we want to lookup &ldquo;3D Printer&rdquo; in the <code>name</code> then we would write:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.db.models</span> <span class=kn>import</span> <span class=n>Q</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>series</span> <span class=o>=</span> <span class=n>Thing</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;3D Printer&#34;</span><span class=p>)</span></span></span></code></pre></div><p>Or if we want to lookup a <code>manufacturer_id</code> which does NOT have a particular <code>part_id</code>, we would write:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.db.models</span> <span class=kn>import</span> <span class=n>Q</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>series</span> <span class=o>=</span> <span class=n>Thing</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Q</span><span class=p>(</span><span class=n>manufacturer_id</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span>
</span></span><span class=line><span class=cl>    <span class=o>~</span><span class=n>Q</span><span class=p>(</span><span class=n>part_id</span><span class=o>=</span><span class=mi>444</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p>And how about if we lookup all the things with the <code>name</code> of 3D printers with a particular <code>part_id</code>?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>django.db.models</span> <span class=kn>import</span> <span class=n>Q</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>series</span> <span class=o>=</span> <span class=n>Thing</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>Q</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;3D Printer&#34;</span><span class=p>)</span> <span class=o>&amp;</span>
</span></span><span class=line><span class=cl>    <span class=n>Q</span><span class=p>(</span><span class=n>part_id</span><span class=o>=</span><span class=mi>123456789</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>So the Django ORM is quite good at being flexible enough to handle whatever filtering you can throw at it. How do we build something so flexible in Golang?</strong></p><h1 id=setting-up-the-problem-in-golang>Setting up the problem in Golang<a hidden class=anchor aria-hidden=true href=#setting-up-the-problem-in-golang>#</a></h1><p>I will provide important code snippets to help demonstrate. Please note that this code is following the <a href=https://adodd.net/posts/go-ddd-repository-pattern/>repository pattern</a> so if you don&rsquo;t understand then please read up before proceeding further.</p><p>When following the <strong>repository pattern</strong>, I break up my code into the <em>models</em> and <em>repositories</em> packages.</p><ul><li><strong>models</strong> - Is responsible strictly for the data structure.</li><li><strong>repositories</strong> - Will implement the interface from <em>models</em>.</li></ul><p>The code is as follows:</p><h3 id=modelsthinggo>models/thing.go<a hidden class=anchor aria-hidden=true href=#modelsthinggo>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// github.com/bartmika/hello-server/internal/models/thing.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>models</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>null</span> <span class=s>&#34;gopkg.in/guregu/null.v4&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Structure used to hold filtering request by the user. If using `null` package
</span></span></span><span class=line><span class=cl><span class=c1>// then filter is optional, else the value is required!
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ThingFilter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>TenantId</span>       <span class=kt>uint64</span>   <span class=s>`json:&#34;tenant_id&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>ManufacturerId</span> <span class=nx>null</span><span class=p>.</span><span class=nx>Int</span> <span class=s>`json:&#34;manufacturer_id&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>PartId</span>         <span class=nx>null</span><span class=p>.</span><span class=nx>Int</span> <span class=s>`json:&#34;part_id&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>State</span>          <span class=nx>null</span><span class=p>.</span><span class=nx>Int</span> <span class=s>`json:&#34;state&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>LastSeenId</span>     <span class=kt>uint64</span>   <span class=s>`json:&#34;last_seen_id&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Limit</span>          <span class=kt>uint64</span>   <span class=s>`json:&#34;limit&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The interface we will be using for our `Thing` model. Please note we will be
</span></span></span><span class=line><span class=cl><span class=c1>// using the `repository pattern` so we are adding `Repo` suffix to remind us.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ThingRepo</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>CountByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>(</span><span class=kt>uint64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The model we will be using.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Thing</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>TenantId</span>       <span class=kt>uint64</span>      <span class=s>`db:&#34;tenant_id&#34; json:&#34;tenant_id&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Id</span>             <span class=kt>uint64</span>      <span class=s>`db:&#34;id&#34; json:&#34;id&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>ManufacturerId</span> <span class=kt>uint64</span>      <span class=s>`db:&#34;manufacturer_id&#34; json:&#34;manufacturer_id&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>PartId</span>         <span class=kt>uint64</span>      <span class=s>`db:&#34;part_id&#34; json:&#34;part_id&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>State</span>          <span class=kt>uint</span>        <span class=s>`db:&#34;state&#34; json:&#34;state&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>           <span class=kt>string</span>      <span class=s>`db:&#34;state&#34; json:&#34;name&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=repositoriesthinggo>repositories/thing.go<a hidden class=anchor aria-hidden=true href=#repositoriesthinggo>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// github.com/bartmika/hello-server/internal/repositories/thing.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>repositories</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// null &#34;gopkg.in/guregu/null.v4&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/hello-server/internal/models&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ThingRepoImpl</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewThingRepoImpl</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>ThingRepoImpl</span><span class=p>{</span><span class=nx>db</span><span class=p>:</span> <span class=nx>db</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>CountByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>(</span><span class=kt>uint64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// TODO
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=example-usage>Example Usage<a hidden class=anchor aria-hidden=true href=#example-usage>#</a></h3><h4 id=filter-only-one-column>Filter only one column<a hidden class=anchor aria-hidden=true href=#filter-only-one-column>#</a></h4><p>Here is how we lookup a single column:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// Assume you setup the context
</span></span></span><span class=line><span class=cl><span class=c1>// ctx := ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Assume you connected to the database
</span></span></span><span class=line><span class=cl><span class=c1>// db := ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>thingRepo</span> <span class=o>:=</span> <span class=nx>repositories</span><span class=p>.</span><span class=nf>NewThingRepoImpl</span><span class=p>(</span><span class=nx>db</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Lookup all the `things` for a particular manufacturer.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>thingFilter</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ManufacturerId</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>things</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>thingRepo</span><span class=p>.</span><span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>thingFilter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>things</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span></code></pre></div><h4 id=filter-more-then-one-column>Filter more then one column<a hidden class=anchor aria-hidden=true href=#filter-more-then-one-column>#</a></h4><p>Here is how we lookup three columns:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// Assume you setup the context
</span></span></span><span class=line><span class=cl><span class=c1>// ctx := ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// Assume you connected to the database
</span></span></span><span class=line><span class=cl><span class=c1>// db := ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>thingRepo</span> <span class=o>:=</span> <span class=nx>repositories</span><span class=p>.</span><span class=nf>NewThingRepoImpl</span><span class=p>(</span><span class=nx>db</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Lookup all the `things` for a particular manufacturer and part
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>thingFilter</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ManufacturerId</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>PartId</span><span class=p>:</span> <span class=mi>123</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>State</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>things</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>thingRepo</span><span class=p>.</span><span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>thingFilter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>things</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span></code></pre></div><p>Now that we&rsquo;ve seen filtering code prototype and usage, let&rsquo;s discuss implementation of the <code>TODO</code> items in our repository.</p><h1 id=understand-the-problem>Understand the problem<a hidden class=anchor aria-hidden=true href=#understand-the-problem>#</a></h1><p>If we look at our <code>ThingFilter</code> structure we see that the user has the option of using three optional filters and 3 required:</p><ul><li>TenantId -> Required</li><li>ManufacturerId -> Optional</li><li>PartId -> Optional</li><li>State -> Optional</li><li>LastSeenId -> Required</li><li>Limit -> Required</li></ul><p>Therefore our filtering code should handle these cases.</p><h2 id=first-attempt-static-filtering>First attempt (Static filtering)<a hidden class=anchor aria-hidden=true href=#first-attempt-static-filtering>#</a></h2><p>My first attempt at solving the problem was to create the dedicated functions for whatever filtering we will have. Take a look at the <code>repositories/thing.go</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// github.com/bartmika/hello-server/internal/repositories/thing.go
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListAll</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListByStateId</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>stateId</span> <span class=kt>uint64</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListByManufacturerId</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>manufacturerId</span> <span class=kt>uint64</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListByManufacturerIdAndState</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>manufacturerId</span> <span class=kt>uint64</span><span class=p>,</span> <span class=nx>stateId</span> <span class=kt>uint64</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListByManufacturerIdAndPartId</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>manufacturerId</span> <span class=kt>uint64</span><span class=p>,</span> <span class=nx>partId</span> <span class=kt>uint64</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListByManufacturerIdAndPartIdAndStateId</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>manufacturerId</span> <span class=kt>uint64</span><span class=p>,</span> <span class=nx>partId</span> <span class=kt>uint64</span><span class=p>,</span> <span class=nx>stateId</span> <span class=kt>uint64</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Etc, etc
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span></code></pre></div><p>As you can see there are a number of problems to take into consideration:</p><ul><li>Every time you want to add a new column to filter, a lot more functions need to be created.</li><li>It&rsquo;s not practical - The more filters you want to do, the more functions you have to write to maintain.</li></ul><p>What pattern do you notice? This pattern does not work, an alternate solutions needs to exist.</p><h2 id=second-attempt-too-complicated>Second attempt (Too complicated)<a hidden class=anchor aria-hidden=true href=#second-attempt-too-complicated>#</a></h2><p>My second attempt involved creating a unified function which encapsulates all the filtering capability.</p><p>Take a look at the <code>repositories/thing.go</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// github.com/bartmika/hello-server/internal/repositories/thing.go
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>queryRowsWithFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>querySelect</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>Rows</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>ManufacturerId</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>PartId</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>State</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Filtering by: Nothing&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>query</span> <span class=o>:=</span> <span class=nx>querySelect</span> <span class=o>+</span> <span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>                WHERE
</span></span></span><span class=line><span class=cl><span class=s>                    tenant_id = $1
</span></span></span><span class=line><span class=cl><span class=s>                AND
</span></span></span><span class=line><span class=cl><span class=s>                    id &gt; $2
</span></span></span><span class=line><span class=cl><span class=s>                ORDER BY
</span></span></span><span class=line><span class=cl><span class=s>                    id
</span></span></span><span class=line><span class=cl><span class=s>                DESC LIMIT $3`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>TenantId</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>LastSeenId</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>Limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Filtering by: Only State&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nx>query</span> <span class=o>:=</span> <span class=nx>querySelect</span> <span class=o>+</span> <span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>                WHERE
</span></span></span><span class=line><span class=cl><span class=s>                    tenant_id = $1
</span></span></span><span class=line><span class=cl><span class=s>                AND
</span></span></span><span class=line><span class=cl><span class=s>                    id &gt; $2
</span></span></span><span class=line><span class=cl><span class=s>                AND
</span></span></span><span class=line><span class=cl><span class=s>                    state = $3
</span></span></span><span class=line><span class=cl><span class=s>                ORDER BY
</span></span></span><span class=line><span class=cl><span class=s>                    id
</span></span></span><span class=line><span class=cl><span class=s>                DESC LIMIT $4`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>TenantId</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>State</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>LastSeenId</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>Limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>State</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Not writing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Not writing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>PartId</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>PartId</span><span class=p>.</span><span class=nf>State</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Not writing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Not writing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>PartId</span><span class=p>.</span><span class=nf>State</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Not writing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Not writing code ...
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>7</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>querySelect</span> <span class=o>:=</span> <span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>    SELECT
</span></span></span><span class=line><span class=cl><span class=s>        tenant_id,
</span></span></span><span class=line><span class=cl><span class=s>        id,
</span></span></span><span class=line><span class=cl><span class=s>        manufacturer_id,
</span></span></span><span class=line><span class=cl><span class=s>        part_id,
</span></span></span><span class=line><span class=cl><span class=s>        state,
</span></span></span><span class=line><span class=cl><span class=s>        name
</span></span></span><span class=line><span class=cl><span class=s>    FROM
</span></span></span><span class=line><span class=cl><span class=s>        things`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>queryRowsWithFilter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>querySelect</span><span class=p>,</span> <span class=nx>filter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>arr</span> <span class=p>[]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>m</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>TenantId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>ManufacturerId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>PartId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>State</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>arr</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>arr</span><span class=p>,</span> <span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>arr</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As you can see there are a number of problems to take into consideration:</p><ul><li>Every time you want to add a new column to filter, the code get&rsquo;s super complicated quickly with repetition.</li><li>It&rsquo;s complicated</li><li>It&rsquo;s not practical - The more filters you want to do, the more complex it becomes</li></ul><p>What pattern do you notice? The parameters we want to filter needs to change every time for the <code>QueryContext</code> function and we need to update the <code>sql statement</code> as well. The SQL statement is a string so we can easily modify the string, but how do we call the <code>QueryContext</code> function multiple times with different parameters?</p><h2 id=the-variadic-function-to-the-rescue>The &ldquo;variadic function&rdquo; to the rescue<a hidden class=anchor aria-hidden=true href=#the-variadic-function-to-the-rescue>#</a></h2><p>In Golang, we have a <a href=https://golangbot.com/variadic-functions/>variadic function</a> which can be used to load up different parameters into the <code>QueryContext</code> function.</p><h1 id=the-solution>The Solution<a hidden class=anchor aria-hidden=true href=#the-solution>#</a></h1><p>The solution which works is to utilize <a href=https://golangbot.com/variadic-functions/>variadic functions</a> and our code looks as follows.</p><h4 id=repositoriesthinggo-1>repositories/thing.go<a hidden class=anchor aria-hidden=true href=#repositoriesthinggo-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// github.com/bartmika/hello-server/internal/repositories/thing.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>repositories</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/hello-server/internal/models&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ThingRepoImpl</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewThingRepoImpl</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>ThingRepoImpl</span><span class=p>{</span><span class=nx>db</span><span class=p>:</span> <span class=nx>db</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>queryRowsWithFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>query</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>Rows</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Array will hold all the unique values we want to add into the query.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>filterValues</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// The SQL query statement we will be calling in the database, start
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// by setting the `tenant_id` placeholder and then append our value to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the array.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>TenantId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span> <span class=o>+=</span> <span class=s>`WHERE tenant_id = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// The following code will add our OPTIONAL filters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>filter</span><span class=p>.</span><span class=nx>ManufacturerId</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>ManufacturerId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>`AND manufacturer_id = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>filter</span><span class=p>.</span><span class=nx>PartId</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>PartId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>`AND part_id = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>filter</span><span class=p>.</span><span class=nx>State</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>State</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>`AND state = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// The following code will add our REQUIRED filters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (Please note we use these for pagination purposes!)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>LastSeenId</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>LastSeenId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>`AND id &lt; $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span> <span class=o>+=</span> <span class=s>`ORDER BY id `</span>
</span></span><span class=line><span class=cl>    <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>Limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span> <span class=o>+=</span> <span class=s>`DESC LIMIT $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Execute our custom built SQL query to the database.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (Notice our usage of the `variadic function`?)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>filterValues</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>querySelect</span> <span class=o>:=</span> <span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>    SELECT
</span></span></span><span class=line><span class=cl><span class=s>        tenant_id,
</span></span></span><span class=line><span class=cl><span class=s>        id,
</span></span></span><span class=line><span class=cl><span class=s>        manufacturer_id,
</span></span></span><span class=line><span class=cl><span class=s>        part_id,
</span></span></span><span class=line><span class=cl><span class=s>        state,
</span></span></span><span class=line><span class=cl><span class=s>        name
</span></span></span><span class=line><span class=cl><span class=s>    FROM
</span></span></span><span class=line><span class=cl><span class=s>        things`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>queryRowsWithFilter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>querySelect</span><span class=p>,</span> <span class=nx>filter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>arr</span> <span class=p>[]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>m</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>models</span><span class=p>.</span><span class=nx>Thing</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>TenantId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>Id</span><span class=p>,</span>			
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>ManufacturerId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>PartId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>State</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>arr</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>arr</span><span class=p>,</span> <span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>arr</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>ThingRepoImpl</span><span class=p>)</span> <span class=nf>CountByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>ThingFilter</span><span class=p>)</span> <span class=p>(</span><span class=kt>uint64</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// The result we are looking for.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>count</span> <span class=kt>uint64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Array will hold all the unique values we want to add into the query.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>filterValues</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// The SQL query statement we will be calling in the database, start
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// by setting the `tenant_id` placeholder and then append our value to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the array.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>TenantId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span> <span class=o>:=</span> <span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>    SELECT COUNT(id) FROM
</span></span></span><span class=line><span class=cl><span class=s>        things
</span></span></span><span class=line><span class=cl><span class=s>    WHERE
</span></span></span><span class=line><span class=cl><span class=s>        tenant_id = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// The following code will add our filters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>filter</span><span class=p>.</span><span class=nx>ManufacturerId</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>ManufacturerId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>`AND manufacturer_id = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>filter</span><span class=p>.</span><span class=nx>PartId</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>PartId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>`AND part_id = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>filter</span><span class=p>.</span><span class=nx>State</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>filter</span><span class=p>.</span><span class=nx>State</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>`AND state = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Execute our custom built SQL query to the database.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryRowContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>filterValues</span><span class=o>...</span><span class=p>).</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>count</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=extra-solutions>Extra Solutions<a hidden class=anchor aria-hidden=true href=#extra-solutions>#</a></h1><p><em>2022-02-28 UPDATE: Recently I had someone email me the following question in regards to this article:</em></p><blockquote><p>How do you apply that approach to check for other than &ldquo;=&rdquo; conditions?</p></blockquote><p><em>I think that&rsquo;s a great question! As a result, I&rsquo;d like to expand this article to answer.</em></p><p><em>If you dear reader have any questions, don&rsquo;t hesitate to reach out and <a href=/about/>contact me</a>!</em></p><h2 id=how-do-i-filter-by-datetime>How do I filter by Date/time?<a hidden class=anchor aria-hidden=true href=#how-do-i-filter-by-datetime>#</a></h2><p>Let&rsquo;s setup the following SQL structure. Let&rsquo;s assume the <code>metric_id</code> points to another table table with sensors (ex: UV Index), the implementation of that table doesn&rsquo;t matter. Here is our <code>time_series_data</code> table:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>time_series_data</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>metric_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>timestamp</span><span class=w> </span><span class=n>TIMESTAMPTZ</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>value</span><span class=w> </span><span class=n>DOUBLE</span><span class=w> </span><span class=k>PRECISION</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FOREIGN</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>metric_id</span><span class=p>)</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>metrics</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>DELETE</span><span class=w> </span><span class=k>CASCADE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>(</span><span class=k>timestamp</span><span class=p>,</span><span class=w> </span><span class=n>metric_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span></span></span></code></pre></div><p>If we want to lookup all records before <em>2022/02/28</em> date then we would write:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>series</span> <span class=o>=</span> <span class=n>TimeSeriesData</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>timestamp__lte</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>date</span><span class=p>(</span><span class=mi>2022</span><span class=p>,</span> <span class=mi>02</span><span class=p>,</span> <span class=mi>28</span><span class=p>))</span></span></span></code></pre></div><p>Furthermore if we want to find data within a range we can write the follow:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>date</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>startdate</span> <span class=o>=</span> <span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>enddate</span> <span class=o>=</span> <span class=n>startdate</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>series</span> <span class=o>=</span> <span class=n>TimeSeriesData</span><span class=o>.</span><span class=n>objects</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=n>timestamp__range</span><span class=o>=</span><span class=p>[</span><span class=n>startdate</span><span class=p>,</span> <span class=n>enddate</span><span class=p>])</span></span></span></code></pre></div><p>Given the above cases, how do we support it? Let&rsquo;s apply what we learned so far with a few additions. In Django&rsquo;s ORM, if you want to filter, you have the following options:</p><ul><li><code>lte</code> - Less then or equal to.</li><li><code>lt</code> - Less then.</li><li><code>gte</code> - Greater then or equal.</li><li><code>gt</code> - Greater then.</li></ul><p>As a result, we&rsquo;ll create fields for each filter case so the code will look as follows:</p><h3 id=modelstime_series_datago>models/time_series_data.go<a hidden class=anchor aria-hidden=true href=#modelstime_series_datago>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/bartmika/hello-server/internal/models/time_series_data.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>models</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>null</span> <span class=s>&#34;gopkg.in/guregu/null.v4&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TimeSeriesDataFilter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// MetricID is used for filtering data from a particular sensor / instrument.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>MetricID</span>                    <span class=kt>uint64</span>    <span class=s>`json:&#34;metric_id&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// SortOrder is used for you to pick which ordering to use. Either use `asc` or `desc`.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>SortOrder</span>                   <span class=kt>string</span>    <span class=s>`json:&#34;sort_order&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// SortField is used for the specific field to order by.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>SortField</span>                   <span class=kt>string</span>    <span class=s>`json:&#34;sort_field&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>Offset</span>                      <span class=kt>uint64</span>    <span class=s>`json:&#34;offset&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Limit</span>                       <span class=kt>uint64</span>    <span class=s>`json:&#34;limit&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// The following filters are to be used for specific date/time.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>TimestampGreaterThen</span>        <span class=nx>null</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`json:&#34;timestamp_gt,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>TimestampGreaterThenOrEqual</span> <span class=nx>null</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`json:&#34;timestamp_gte,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>TimestampLessThen</span>           <span class=nx>null</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`json:&#34;timestamp_lt,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>TimestampLessThenOrEqual</span>    <span class=nx>null</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`json:&#34;timestamp_lte,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// TimeSeriesDatum is a row in the `time_series_data` table.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>TimeSeriesDatum</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>MetricID</span>  <span class=kt>uint64</span>     <span class=s>`json:&#34;metric_id&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Timestamp</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span>  <span class=s>`json:&#34;timestamp&#34;`</span>
</span></span><span class=line><span class=cl>    <span class=nx>Value</span>     <span class=nx>null</span><span class=p>.</span><span class=nx>Float</span> <span class=s>`json:&#34;value&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TimeSeriesDatumRepository</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>TimeSeriesDataFilter</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>TimeSeriesDatum</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=repositoriestime_series_datago>repositories/time_series_data.go<a hidden class=anchor aria-hidden=true href=#repositoriestime_series_datago>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// github.com/bartmika/hello-server/internal/repositories/time_series_data.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kn>package</span> <span class=nx>repositories</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;database/sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;strconv&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/hello-server/internal/models&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TimeSeriesDatumRepo</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewTimeSeriesDatumRepo</span><span class=p>(</span><span class=nx>db</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>)</span> <span class=o>*</span><span class=nx>TimeSeriesDatumRepo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>TimeSeriesDatumRepo</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>db</span><span class=p>:</span> <span class=nx>db</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TimeSeriesDatumRepo</span><span class=p>)</span> <span class=nf>listQueryRowsWithFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>query</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>f</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDataFilter</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>Rows</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Array will hold all the unique values we want to add into the query.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>filterValues</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// The SQL query statement we will be calling in the database, start
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// by setting the `tenant_id` placeholder and then append our value to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the array.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>MetricID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span> <span class=o>+=</span> <span class=s>` WHERE metric_id = $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// The following code will add our filters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>f</span><span class=p>.</span><span class=nx>TimestampGreaterThenOrEqual</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>TimestampGreaterThenOrEqual</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>` AND timestamp &gt;= $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>f</span><span class=p>.</span><span class=nx>TimestampGreaterThen</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>TimestampGreaterThen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>` AND timestamp &gt; $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>f</span><span class=p>.</span><span class=nx>TimestampLessThenOrEqual</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>TimestampLessThenOrEqual</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>` AND timestamp &lt;= $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>!</span><span class=nx>f</span><span class=p>.</span><span class=nx>TimestampLessThen</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>TimestampLessThen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>query</span> <span class=o>+=</span> <span class=s>` AND timestamp &lt; $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// The following code will add our pagination.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>f</span><span class=p>.</span><span class=nx>Offset</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// This step is necessary so please do not delete.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>f</span><span class=p>.</span><span class=nx>Offset</span> <span class=p>=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>Offset</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span> <span class=o>+=</span> <span class=s>` ORDER BY `</span> <span class=o>+</span> <span class=nx>f</span><span class=p>.</span><span class=nx>SortField</span> <span class=o>+</span> <span class=s>` `</span> <span class=o>+</span> <span class=nx>f</span><span class=p>.</span><span class=nx>SortOrder</span>
</span></span><span class=line><span class=cl>    <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>Limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span> <span class=o>+=</span> <span class=s>` LIMIT $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nx>filterValues</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>,</span> <span class=nx>f</span><span class=p>.</span><span class=nx>Offset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>query</span> <span class=o>+=</span> <span class=s>` OFFSET $`</span> <span class=o>+</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Itoa</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nx>filterValues</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Execute our custom built SQL query to the database.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;TimeSeriesDatumRepo | query:&#34;, query)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;TimeSeriesDatumRepo | filterValues:&#34;, filterValues)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;TimeSeriesDatumRepo | f:&#34;, f)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>db</span><span class=p>.</span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>query</span><span class=p>,</span> <span class=nx>filterValues</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TimeSeriesDatumRepo</span><span class=p>)</span> <span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>filter</span> <span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDataFilter</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>querySelect</span> <span class=o>:=</span> <span class=s>`
</span></span></span><span class=line><span class=cl><span class=s>    SELECT
</span></span></span><span class=line><span class=cl><span class=s>        metric_id,
</span></span></span><span class=line><span class=cl><span class=s>        timestamp,
</span></span></span><span class=line><span class=cl><span class=s>        value
</span></span></span><span class=line><span class=cl><span class=s>    FROM
</span></span></span><span class=line><span class=cl><span class=s>        time_series_data
</span></span></span><span class=line><span class=cl><span class=s>    `</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>rows</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>listQueryRowsWithFilter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>querySelect</span><span class=p>,</span> <span class=nx>filter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>arr</span> <span class=p>[]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>m</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>MetricID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=nx>m</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>arr</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>arr</span><span class=p>,</span> <span class=nx>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=p>=</span> <span class=nx>rows</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>arr</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span><span class=o>*</span><span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>arr</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=example-of-filtering-with-dates>Example of Filtering with Dates<a hidden class=anchor aria-hidden=true href=#example-of-filtering-with-dates>#</a></h3><h4 id=filter-by-less-than-or-equal-to>Filter by Less than or Equal to<a hidden class=anchor aria-hidden=true href=#filter-by-less-than-or-equal-to>#</a></h4><p>The following example is how you would get all the data from the beginning to yesterdays date for a particular metric:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>mid</span> <span class=kt>uint64</span> <span class=p>=</span> <span class=mi>1</span> <span class=c1>// Pretend its a UV Index meter.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>nowDT</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>yesterdayDT</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Date</span><span class=p>(</span><span class=nx>nowDT</span><span class=p>.</span><span class=nf>Year</span><span class=p>(),</span> <span class=nx>nowDT</span><span class=p>.</span><span class=nf>Month</span><span class=p>(),</span> <span class=nx>nowDT</span><span class=p>.</span><span class=nf>Day</span><span class=p>()</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>nowDT</span><span class=p>.</span><span class=nf>Location</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>f</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDataFilter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>MetricID</span><span class=p>:</span>  <span class=nx>mid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>SortField</span><span class=p>:</span> <span class=s>&#34;timestamp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>SortOrder</span><span class=p>:</span> <span class=s>&#34;DESC&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Offset</span><span class=p>:</span>                      <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Limit</span><span class=p>:</span>                       <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>TimestampLessThenOrEqual</span><span class=p>:</span>    <span class=nx>yesterdayDT</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>TimeSeriesDatumRepo</span><span class=p>.</span><span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>arr</span><span class=p>)</span> <span class=c1>// Return your data.
</span></span></span></code></pre></div><h4 id=filter-by-range>Filter by Range<a hidden class=anchor aria-hidden=true href=#filter-by-range>#</a></h4><p>The following example is how you would get all the data from yesterday to today (a.k.a. range):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>mid</span> <span class=kt>uint64</span> <span class=p>=</span> <span class=mi>1</span> <span class=c1>// Pretend its a UV Index meter.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>nowDT</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>yesterdayDT</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Date</span><span class=p>(</span><span class=nx>nowDT</span><span class=p>.</span><span class=nf>Year</span><span class=p>(),</span> <span class=nx>nowDT</span><span class=p>.</span><span class=nf>Month</span><span class=p>(),</span> <span class=nx>nowDT</span><span class=p>.</span><span class=nf>Day</span><span class=p>()</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>nowDT</span><span class=p>.</span><span class=nf>Location</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>f</span> <span class=o>:=</span> <span class=nx>models</span><span class=p>.</span><span class=nx>TimeSeriesDataFilter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>MetricID</span><span class=p>:</span>  <span class=nx>mid</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>SortField</span><span class=p>:</span> <span class=s>&#34;timestamp&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>SortOrder</span><span class=p>:</span> <span class=s>&#34;DESC&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Offset</span><span class=p>:</span>                      <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>Limit</span><span class=p>:</span>                       <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>TimestampGreaterThen</span><span class=p>:</span>        <span class=nx>yesterdayDT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>TimestampLessThenOrEqual</span><span class=p>:</span>    <span class=nx>nowDT</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>arr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>TimeSeriesDatumRepo</span><span class=p>.</span><span class=nf>ListByFilter</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>arr</span><span class=p>)</span> <span class=c1>// Return your data.
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://bartlomiejmika.com/tags/golang/>Golang</a></li><li><a href=https://bartlomiejmika.com/tags/sql/>SQL</a></li></ul><nav class=paginav><a class=prev href=https://bartlomiejmika.com/posts/2021/red-mulberry-growlog-2/><span class=title>« Prev</span><br><span>Red Mulberry Growlog #2</span></a>
<a class=next href=https://bartlomiejmika.com/posts/2021/how-to-get-go2tv-working-with-your-samsung-smart-tv/><span class=title>Next »</span><br><span>How to Get Go2TV Working With Your Samsung Smart TV</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django on twitter" href="https://twitter.com/intent/tweet/?text=How%20to%20do%20Dynamic%20Filtering%20in%20Golang%20using%20only%20the%20Database%20SQL%20Package%20like%20in%20Django&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django%2f&hashtags=Golang%2cSQL"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django%2f&title=How%20to%20do%20Dynamic%20Filtering%20in%20Golang%20using%20only%20the%20Database%20SQL%20Package%20like%20in%20Django&summary=How%20to%20do%20Dynamic%20Filtering%20in%20Golang%20using%20only%20the%20Database%20SQL%20Package%20like%20in%20Django&source=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django%2f&title=How%20to%20do%20Dynamic%20Filtering%20in%20Golang%20using%20only%20the%20Database%20SQL%20Package%20like%20in%20Django"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django on whatsapp" href="https://api.whatsapp.com/send?text=How%20to%20do%20Dynamic%20Filtering%20in%20Golang%20using%20only%20the%20Database%20SQL%20Package%20like%20in%20Django%20-%20https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django on telegram" href="https://telegram.me/share/url?text=How%20to%20do%20Dynamic%20Filtering%20in%20Golang%20using%20only%20the%20Database%20SQL%20Package%20like%20in%20Django&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://bartlomiejmika.com/>Bartlomiej Mika</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>