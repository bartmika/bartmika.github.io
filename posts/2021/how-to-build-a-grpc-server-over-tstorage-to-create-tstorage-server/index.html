<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Build a gRPC Server over tstorage to create tstorage-server | Bartlomiej Mika</title><meta name=keywords content="gRPC,Golang"><meta name=description content="Did you just finish reading the gRPC Basics tutorial and you don&rsquo;t know where to begin with using it? In this post I&rsquo;ll explain how to take a fast time-series database called tstorage and write a gRPC server and client with it."><meta name=author content="Bartlomiej Mika"><link rel=canonical href=https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server/><meta name=google-site-verification content="UA-172742383-1"><link crossorigin=anonymous href=/assets/css/stylesheet.8b523f1730c922e314350296d83fd666efa16519ca136320a93df674d00b6325.css integrity="sha256-i1I/FzDJIuMUNQKW2D/WZu+hZRnKE2MgqT32dNALYyU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://bartlomiejmika.com/img/favicon.ico><link rel=apple-touch-icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=mask-icon href=https://bartlomiejmika.com/img/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-172742383-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="How to Build a gRPC Server over tstorage to create tstorage-server"><meta property="og:description" content="Did you just finish reading the gRPC Basics tutorial and you don&rsquo;t know where to begin with using it? In this post I&rsquo;ll explain how to take a fast time-series database called tstorage and write a gRPC server and client with it."><meta property="og:type" content="article"><meta property="og:url" content="https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server/"><meta property="og:image" content="https://bartlomiejmika.com/img/2021/07-09/harrison-broadbent-nePxBIvqUlU-unsplash.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-09T23:45:08-04:00"><meta property="article:modified_time" content="2021-07-09T23:45:08-04:00"><meta property="og:site_name" content="Bartlomiej Mika"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bartlomiejmika.com/img/2021/07-09/harrison-broadbent-nePxBIvqUlU-unsplash.jpg"><meta name=twitter:title content="How to Build a gRPC Server over tstorage to create tstorage-server"><meta name=twitter:description content="Did you just finish reading the gRPC Basics tutorial and you don&rsquo;t know where to begin with using it? In this post I&rsquo;ll explain how to take a fast time-series database called tstorage and write a gRPC server and client with it."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bartlomiejmika.com/posts/"},{"@type":"ListItem","position":2,"name":"How to Build a gRPC Server over tstorage to create tstorage-server","item":"https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Build a gRPC Server over tstorage to create tstorage-server","name":"How to Build a gRPC Server over tstorage to create tstorage-server","description":"Did you just finish reading the gRPC Basics tutorial and you don\u0026rsquo;t know where to begin with using it? In this post I\u0026rsquo;ll explain how to take a fast time-series database called tstorage and write a gRPC server and client with it.\n","keywords":["gRPC","Golang"],"articleBody":"Did you just finish reading the gRPC Basics tutorial and you don‚Äôt know where to begin with using it? In this post I‚Äôll explain how to take a fast time-series database called tstorage and write a gRPC server and client with it.\nRecently I read an article from HackerNews titled Write a time-series database engine from scratch where the author, Ryo Nakao, details the lessons he learned from implementing a fast time-series database of his own. In the article he mentions that he open sourced it as nakabonne/tstorage.\nInvestigating the repository, it looks well thought out and pretty easy to use; as a result, I thought about using it for personal projects. The challenge with the package is interprocess communication (IPC) as I want to have multiple small applications communicate with tstorage.\nTo get around the IPC issue, I decide to write a consumable gRPC service definition overtop the package so other local or remote applications can use it. I am calling this application tstorage-server.\nThe purpose of this article is describe how to create a list, create and remove endpoints overtop tstorage. The benefit is if you want to create more gRPC servers in the future, you can reference this article.\nThis article is broken down into the following sections:\nPart 1. Setup the Project Part 2. Setup Simple Protocol Buffers Part 3. Setup Simple gRPC Server Part 4. Setup Simple gRPC Client Part 5. Setup tstorage library with our Project | Part 6. Server Endpoints Part 7. Client Subcommands Part 8. Usage examples Assumptions Please note the following:\nYour developer machine is either MacOS or Linux You have golang 1.16 installed or greater You are proficient with git and the terminal. You have basic understanding of the Golang language. You have a intermediate understanding of gRPC, and if not then please read my previous article title ‚ÄúExample of Writing a Simple gRPC Server in Golang from Scratch‚Äù which will get you prepped for this article. Part 1. Setup the Project Before writing any business logic, structure the project so it can grow in a logic and predictable manner.\nStart off by setting up the an empty repository in github and run the following in your terminal:\ncd ~/go/src/github.com/bartmika git clone https://github.com/bartmika/tstorage-server.git cd tstorage-server Initialize golang modules.\ngo mod init github.com/bartmika/tstorage-server Install our project‚Äôs dependencies.\nexport GO111MODULE=on # Enable module mode go get google.golang.org/protobuf/cmd/protoc-gen-go go get google.golang.org/grpc/cmd/protoc-gen-go-grpc go get google.golang.org/grpc go get github.com/golang/protobuf/ptypes/timestamp go get github.com/nakabonne/tstorage go get github.com/spf13/cobra Setup our initial project structure. We will use this structure to grow our application. Please look at the folder and file names in the ‚ÄúProject Hierarchy‚Äù and create them in your computer as blank files.\nProject Hierarchy üìÅ tstorage-server ‚îÇ üìÑ main.go ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ cmd | ‚îî‚îÄ‚îÄ‚îÄüìÑ root.go üìÑ version.go What are going to do? We want our project structured in such a way that it uses the spf13/cobra package so we can easily commands in our application.\nTo begin, please copy and paste the following code into those empty files.\n(1 of 3) main.go package main // github.com/bartmika/tstorage-server/main.go import ( \"github.com/bartmika/tstorage-server/cmd\" ) func main() { cmd.Execute() } (2 of 3) cmd/root.go package cmd // github.com/bartmika/tstorage-server/cmd/root.go import ( \"fmt\" \"os\" \"github.com/spf13/cobra\" ) var rootCmd = \u0026cobra.Command{ Use: \"tstorage-server\", Short: \"Time-series data storage gRPC server\", Long: `The purpose of this application is to provide a local database tailored for fast time-series data storage and be accessible with remote procedure calls (gRPC).`, Run: func(cmd *cobra.Command, args []string) { // Do nothing... }, } func Execute() { if err := rootCmd.Execute(); err != nil { fmt.Fprintln(os.Stderr, err) os.Exit(1) } } (3 of 3) cmd/version.go package cmd // github.com/bartmika/tstorage-server/cmd/version.go import ( \"fmt\" \"github.com/spf13/cobra\" ) func init() { rootCmd.AddCommand(versionCmd) } var versionCmd = \u0026cobra.Command{ Use: \"version\", Short: \"Print the version number\", Long: `Print the current version that this server is on.`, Run: func(cmd *cobra.Command, args []string) { fmt.Println(\"tstorage-server v1.0\") }, } Once you finished, in your terminal please write the following.\ngo run main.go version If you setup everything correctly, there should be no errors. Good job!\nPart 2. Setup Simple Protocol Buffers Now that we have our application structured to use spf13/cobra as our project‚Äôs scaffolding, we can start by creating our code. We will begin with protocol buffers, we need to define a service in .proto file.\nTo begin, create the following folders and files in the your project (notice the asterisks for the new files):\nProject Hierarchy üìÅ tstorage-server ‚îÇ üìÑ README.md ‚îÇ üìÑ main.go ‚îÇ üìÑ Makefile ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ cmd ‚îÇ | | ‚îî‚îÄ‚îÄ‚îÄüìÑ root.go | üìÑ version.go | ‚îî‚îÄ‚îÄ‚îÄüìÅ proto (*) ‚îÇ ‚îî‚îÄ‚îÄüìÑ tstorage.proto (*) Please copy and paste the content of this file.\n(1 of 1) proto/tstorage.proto syntax = \"proto3\"; // github.com/bartmika/tstorage-server/proto/tstorage.proto option go_package = \"github.com/bartmika/tstorage-server\"; package proto; // The greeting service definition. service TStorage { // Sends a greeting rpc SayHello (HelloRequest) returns (HelloReply) {} } // The request message containing the user's name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } In your terminal, make sure we export our path (if you haven‚Äôt done this before) by writing the following:\nexport PATH=\"$PATH:$(go env GOPATH)/bin\" Run the following to generate our new gRPC interface.\nprotoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative proto/tstorage.proto After running the command your structure should look as follows (notice the asterisks). Please look through the new files to get a feel for the code.\nProject Hierarchy üìÅ tstorage-server ‚îÇ üìÑ README.md ‚îÇ üìÑ main.go ‚îÇ üìÑ Makefile ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ cmd ‚îÇ | | ‚îî‚îÄ‚îÄ‚îÄüìÑ root.go | üìÑ version.go | ‚îî‚îÄ‚îÄ‚îÄüìÅ proto ‚îÇ ‚îî‚îÄ‚îÄüìÑ tstorage_grpc.pb.go (*) üìÑ tstorage.proto üìÑ tstorage.pb.go (*) What does this code do?\ntstorage.pb.go, which contains all the protocol buffer code to populate, serialize, and retrieve request and response message types. tstorage_grpc.pb.go, which contains the following: An interface type (or stub) for clients to call with the methods defined in the TStorage service. An interface type for servers to implement, also with the methods defined in the TStorage service. Part 3. Setup Simple gRPC Server Please create the following blank files (notice asterisks):\nProject Hierarchy üìÅ tstorage-server ‚îÇ üìÑ README.md ‚îÇ üìÑ main.go ‚îÇ üìÑ Makefile ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ cmd ‚îÇ | | ‚îî‚îÄ‚îÄ‚îÄüìÑ root.go | üìÑ serve.go (*) | üìÑ version.go ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ internal (*) | ‚îÇ | ‚îî‚îÄ‚îÄüìÑ server_impl.go (*) | üìÑ server.go (*) | ‚îî‚îÄ‚îÄ‚îÄüìÅ proto (*) ‚îÇ ‚îî‚îÄ‚îÄüìÑ tstorage_grpc.pb.go üìÑ tstorage.proto üìÑ tstorage.pb.go Populate the following\n(1 of 3) cmd/serve.go package cmd // github.com/bartmika/tstorage-server/cmd/serve.go import ( \"os\" \"os/signal\" \"syscall\" \"github.com/spf13/cobra\" server \"github.com/bartmika/tstorage-server/internal\" ) var ( port int ) func init() { serveCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port to run this server on\") serveCmd.MarkFlagRequired(\"port\") rootCmd.AddCommand(serveCmd) } func doServe() { server := server.New(port) // DEVELOPERS CODE: // The following code will create an anonymous goroutine which will have a // blocking chan `sigs`. This blocking chan will only unblock when the // golang app receives a termination command; therfore the anyomous // goroutine will run and terminate our running application. // // Special Thanks: // (1) https://gobyexample.com/signals // (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html // sigs := make(chan os.Signal, 1) signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM) go func() { \u003c-sigs // Block execution until signal from terminal gets triggered here. server.StopMainRuntimeLoop() }() server.RunMainRuntimeLoop() } var serveCmd = \u0026cobra.Command{ Use: \"serve\", Short: \"Run the gRPC server\", Long: `Run the gRPC server to allow other services to access the storage application`, Run: func(cmd *cobra.Command, args []string) { doServe() }, } (2 of 3) internal/server.go package internal // github.com/bartmika/tstorage-server/internal/server.go import ( \"fmt\" \"log\" \"net\" \"google.golang.org/grpc\" pb \"github.com/bartmika/tstorage-server/proto\" ) type TStorageServer struct { port: port grpcServer *grpc.Server } func New(port int) (*TStorageServer) { return \u0026TStorageServer{ port: port, grpcServer: nil, } } // Function will consume the main runtime loop and run the business logic // of the application. func (app *TStorageServer) RunMainRuntimeLoop() { // Open a TCP server to the specified localhost and environment variable // specified port number. lis, err := net.Listen(\"tcp\", fmt.Sprintf(\":%v\",s.port)) if err != nil { log.Fatalf(\"failed to listen: %v\", err) } // Initialize our gRPC server using our TCP server. grpcServer := grpc.NewServer() // Save reference to our application state. app.grpcServer = grpcServer // For debugging purposes only. log.Printf(\"gRPC server is running.\") // Block the main runtime loop for accepting and processing gRPC requests. pb.RegisterTStorageServer(grpcServer, \u0026TStorageServerImpl{ // DEVELOPERS NOTE: // We want to attach to every gRPC call the following variables... // ... // ... }) if err := grpcServer.Serve(lis); err != nil { log.Fatalf(\"failed to serve: %v\", err) } } // Function will tell the application to stop the main runtime loop when // the process has been finished. func (app *TStorageServer) StopMainRuntimeLoop() { log.Printf(\"Starting graceful shutdown now...\") // Finish any RPC communication taking place at the moment before // shutting down the gRPC server. app.grpcServer.GracefulStop() } (3 of 3) internal/server_impl.go package internal // github.com/bartmika/tstorage-server/internal/server_impl.go import ( \"context\" \"log\" pb \"github.com/bartmika/tstorage-server/proto\" ) type TStorageServerImpl struct{ pb.TStorageServer } func (s *TStorageServerImpl) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) { log.Printf(\"Received: %v\", in.GetName()) return \u0026pb.HelloReply{Message: \"Hello \" + in.GetName()}, nil } You now have implemented a basic server.\nPart 4. Setup Simple gRPC Client Please create the following blank files:\nProject Hierarchy üìÅ tstorage-server ‚îÇ üìÑ README.md ‚îÇ üìÑ main.go ‚îÇ üìÑ Makefile ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ cmd ‚îÇ | | ‚îî‚îÄ‚îÄ‚îÄüìÑ hello.go (*) | üìÑ root.go | üìÑ serve.go | üìÑ version.go ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ internal | ‚îÇ | ‚îî‚îÄ‚îÄüìÑ server_impl.go | üìÑ server.go | ‚îî‚îÄ‚îÄ‚îÄüìÅ proto ‚îÇ ‚îî‚îÄ‚îÄüìÑ tstorage_grpc.pb.go üìÑ tstorage.proto üìÑ tstorage.pb.go Next populate the following:\ncmd/hello.go package cmd // github.com/bartmika/tstorage-server/cmd/hello.go import ( \"context\" \"fmt\" \"log\" \"time\" \"github.com/spf13/cobra\" \"google.golang.org/grpc\" // \"google.golang.org/grpc/credentials\" pb \"github.com/bartmika/tstorage-server/proto\" ) var ( name string ) func init() { helloCmd.Flags().StringVarP(\u0026name, \"name\", \"n\", \"Anonymous\", \"The name to send the server.\") helloCmd.MarkFlagRequired(\"name\") helloCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port of our server.\") helloCmd.MarkFlagRequired(\"port\") rootCmd.AddCommand(helloCmd) } func doHello() { // Set up a direct connection to the gRPC server. conn, err := grpc.Dial( fmt.Sprintf(\":%v\",port), grpc.WithInsecure(), grpc.WithBlock(), ) if err != nil { log.Fatalf(\"did not connect: %v\", err) } // Set up our protocol buffer interface. client := pb.NewTStorageClient(conn) defer conn.Close() ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() // Perform our gRPC request. r, err := client.SayHello(ctx, \u0026pb.HelloRequest{Name: name}) if err != nil { log.Fatalf(\"could not greet: %v\", err) } // Print out the gRPC response. log.Printf(\"Server Response: %s\", r.GetMessage()) } var helloCmd = \u0026cobra.Command{ Use: \"hello\", Short: \"Send hello message to gRPC server\", Long: `Connect to the gRPC server and send a hello message. Command used to test out that the server is running.`, Run: func(cmd *cobra.Command, args []string) { doHello() }, } Run the following command in your terminal.\ngo run main.go hello --name=\"Bart\" --port=50051 You should get a response as follows:\n2021/07/07 23:22:23 Server Response: Hello Bart Part 5. Setup tstorage library with our Project (1 of 2) cmd/serve.go package cmd // github.com/bartmika/tstorage-server/cmd/serve.go import ( \"log\" \"os\" \"os/signal\" \"syscall\" \"time\" \"github.com/spf13/cobra\" server \"github.com/bartmika/tstorage-server/internal\" \"github.com/bartmika/tstorage-server/utils\" ) var ( port int dataPath string timestampPrecision string partitionDurationInHours int writeTimeoutInSeconds int ) func init() { // The following are required. serveCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port to run this server on\") serveCmd.MarkFlagRequired(\"port\") // The following are optional and will have defaults placed when missing. serveCmd.Flags().StringVarP(\u0026dataPath, \"dataPath\", \"d\", \"./tsdb\", \"The location to save the database files to.\") serveCmd.Flags().StringVarP(\u0026timestampPrecision, \"timestampPrecision\", \"t\", \"s\", \"The precision of timestamps to be used by all operations. Options: \") serveCmd.Flags().IntVarP(\u0026partitionDurationInHours, \"partitionDurationInHours\", \"b\", 1, \"The timestamp range inside partitions.\") serveCmd.Flags().IntVarP(\u0026writeTimeoutInSeconds, \"writeTimeoutInSeconds\", \"w\", 30, \"The timeout to wait when workers are busy (in seconds).\") // Make this sub-command part of our application. rootCmd.AddCommand(serveCmd) } func doServe() { // Convert the user inputted integer value to be a `time.Duration` type. partitionDuration := time.Duration(partitionDurationInHours) * time.Hour writeTimeout := time.Duration(writeTimeoutInSeconds) * time.Second // Setup our server. server := server.New(port, dataPath, timestampPrecision, partitionDuration, writeTimeout) // DEVELOPERS CODE: // The following code will create an anonymous goroutine which will have a // blocking chan `sigs`. This blocking chan will only unblock when the // golang app receives a termination command; therfore the anyomous // goroutine will run and terminate our running application. // // Special Thanks: // (1) https://gobyexample.com/signals // (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html // sigs := make(chan os.Signal, 1) signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM) go func() { \u003c-sigs // Block execution until signal from terminal gets triggered here. server.StopMainRuntimeLoop() }() server.RunMainRuntimeLoop() } var serveCmd = \u0026cobra.Command{ Use: \"serve\", Short: \"Run the gRPC server\", Long: `Run the gRPC server to allow other services to access the storage application`, Run: func(cmd *cobra.Command, args []string) { // Defensive code. Make sure the user selected the correct `timestampPrecision` // choices before continuing execution of our command. okTimestampPrecision := []string{\"ns\", \"us\", \"ms\", \"s\"} if utils.Contains(okTimestampPrecision, timestampPrecision) == false { log.Fatal(\"Timestamp precision must be either one of the following: ns, us, ms, or s.\") } // Execute our command with our validated inputs. doServe() }, } (2 of 2) internal/server.go package internal // github.com/bartmika/tstorage-server/internal/server.go import ( \"fmt\" \"log\" \"net\" \"time\" \"google.golang.org/grpc\" \"github.com/nakabonne/tstorage\" pb \"github.com/bartmika/tstorage-server/proto\" ) type TStorageServer struct { port int dataPath string timestampPrecision tstorage.TimestampPrecision partitionDuration time.Duration writeTimeout time.Duration storage tstorage.Storage grpcServer *grpc.Server } func New(port int, dataPath string, timestampPrecision string, partitionDuration time.Duration, writeTimeout time.Duration) (*TStorageServer) { // Conver to the format that is accepted by the library. var tsp tstorage.TimestampPrecision switch timestampPrecision { case \"ns\": tsp = tstorage.Nanoseconds case \"us\": tsp = tstorage.Microseconds case \"ms\": tsp = tstorage.Milliseconds case \"s\": tsp = tstorage.Seconds } return \u0026TStorageServer{ port: port, dataPath: dataPath, timestampPrecision: tsp, partitionDuration: partitionDuration, writeTimeout: writeTimeout, storage: nil, grpcServer: nil, } } // Function will consume the main runtime loop and run the business logic // of the application. func (s *TStorageServer) RunMainRuntimeLoop() { // Open a TCP server to the specified localhost and environment variable // specified port number. lis, err := net.Listen(\"tcp\", fmt.Sprintf(\":%v\",s.port)) if err != nil { log.Fatalf(\"failed to listen: %v\", err) } // Initialize our gRPC server using our TCP server. grpcServer := grpc.NewServer() // Initialize our fast time-series database. storage, _ := tstorage.NewStorage( tstorage.WithDataPath(s.dataPath), tstorage.WithTimestampPrecision(s.timestampPrecision), tstorage.WithPartitionDuration(s.partitionDuration), tstorage.WithWriteTimeout(s.writeTimeout), ) // Save reference to our application state. s.grpcServer = grpcServer s.storage = storage // For debugging purposes only. log.Printf(\"gRPC server is running.\") // Block the main runtime loop for accepting and processing gRPC requests. pb.RegisterTStorageServer(grpcServer, \u0026TStorageServerImpl{ // DEVELOPERS NOTE: // We want to attach to every gRPC call the following variables... storage: s.storage, }) if err := grpcServer.Serve(lis); err != nil { log.Fatalf(\"failed to serve: %v\", err) } } // Function will tell the application to stop the main runtime loop when // the process has been finished. func (s *TStorageServer) StopMainRuntimeLoop() { log.Printf(\"Starting graceful shutdown now...\") // Finish our database operations running. s.storage.Close() // Finish any RPC communication taking place at the moment before // shutting down the gRPC server. s.grpcServer.GracefulStop() } Part 6. Server Endpoints Please override the following files.\n(1 of 2) proto/tstorage.proto syntax = \"proto3\"; // github.com/bartmika/tstorage-server/proto/tstorage.proto option go_package = \"github.com/bartmika/tstorage-server\"; package proto; import \"google/protobuf/timestamp.proto\"; // The tstorage service definition. service TStorage { rpc SayHello (HelloRequest) returns (HelloReply) {} rpc InsertRow (TimeSeriesDatum) returns (InsertResponse) {} rpc InsertRows (stream TimeSeriesDatum) returns (InsertResponse) {} rpc Select (Filter) returns (stream DataPoint) {} } // --- HELLO ENDPOINT --- // The request message containing the user's name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } // --- COMMON TO ALL ENDPOINTS --- message DataPoint { double value = 3; google.protobuf.Timestamp timestamp = 4; } message Label { string name = 1; string value = 2; } message TimeSeriesDatum { string metric = 1; repeated Label labels = 2; double value = 3; google.protobuf.Timestamp timestamp = 4; } // --- INSERT ENDPOINT --- message InsertResponse { string message = 1; bool status = 2; } // --- SELECT ENDPOINT --- message Filter { string metric = 1; repeated Label labels = 2; google.protobuf.Timestamp start = 3; google.protobuf.Timestamp end = 4; } message SelectResponse { repeated DataPoint points = 1; } In your terminal please write the following:\nprotoc --go_out=. --go_opt=paths=source_relative \\ --go-grpc_out=. --go-grpc_opt=paths=source_relative \\ proto/tstorage.proto Afterwards update the following file:\n(2 of 2) github.com/bartmika/tstorage-server/internal/server_impl.go package internal import ( \"context\" \"log\" \"io\" \"github.com/nakabonne/tstorage\" tspb \"github.com/golang/protobuf/ptypes/timestamp\" pb \"github.com/bartmika/tstorage-server/proto\" ) type TStorageServerImpl struct{ storage tstorage.Storage pb.TStorageServer } func (s *TStorageServerImpl) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) { log.Printf(\"Received: %v\", in.GetName()) return \u0026pb.HelloReply{Message: \"Hello \" + in.GetName()}, nil } func (s *TStorageServerImpl) InsertRow(ctx context.Context, in *pb.TimeSeriesDatum) (*pb.InsertResponse, error) { // // For debugging purposes only. // log.Println(\"Metric\", in.Metric) // log.Println(\"Value\", in.Value) // log.Println(\"Timestamp\", in.Timestamp) // log.Println(\"Labels\", in.Labels) // Generate our labels, if there are any. labels := []tstorage.Label{} for _, label := range in.Labels { labels = append(labels, tstorage.Label{Name: label.Name, Value: label.Value,}) } // Generate our datapoint. dataPoint := tstorage.DataPoint{Timestamp: in.Timestamp.Seconds, Value: in.Value} err := s.storage.InsertRows([]tstorage.Row{ { Metric: in.Metric, Labels: labels, DataPoint: dataPoint, }, }) return \u0026pb.InsertResponse{Message: \"Created\"}, err } func (s *TStorageServerImpl) InsertRows(stream pb.TStorage_InsertRowsServer) error { // // For debugging purposes only. // log.Println(\"Metric\", in.Metric) // log.Println(\"Value\", in.Value) // log.Println(\"Timestamp\", in.Timestamp) // log.Println(\"Labels\", in.Labels) // Wait and receieve the stream from the client. for { datum, err := stream.Recv() if err == io.EOF { return stream.SendAndClose(\u0026pb.InsertResponse{ Message: \"Created\", }) } if err != nil { return err } // Generate our labels, if there are any. labels := []tstorage.Label{} for _, label := range datum.Labels { labels = append(labels, tstorage.Label{Name: label.Name, Value: label.Value,}) } // Generate our datapoint. dataPoint := tstorage.DataPoint{Timestamp: datum.Timestamp.Seconds, Value: datum.Value} err = s.storage.InsertRows([]tstorage.Row{ { Metric: datum.Metric, Labels: labels, DataPoint: dataPoint, }, }) } return nil } func (s *TStorageServerImpl) Select(in *pb.Filter, stream pb.TStorage_SelectServer) error { // // For debugging purposes only. // log.Println(\"Metric\", in.Metric) // log.Println(\"Labels\", in.Labels) // log.Println(\"Start\", in.Start.Seconds) // log.Println(\"End\", in.End.Seconds) // Generate our labels, if there are any. labels := []tstorage.Label{} for _, label := range in.Labels { labels = append(labels, tstorage.Label{Name: label.Name, Value: label.Value,}) } points, err := s.storage.Select(in.Metric, labels, in.Start.Seconds, in.End.Seconds) if err != nil { return err } for _, point := range points { ts := \u0026tspb.Timestamp{ Seconds: point.Timestamp, Nanos: 0, } dataPoint := \u0026pb.DataPoint{Value: point.Value, Timestamp: ts,} if err := stream.Send(dataPoint); err != nil { return err } } return nil } Part 7. Client Commands Please create the following blank files:\nProject Hierarchy üìÅ tstorage-server ‚îÇ üìÑ README.md ‚îÇ üìÑ main.go ‚îÇ üìÑ Makefile ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ cmd ‚îÇ | | ‚îî‚îÄ‚îÄ‚îÄüìÑ hello.go | üìÑ insert_row.go (*) | üìÑ insert_rows.go (*) | üìÑ root.go | üìÑ select.go (*) | üìÑ serve.go | üìÑ version.go ‚îÇ ‚îî‚îÄ‚îÄ‚îÄüìÅ internal | ‚îÇ | ‚îî‚îÄ‚îÄüìÑ server_impl.go | üìÑ server.go | ‚îî‚îÄ‚îÄ‚îÄüìÅ proto ‚îÇ ‚îî‚îÄ‚îÄüìÑ tstorage_grpc.pb.go üìÑ tstorage.proto üìÑ tstorage.pb.go Next populate the following:\n(1 of 3) cmd/insert_row.go package cmd // github.com/bartmika/tstorage-server/cmd/insert_row.go import ( \"context\" \"fmt\" \"log\" \"time\" \"github.com/spf13/cobra\" \"google.golang.org/grpc\" // \"google.golang.org/grpc/credentials\" tspb \"github.com/golang/protobuf/ptypes/timestamp\" pb \"github.com/bartmika/tstorage-server/proto\" ) var ( metric string value float64 tsv int64 ) func init() { // The following are required. insertRowCmd.Flags().StringVarP(\u0026metric, \"metric\", \"m\", \"\", \"The metric to attach to the TSD.\") insertRowCmd.MarkFlagRequired(\"metric\") insertRowCmd.Flags().Float64VarP(\u0026value, \"value\", \"v\", 0.00, \"The value to attach to the TSD.\") insertRowCmd.MarkFlagRequired(\"value\") insertRowCmd.Flags().Int64VarP(\u0026tsv, \"timestamp\", \"t\", 0, \"The timestamp to attach to the TSD.\") insertRowCmd.MarkFlagRequired(\"timestamp\") // The following are optional and will have defaults placed when missing. insertRowCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port of our server.\") rootCmd.AddCommand(insertRowCmd) } func doInsertRow() { // Set up a direct connection to the gRPC server. conn, err := grpc.Dial( fmt.Sprintf(\":%v\",port), grpc.WithInsecure(), grpc.WithBlock(), ) if err != nil { log.Fatalf(\"did not connect: %v\", err) } // Set up our protocol buffer interface. client := pb.NewTStorageClient(conn) defer conn.Close() ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() ts := \u0026tspb.Timestamp{ Seconds: tsv, Nanos: 0, } // Generate our labels. labels := []*pb.Label{} labels = append(labels, \u0026pb.Label{Name: \"Source\", Value:\"Command\"}) // Perform our gRPC request. r, err := client.InsertRow(ctx, \u0026pb.TimeSeriesDatum{Labels: labels, Metric: metric, Value: value, Timestamp: ts,}) if err != nil { log.Fatalf(\"could not add: %v\", err) } // Print out the gRPC response. log.Printf(\"Server Response: %s\", r.GetMessage()) } var insertRowCmd = \u0026cobra.Command{ Use: \"insert_row\", Short: \"Insert single datum\", Long: `Connect to the gRPC server and sends a single time-series datum.`, Run: func(cmd *cobra.Command, args []string) { doInsertRow() }, } (2 of 3) cmd/insert_rows.go package cmd // github.com/bartmika/tstorage-server/cmd/insert_rows.go import ( \"context\" \"fmt\" \"log\" \"time\" \"github.com/spf13/cobra\" \"google.golang.org/grpc\" // \"google.golang.org/grpc/credentials\" tspb \"github.com/golang/protobuf/ptypes/timestamp\" pb \"github.com/bartmika/tstorage-server/proto\" ) func init() { // The following are required. insertRowsCmd.Flags().StringVarP(\u0026metric, \"metric\", \"m\", \"\", \"The metric to attach to the TSD.\") insertRowsCmd.MarkFlagRequired(\"metric\") insertRowsCmd.Flags().Float64VarP(\u0026value, \"value\", \"v\", 0.00, \"The value to attach to the TSD.\") insertRowsCmd.MarkFlagRequired(\"value\") insertRowsCmd.Flags().Int64VarP(\u0026tsv, \"timestamp\", \"t\", 0, \"The timestamp to attach to the TSD.\") insertRowsCmd.MarkFlagRequired(\"timestamp\") // The following are optional and will have defaults placed when missing. insertRowsCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port of our server.\") rootCmd.AddCommand(insertRowsCmd) } func doInsertRows() { // Set up a direct connection to the gRPC server. conn, err := grpc.Dial( fmt.Sprintf(\":%v\",port), grpc.WithInsecure(), grpc.WithBlock(), ) if err != nil { log.Fatalf(\"did not connect: %v\", err) } // Set up our protocol buffer interface. client := pb.NewTStorageClient(conn) defer conn.Close() ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() ts := \u0026tspb.Timestamp{ Seconds: tsv, Nanos: 0, } // Generate our labels. labels := []*pb.Label{} labels = append(labels, \u0026pb.Label{Name: \"Source\", Value:\"Command\"}) // Perform our gRPC request. r, err := client.InsertRow(ctx, \u0026pb.TimeSeriesDatum{Labels: labels, Metric: metric, Value: value, Timestamp: ts,}) if err != nil { log.Fatalf(\"could not add: %v\", err) } // Print out the gRPC response. log.Printf(\"Server Response: %s\", r.GetMessage()) } var insertRowsCmd = \u0026cobra.Command{ Use: \"insert_rows\", Short: \"Insert single datum using streaming\", Long: `Connect to the gRPC server and send a time-series datum using the streaming RPC.`, Run: func(cmd *cobra.Command, args []string) { doInsertRows() }, } (3 of 3) cmd/select.go package cmd // github.com/bartmika/tstorage-server/cmd/select.go import ( \"context\" \"fmt\" \"io\" \"log\" \"time\" \"github.com/spf13/cobra\" \"google.golang.org/grpc\" // \"google.golang.org/grpc/credentials\" tspb \"github.com/golang/protobuf/ptypes/timestamp\" pb \"github.com/bartmika/tstorage-server/proto\" ) var ( start int64 end int64 ) func init() { // The following are required. selectCmd.Flags().StringVarP(\u0026metric, \"metric\", \"m\", \"\", \"The metric to filter by\") selectCmd.MarkFlagRequired(\"metric\") selectCmd.Flags().Int64VarP(\u0026start, \"start\", \"s\", 0, \"The start timestamp to begin our range\") selectCmd.MarkFlagRequired(\"start\") selectCmd.Flags().Int64VarP(\u0026end, \"end\", \"e\", 0, \"The end timestamp to finish our range\") selectCmd.MarkFlagRequired(\"end\") // The following are optional and will have defaults placed when missing. selectCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port of our server.\") rootCmd.AddCommand(selectCmd) } func doSelectRow() { // Set up a direct connection to the gRPC server. conn, err := grpc.Dial( fmt.Sprintf(\":%v\",port), grpc.WithInsecure(), grpc.WithBlock(), ) if err != nil { log.Fatalf(\"did not connect: %v\", err) } // Set up our protocol buffer interface. client := pb.NewTStorageClient(conn) defer conn.Close() ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() // Convert the unix timestamp into the protocal buffers timestamp format. sts := \u0026tspb.Timestamp{ Seconds: start, Nanos: 0, } ets := \u0026tspb.Timestamp{ Seconds: end, Nanos: 0, } // Generate our labels. labels := []*pb.Label{} labels = append(labels, \u0026pb.Label{Name: \"Source\", Value:\"Command\"}) // Perform our gRPC request. stream, err := client.Select(ctx, \u0026pb.Filter{Labels: labels, Metric: metric, Start: sts, End: ets,}) if err != nil { log.Fatalf(\"could not select: %v\", err) } // Handle our stream of data from the server. for { dataPoint, err := stream.Recv() if err == io.EOF { break; } if err != nil { log.Fatalf(\"error with stream: %v\", err) } // Print out the gRPC response. log.Printf(\"Server Response: %s\", dataPoint) } } var selectCmd = \u0026cobra.Command{ Use: \"select\", Short: \"List data\", Long: `Connect to the gRPC server and return list of results based on a selection filter.`, Run: func(cmd *cobra.Command, args []string) { doSelectRow() }, } Part 8. Usage Examples Server Start To begin please start the server. For all the sub-commands insert_row, insert_rows, and select to work, this server must be running or else you will get an error.\ngo run main.go serve If you get a message saying:\n2021/07/09 12:48:05 gRPC server is running. Then success!\nInsert Row In a new terminal tab or terminal window, please run the follow:\nInsert a new time series datum, try:\ngo run main.go insert_row --metric=\"Bart\" --value=123.4 --timestamp=1600000001 If you get a response like this then success then you have successfully created a record.\n2021/07/09 23:54:05 Server Response: Created Insert Row (with streams) To verify the client connects and produces the output we want, run the following:\ngo run main.go insert_rows --metric=\"Bart\" --value=123.4 --timestamp=1600000002 If you get a response like this then success!\n2021/07/08 23:54:05 Server Response: Created Select To verify the client connects and produces the output we want, run the following:\ngo run main.go select --metric=\"Bart\" --start=1600000000 --end=1600000006 If you get a response like this then success!\n2021/07/09 00:27:11 Server Response: [value:123.4 timestamp:{seconds:1600000001} value:123.4 timestamp:{seconds:1600000002} value:123.4 timestamp:{seconds:1600000003} value:123.4 timestamp:{seconds:1600000004} value:123.4 timestamp:{seconds:1600000005}] You have successfully wrote a gRPC server overtop a fast time-series database.\n","wordCount":"4032","inLanguage":"en","image":"https://bartlomiejmika.com/img/2021/07-09/harrison-broadbent-nePxBIvqUlU-unsplash.jpg","datePublished":"2021-07-09T23:45:08-04:00","dateModified":"2021-07-09T23:45:08-04:00","author":{"@type":"Person","name":"Bartlomiej Mika"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server/"},"publisher":{"@type":"Organization","name":"Bartlomiej Mika","logo":{"@type":"ImageObject","url":"https://bartlomiejmika.com/img/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bartlomiejmika.com/ accesskey=h title="Bartlomiej Mika (Alt + H)"><img src=https://bartlomiejmika.com/img/bartlomiej_mika.jpeg alt=logo aria-label=logo height=35>Bartlomiej Mika</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bartlomiejmika.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://bartlomiejmika.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://bartlomiejmika.com/pages/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bartlomiejmika.com/>Home</a>&nbsp;¬ª&nbsp;<a href=https://bartlomiejmika.com/posts/>Posts</a></div><h1 class=post-title>How to Build a gRPC Server over tstorage to create tstorage-server</h1><div class=post-meta><span title='2021-07-09 23:45:08 -0400 -0400'>July 9, 2021</span>&nbsp;¬∑&nbsp;19 min&nbsp;¬∑&nbsp;4032 words&nbsp;¬∑&nbsp;Bartlomiej Mika&nbsp;|&nbsp;<a href=https://github.com/bartmika/bartlomiejmika-hugo/tree/master/content/posts/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://bartlomiejmika.com/img/2021/07-09/harrison-broadbent-nePxBIvqUlU-unsplash.jpg alt="Cover photo by [Harrison Broadbent](https://unsplash.com/@harrisonbroadbent) on [Unsplash](https://unsplash.com)."><p>Cover photo by <a href=https://unsplash.com/@harrisonbroadbent>Harrison Broadbent</a> on <a href=https://unsplash.com>Unsplash</a>.</p></figure><div class=post-content><p>Did you just finish reading the <a href=https://grpc.io/docs/languages/go/basics/><strong>gRPC Basics tutorial</strong></a> and you don&rsquo;t know where to begin with using it? In this post I&rsquo;ll explain how to take a fast time-series database called <a href=https://github.com/nakabonne/tstorage><code>tstorage</code></a> and write a gRPC server and client with it.</p><p>Recently I read an article from <a href="https://news.ycombinator.com/item?id=27730854">HackerNews</a> titled <a href=https://nakabonne.dev/posts/write-tsdb-from-scratch/>Write a time-series database engine from scratch</a> where the author, <a href=https://nakabonne.dev/about/>Ryo Nakao</a>, details the lessons he learned from implementing a fast <strong>time-series database</strong> of his own. In the article he mentions that he open sourced it as <a href=https://github.com/nakabonne/tstorage><code>nakabonne/tstorage</code></a>.</p><p>Investigating the <strong>repository</strong>, it looks well thought out and pretty easy to use; as a result, I thought about using it for personal projects. The challenge with the package is <em>interprocess communication</em> (IPC) as I want to have multiple small applications communicate with <code>tstorage</code>.</p><p>To get around the <em>IPC</em> issue, I decide to write a consumable <strong>gRPC service definition</strong> overtop the package so other local or remote applications can use it. I am calling this application <a href=https://github.com/bartmika/tstorage-server><code>tstorage-server</code></a>.</p><p>The purpose of this article is describe how to create a <strong>list</strong>, <strong>create</strong> and <strong>remove</strong> endpoints overtop <code>tstorage</code>. The benefit is if you want to create more <a href=https://grpc.io><code>gRPC</code></a> servers in the future, you can reference this article.</p><p>This article is broken down into the following sections:</p><ul><li>Part 1. Setup the Project</li><li>Part 2. Setup Simple Protocol Buffers</li><li>Part 3. Setup Simple gRPC Server</li><li>Part 4. Setup Simple gRPC Client</li><li>Part 5. Setup <code>tstorage</code> library with our Project |</li><li>Part 6. Server Endpoints</li><li>Part 7. Client Subcommands</li><li>Part 8. Usage examples</li></ul><h2 id=2>Assumptions<a hidden class=anchor aria-hidden=true href=#2>#</a></h2><p>Please note the following:</p><ul><li>Your developer machine is either MacOS or Linux</li><li>You have <code>golang 1.16</code> installed or greater</li><li>You are proficient with <code>git</code> and the <code>terminal</code>.</li><li>You have basic understanding of the Golang language.</li><li>You have a intermediate understanding of <code>gRPC</code>, and if not then please read my previous article title <a href=/posts/2021/example-of-writing-a-simple-grpc-server-in-golang-from-scratch/>&ldquo;Example of Writing a Simple gRPC Server in Golang from Scratch&rdquo;</a> which will get you prepped for this article.</li></ul><h2 id=3>Part 1. Setup the Project<a hidden class=anchor aria-hidden=true href=#3>#</a></h2><p><em>Before writing any business logic, structure the project so it can grow in a logic and predictable manner.</em></p><p>Start off by setting up the an empty <strong>repository</strong> in <a href=https://github.com/bartmika/tstorage-server>github</a> and run the following in your <code>terminal</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/go/src/github.com/bartmika
</span></span><span class=line><span class=cl>git clone https://github.com/bartmika/tstorage-server.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> tstorage-server</span></span></code></pre></div><p>Initialize golang modules.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod init github.com/bartmika/tstorage-server</span></span></code></pre></div><p>Install our project&rsquo;s dependencies.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GO111MODULE</span><span class=o>=</span>on  <span class=c1># Enable module mode</span>
</span></span><span class=line><span class=cl>go get google.golang.org/protobuf/cmd/protoc-gen-go
</span></span><span class=line><span class=cl>go get google.golang.org/grpc/cmd/protoc-gen-go-grpc
</span></span><span class=line><span class=cl>go get google.golang.org/grpc
</span></span><span class=line><span class=cl>go get github.com/golang/protobuf/ptypes/timestamp
</span></span><span class=line><span class=cl>go get github.com/nakabonne/tstorage
</span></span><span class=line><span class=cl>go get github.com/spf13/cobra</span></span></code></pre></div><p>Setup our initial project structure. We will use this structure to grow our application. Please look at the folder and file names in the &ldquo;Project Hierarchy&rdquo; and create them in your computer as blank files.</p><h4 id=project-hierarchy>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>üìÅ tstorage-server
</span></span><span class=line><span class=cl>‚îÇ   üìÑ main.go
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ cmd
</span></span><span class=line><span class=cl>    <span class=p>|</span>
</span></span><span class=line><span class=cl>    ‚îî‚îÄ‚îÄ‚îÄüìÑ root.go
</span></span><span class=line><span class=cl>        üìÑ version.go</span></span></code></pre></div><p>What are going to do? We want our project structured in such a way that it uses the <a href=https://github.com/spf13/cobra><code>spf13/cobra</code></a> package so we can easily commands in our application.</p><p>To begin, please copy and paste the following code into those empty files.</p><h4 id=1-of-3-maingo>(1 of 3) main.go<a hidden class=anchor aria-hidden=true href=#1-of-3-maingo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> <span class=c1>// github.com/bartmika/tstorage-server/main.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/bartmika/tstorage-server/cmd&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=2-of-3-cmdrootgo>(2 of 3) cmd/root.go<a hidden class=anchor aria-hidden=true href=#2-of-3-cmdrootgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/root.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>rootCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;tstorage-server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Time-series data storage gRPC server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span> <span class=s>`The purpose of this application is to provide a local
</span></span></span><span class=line><span class=cl><span class=s>	       database tailored for fast time-series data storage and be
</span></span></span><span class=line><span class=cl><span class=s>		   accessible with remote procedure calls (gRPC).`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Do nothing...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Execute</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rootCmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintln</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=3-of-3-cmdversiongo>(3 of 3) cmd/version.go<a hidden class=anchor aria-hidden=true href=#3-of-3-cmdversiongo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/version.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>versionCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>versionCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;version&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Print the version number&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Print the current version that this server is on.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;tstorage-server v1.0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>Once you finished, in your <code>terminal</code> please write the following.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go run main.go version</span></span></code></pre></div><p>If you setup everything correctly, there should be no errors. Good job!</p><h2 id=4>Part 2. Setup Simple Protocol Buffers<a hidden class=anchor aria-hidden=true href=#4>#</a></h2><p>Now that we have our <strong>application</strong> structured to use <a href=https://github.com/spf13/cobra><code>spf13/cobra</code></a> as our project&rsquo;s scaffolding, we can start by creating our code. We will begin with <strong>protocol buffers</strong>, we need to define a service in <code>.proto</code> file.</p><p>To begin, create the following folders and files in the your project (notice the asterisks for the new files):</p><h4 id=project-hierarchy-1>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>üìÅ tstorage-server
</span></span><span class=line><span class=cl>‚îÇ   üìÑ README.md
</span></span><span class=line><span class=cl>‚îÇ   üìÑ main.go
</span></span><span class=line><span class=cl>‚îÇ   üìÑ Makefile
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ cmd
</span></span><span class=line><span class=cl>‚îÇ   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   ‚îî‚îÄ‚îÄ‚îÄüìÑ root.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ version.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ proto <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl>     ‚îÇ
</span></span><span class=line><span class=cl>     ‚îî‚îÄ‚îÄüìÑ tstorage.proto <span class=o>(</span>*<span class=o>)</span></span></span></code></pre></div><p>Please copy and paste the content of this file.</p><h4 id=1-of-1-prototstorageproto>(1 of 1) proto/tstorage.proto<a hidden class=anchor aria-hidden=true href=#1-of-1-prototstorageproto>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span> <span class=c1>// github.com/bartmika/tstorage-server/proto/tstorage.proto
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/bartmika/tstorage-server&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>proto</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// The greeting service definition.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>service</span> <span class=n>TStorage</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=c1>// Sends a greeting
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// The request message containing the user&#39;s name.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// The response message containing the greetings
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span></span></span></code></pre></div><p>In your <strong>terminal</strong>, make sure we export our path (if you haven‚Äôt done this before) by writing the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$PATH</span><span class=s2>:</span><span class=k>$(</span>go env GOPATH<span class=k>)</span><span class=s2>/bin&#34;</span></span></span></code></pre></div><p>Run the following to generate our new <strong>gRPC interface</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>protoc --go_out<span class=o>=</span>. --go_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative --go-grpc_out<span class=o>=</span>. --go-grpc_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative proto/tstorage.proto</span></span></code></pre></div><p>After running the <strong>command</strong> your structure should look as follows (notice the asterisks). Please look through the new files to get a feel for the code.</p><h4 id=project-hierarchy-2>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy-2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>üìÅ tstorage-server
</span></span><span class=line><span class=cl>‚îÇ   üìÑ README.md
</span></span><span class=line><span class=cl>‚îÇ   üìÑ main.go
</span></span><span class=line><span class=cl>‚îÇ   üìÑ Makefile
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ cmd
</span></span><span class=line><span class=cl>‚îÇ   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   ‚îî‚îÄ‚îÄ‚îÄüìÑ root.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ version.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ proto
</span></span><span class=line><span class=cl>     ‚îÇ
</span></span><span class=line><span class=cl>     ‚îî‚îÄ‚îÄüìÑ tstorage_grpc.pb.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl>        üìÑ tstorage.proto
</span></span><span class=line><span class=cl>        üìÑ tstorage.pb.go <span class=o>(</span>*<span class=o>)</span></span></span></code></pre></div><p>What does this code do?</p><ul><li><strong>tstorage.pb.go</strong>, which contains all the protocol buffer code to populate, serialize, and retrieve request and response message types.</li><li><strong>tstorage_grpc.pb.go</strong>, which contains the following:<ul><li>An interface type (or stub) for clients to call with the methods defined in the TStorage service.</li><li>An interface type for servers to implement, also with the methods defined in the TStorage service.</li></ul></li></ul><h2 id=5>Part 3. Setup Simple gRPC Server<a hidden class=anchor aria-hidden=true href=#5>#</a></h2><p>Please create the following blank files (notice asterisks):</p><h4 id=project-hierarchy-3>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy-3>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>üìÅ tstorage-server
</span></span><span class=line><span class=cl>‚îÇ   üìÑ README.md
</span></span><span class=line><span class=cl>‚îÇ   üìÑ main.go
</span></span><span class=line><span class=cl>‚îÇ   üìÑ Makefile
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ cmd
</span></span><span class=line><span class=cl>‚îÇ   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   ‚îî‚îÄ‚îÄ‚îÄüìÑ root.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ serve.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ version.go
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ internal <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>    ‚îÇ
</span></span><span class=line><span class=cl><span class=p>|</span>    ‚îî‚îÄ‚îÄüìÑ server_impl.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ server.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ proto <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl>     ‚îÇ
</span></span><span class=line><span class=cl>     ‚îî‚îÄ‚îÄüìÑ tstorage_grpc.pb.go
</span></span><span class=line><span class=cl>        üìÑ tstorage.proto
</span></span><span class=line><span class=cl>        üìÑ tstorage.pb.go</span></span></code></pre></div><p>Populate the following</p><h4 id=1-of-3-cmdservego>(1 of 3) cmd/serve.go<a hidden class=anchor aria-hidden=true href=#1-of-3-cmdservego>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/serve.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;syscall&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>server</span> <span class=s>&#34;github.com/bartmika/tstorage-server/internal&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>port</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port to run this server on&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;port&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>serveCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doServe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>server</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// DEVELOPERS CODE:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The following code will create an anonymous goroutine which will have a
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// blocking chan `sigs`. This blocking chan will only unblock when the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// golang app receives a termination command; therfore the anyomous
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// goroutine will run and terminate our running application.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Special Thanks:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (1) https://gobyexample.com/signals
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sigs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>sigs</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;-</span><span class=nx>sigs</span> <span class=c1>// Block execution until signal from terminal gets triggered here.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>server</span><span class=p>.</span><span class=nf>StopMainRuntimeLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=nx>server</span><span class=p>.</span><span class=nf>RunMainRuntimeLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>serveCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serve&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Run the gRPC server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Run the gRPC server to allow other services to access the storage application`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doServe</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=2-of-3-internalservergo>(2 of 3) internal/server.go<a hidden class=anchor aria-hidden=true href=#2-of-3-internalservergo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/tstorage-server/internal/server.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TStorageServer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>port</span><span class=p>:</span> <span class=nx>port</span>
</span></span><span class=line><span class=cl>    <span class=nx>grpcServer</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>Server</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>port</span> <span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>TStorageServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>port</span><span class=p>:</span> <span class=nx>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>grpcServer</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function will consume the main runtime loop and run the business logic
</span></span></span><span class=line><span class=cl><span class=c1>// of the application.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>app</span> <span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=nf>RunMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Open a TCP server to the specified localhost and environment variable
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// specified port number.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>s</span><span class=p>.</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Initialize our gRPC server using our TCP server.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>grpcServer</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Save reference to our application state.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>app</span><span class=p>.</span><span class=nx>grpcServer</span> <span class=p>=</span> <span class=nx>grpcServer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;gRPC server is running.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Block the main runtime loop for accepting and processing gRPC requests.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterTStorageServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>TStorageServerImpl</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=c1>// DEVELOPERS NOTE:
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=c1>// We want to attach to every gRPC call the following variables...
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=p>})</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpcServer</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function will tell the application to stop the main runtime loop when
</span></span></span><span class=line><span class=cl><span class=c1>// the process has been finished.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>app</span> <span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=nf>StopMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Starting graceful shutdown now...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Finish any RPC communication taking place at the moment before
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// shutting down the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>app</span><span class=p>.</span><span class=nx>grpcServer</span><span class=p>.</span><span class=nf>GracefulStop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=3-of-3-internalserver_implgo>(3 of 3) internal/server_impl.go<a hidden class=anchor aria-hidden=true href=#3-of-3-internalserver_implgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/tstorage-server/internal/server_impl.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TStorageServerImpl</span> <span class=kd>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pb</span><span class=p>.</span><span class=nx>TStorageServer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received: %v&#34;</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>{</span><span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Hello &#34;</span> <span class=o>+</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>You now have implemented a basic server.</p><h2 id=6>Part 4. Setup Simple gRPC Client <a hidden class=anchor aria-hidden=true href=#6>#</a></h2><p>Please create the following blank files:</p><h4 id=project-hierarchy-4>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy-4>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>üìÅ tstorage-server
</span></span><span class=line><span class=cl>‚îÇ   üìÑ README.md
</span></span><span class=line><span class=cl>‚îÇ   üìÑ main.go
</span></span><span class=line><span class=cl>‚îÇ   üìÑ Makefile
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ cmd
</span></span><span class=line><span class=cl>‚îÇ   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   ‚îî‚îÄ‚îÄ‚îÄüìÑ hello.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ root.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ serve.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ version.go
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ internal
</span></span><span class=line><span class=cl><span class=p>|</span>    ‚îÇ
</span></span><span class=line><span class=cl><span class=p>|</span>    ‚îî‚îÄ‚îÄüìÑ server_impl.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ server.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ proto
</span></span><span class=line><span class=cl>     ‚îÇ
</span></span><span class=line><span class=cl>     ‚îî‚îÄ‚îÄüìÑ tstorage_grpc.pb.go
</span></span><span class=line><span class=cl>        üìÑ tstorage.proto
</span></span><span class=line><span class=cl>        üìÑ tstorage.pb.go</span></span></code></pre></div><p>Next populate the following:</p><h4 id=cmdhellogo>cmd/hello.go<a hidden class=anchor aria-hidden=true href=#cmdhellogo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/hello.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>name</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;n&#34;</span><span class=p>,</span> <span class=s>&#34;Anonymous&#34;</span><span class=p>,</span> <span class=s>&#34;The name to send the server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;port&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>helloCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doHello</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up a direct connection to the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>port</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up our protocol buffer interface.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewTStorageClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Perform our gRPC request.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not greet: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Print out the gRPC response.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetMessage</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>helloCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;hello&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Send hello message to gRPC server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and send a hello message. Command used to test out that the server is running.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doHello</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Run the following <strong>command</strong> in your <strong>terminal</strong>.</p><pre tabindex=0><code>go run main.go hello --name=&#34;Bart&#34; --port=50051
</code></pre><p>You should get a response as follows:</p><pre tabindex=0><code>2021/07/07 23:22:23 Server Response: Hello Bart
</code></pre><h2 id=7>Part 5. Setup <code>tstorage</code> library with our Project<a hidden class=anchor aria-hidden=true href=#7>#</a></h2><h4 id=1-of-2-cmdservego>(1 of 2) cmd/serve.go<a hidden class=anchor aria-hidden=true href=#1-of-2-cmdservego>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/serve.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;syscall&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>server</span> <span class=s>&#34;github.com/bartmika/tstorage-server/internal&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/bartmika/tstorage-server/utils&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>port</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>dataPath</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>timestampPrecision</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>partitionDurationInHours</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>writeTimeoutInSeconds</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are required.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port to run this server on&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;port&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are optional and will have defaults placed when missing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>dataPath</span><span class=p>,</span> <span class=s>&#34;dataPath&#34;</span><span class=p>,</span> <span class=s>&#34;d&#34;</span><span class=p>,</span> <span class=s>&#34;./tsdb&#34;</span><span class=p>,</span> <span class=s>&#34;The location to save the database files to.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>timestampPrecision</span><span class=p>,</span> <span class=s>&#34;timestampPrecision&#34;</span><span class=p>,</span> <span class=s>&#34;t&#34;</span><span class=p>,</span> <span class=s>&#34;s&#34;</span><span class=p>,</span> <span class=s>&#34;The precision of timestamps to be used by all operations. Options: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>partitionDurationInHours</span><span class=p>,</span> <span class=s>&#34;partitionDurationInHours&#34;</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s>&#34;The timestamp range inside partitions.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>writeTimeoutInSeconds</span><span class=p>,</span> <span class=s>&#34;writeTimeoutInSeconds&#34;</span><span class=p>,</span> <span class=s>&#34;w&#34;</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=s>&#34;The timeout to wait when workers are busy (in seconds).&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Make this sub-command part of our application.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>serveCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doServe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Convert the user inputted integer value to be a `time.Duration` type.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>partitionDuration</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>partitionDurationInHours</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span>
</span></span><span class=line><span class=cl>	<span class=nx>writeTimeout</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>writeTimeoutInSeconds</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Setup our server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>server</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>port</span><span class=p>,</span> <span class=nx>dataPath</span><span class=p>,</span> <span class=nx>timestampPrecision</span><span class=p>,</span> <span class=nx>partitionDuration</span><span class=p>,</span> <span class=nx>writeTimeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// DEVELOPERS CODE:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The following code will create an anonymous goroutine which will have a
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// blocking chan `sigs`. This blocking chan will only unblock when the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// golang app receives a termination command; therfore the anyomous
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// goroutine will run and terminate our running application.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Special Thanks:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (1) https://gobyexample.com/signals
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>sigs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>sigs</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;-</span><span class=nx>sigs</span> <span class=c1>// Block execution until signal from terminal gets triggered here.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>server</span><span class=p>.</span><span class=nf>StopMainRuntimeLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=nx>server</span><span class=p>.</span><span class=nf>RunMainRuntimeLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>serveCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serve&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Run the gRPC server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Run the gRPC server to allow other services to access the storage application`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Defensive code. Make sure the user selected the correct `timestampPrecision`
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// choices before continuing execution of our command.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>okTimestampPrecision</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;ns&#34;</span><span class=p>,</span> <span class=s>&#34;us&#34;</span><span class=p>,</span> <span class=s>&#34;ms&#34;</span><span class=p>,</span> <span class=s>&#34;s&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>okTimestampPrecision</span><span class=p>,</span> <span class=nx>timestampPrecision</span><span class=p>)</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Timestamp precision must be either one of the following: ns, us, ms, or s.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Execute our command with our validated inputs.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nf>doServe</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=2-of-2-internalservergo>(2 of 2) internal/server.go<a hidden class=anchor aria-hidden=true href=#2-of-2-internalservergo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/tstorage-server/internal/server.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/nakabonne/tstorage&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TStorageServer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>port</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>    <span class=nx>dataPath</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestampPrecision</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>TimestampPrecision</span>
</span></span><span class=line><span class=cl>    <span class=nx>partitionDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>    <span class=nx>writeTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>    <span class=nx>storage</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Storage</span>
</span></span><span class=line><span class=cl>    <span class=nx>grpcServer</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>Server</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>port</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>dataPath</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>timestampPrecision</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>partitionDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span> <span class=nx>writeTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Conver to the format that is accepted by the library.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>var</span> <span class=nx>tsp</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>TimestampPrecision</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>timestampPrecision</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s>&#34;ns&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>tsp</span> <span class=p>=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Nanoseconds</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s>&#34;us&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>tsp</span> <span class=p>=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Microseconds</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s>&#34;ms&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>tsp</span> <span class=p>=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Milliseconds</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=s>&#34;s&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>tsp</span> <span class=p>=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Seconds</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>TStorageServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>port</span><span class=p>:</span> <span class=nx>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>dataPath</span><span class=p>:</span> <span class=nx>dataPath</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>timestampPrecision</span><span class=p>:</span> <span class=nx>tsp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>partitionDuration</span><span class=p>:</span> <span class=nx>partitionDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>writeTimeout</span><span class=p>:</span> <span class=nx>writeTimeout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>storage</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>grpcServer</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function will consume the main runtime loop and run the business logic
</span></span></span><span class=line><span class=cl><span class=c1>// of the application.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=nf>RunMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Open a TCP server to the specified localhost and environment variable
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// specified port number.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>s</span><span class=p>.</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Initialize our gRPC server using our TCP server.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>grpcServer</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Initialize our fast time-series database.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>storage</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>tstorage</span><span class=p>.</span><span class=nf>WithDataPath</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>dataPath</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>tstorage</span><span class=p>.</span><span class=nf>WithTimestampPrecision</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>timestampPrecision</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>tstorage</span><span class=p>.</span><span class=nf>WithPartitionDuration</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>partitionDuration</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>tstorage</span><span class=p>.</span><span class=nf>WithWriteTimeout</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>writeTimeout</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Save reference to our application state.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>s</span><span class=p>.</span><span class=nx>grpcServer</span> <span class=p>=</span> <span class=nx>grpcServer</span>
</span></span><span class=line><span class=cl>   <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span> <span class=p>=</span> <span class=nx>storage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;gRPC server is running.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Block the main runtime loop for accepting and processing gRPC requests.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterTStorageServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>TStorageServerImpl</span><span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=c1>// DEVELOPERS NOTE:
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=c1>// We want to attach to every gRPC call the following variables...
</span></span></span><span class=line><span class=cl><span class=c1></span>       <span class=nx>storage</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=p>})</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpcServer</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function will tell the application to stop the main runtime loop when
</span></span></span><span class=line><span class=cl><span class=c1>// the process has been finished.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=nf>StopMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Starting graceful shutdown now...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Finish our database operations running.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Finish any RPC communication taking place at the moment before
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// shutting down the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>s</span><span class=p>.</span><span class=nx>grpcServer</span><span class=p>.</span><span class=nf>GracefulStop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=8>Part 6. Server Endpoints<a hidden class=anchor aria-hidden=true href=#8>#</a></h2><p>Please override the following files.</p><h4 id=1-of-2-prototstorageproto>(1 of 2) proto/tstorage.proto<a hidden class=anchor aria-hidden=true href=#1-of-2-prototstorageproto>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span> <span class=c1>// github.com/bartmika/tstorage-server/proto/tstorage.proto
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/bartmika/tstorage-server&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>proto</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;google/protobuf/timestamp.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// The tstorage service definition.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>service</span> <span class=n>TStorage</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>InsertRow</span> <span class=p>(</span><span class=n>TimeSeriesDatum</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>InsertResponse</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>InsertRows</span> <span class=p>(</span><span class=n>stream</span> <span class=n>TimeSeriesDatum</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>InsertResponse</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>Select</span> <span class=p>(</span><span class=n>Filter</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>stream</span> <span class=n>DataPoint</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// --- HELLO ENDPOINT ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// The request message containing the user&#39;s name.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// The response message containing the greetings
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// --- COMMON TO ALL ENDPOINTS ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>DataPoint</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>double</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Label</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>TimeSeriesDatum</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>metric</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>repeated</span> <span class=n>Label</span> <span class=n>labels</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>double</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// --- INSERT ENDPOINT ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>InsertResponse</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>bool</span> <span class=n>status</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// --- SELECT ENDPOINT ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Filter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>metric</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>repeated</span> <span class=n>Label</span> <span class=n>labels</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>start</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>end</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>SelectResponse</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>repeated</span> <span class=n>DataPoint</span> <span class=n>points</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><p>In your <strong>terminal</strong> please write the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>protoc --go_out<span class=o>=</span>.      --go_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       --go-grpc_out<span class=o>=</span>. --go-grpc_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  proto/tstorage.proto
</span></span></code></pre></div><p>Afterwards update the following file:</p><h4 id=2-of-2-githubcombartmikatstorage-serverinternalserver_implgo>(2 of 2) github.com/bartmika/tstorage-server/internal/server_impl.go<a hidden class=anchor aria-hidden=true href=#2-of-2-githubcombartmikatstorage-serverinternalserver_implgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s>&#34;github.com/nakabonne/tstorage&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>tspb</span> <span class=s>&#34;github.com/golang/protobuf/ptypes/timestamp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TStorageServerImpl</span> <span class=kd>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>storage</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Storage</span>
</span></span><span class=line><span class=cl>    <span class=nx>pb</span><span class=p>.</span><span class=nx>TStorageServer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received: %v&#34;</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>{</span><span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Hello &#34;</span> <span class=o>+</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>InsertRow</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>InsertResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Metric&#34;, in.Metric)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Value&#34;, in.Value)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Timestamp&#34;, in.Timestamp)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Labels&#34;, in.Labels)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Generate our labels, if there are any.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>label</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Labels</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Value</span><span class=p>,})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Generate our datapoint.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>dataPoint</span> <span class=o>:=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>DataPoint</span><span class=p>{</span><span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nx>Seconds</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Value</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>InsertRows</span><span class=p>([]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Row</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=p>{</span>
</span></span><span class=line><span class=cl>		    <span class=nx>Metric</span><span class=p>:</span>    <span class=nx>in</span><span class=p>.</span><span class=nx>Metric</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		    <span class=nx>Labels</span><span class=p>:</span>    <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		    <span class=nx>DataPoint</span><span class=p>:</span> <span class=nx>dataPoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>InsertResponse</span><span class=p>{</span><span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Created&#34;</span><span class=p>},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>InsertRows</span><span class=p>(</span><span class=nx>stream</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>TStorage_InsertRowsServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Metric&#34;, in.Metric)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Value&#34;, in.Value)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Timestamp&#34;, in.Timestamp)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Labels&#34;, in.Labels)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Wait and receieve the stream from the client.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>datum</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>SendAndClose</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>InsertResponse</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Created&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Generate our labels, if there are any.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>label</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>Labels</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Value</span><span class=p>,})</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// Generate our datapoint.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>dataPoint</span> <span class=o>:=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>DataPoint</span><span class=p>{</span><span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nx>Seconds</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>Value</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>err</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>InsertRows</span><span class=p>([]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Row</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    	    <span class=p>{</span>
</span></span><span class=line><span class=cl>    		    <span class=nx>Metric</span><span class=p>:</span>    <span class=nx>datum</span><span class=p>.</span><span class=nx>Metric</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    		    <span class=nx>Labels</span><span class=p>:</span>    <span class=nx>labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    		    <span class=nx>DataPoint</span><span class=p>:</span> <span class=nx>dataPoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    	    <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>Select</span><span class=p>(</span><span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Filter</span><span class=p>,</span> <span class=nx>stream</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>TStorage_SelectServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// // For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Metric&#34;, in.Metric)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Labels&#34;, in.Labels)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;Start&#34;, in.Start.Seconds)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// log.Println(&#34;End&#34;, in.End.Seconds)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// Generate our labels, if there are any.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>label</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Labels</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Value</span><span class=p>,})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>points</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=nx>in</span><span class=p>.</span><span class=nx>Metric</span><span class=p>,</span> <span class=nx>labels</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Start</span><span class=p>.</span><span class=nx>Seconds</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nx>End</span><span class=p>.</span><span class=nx>Seconds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>point</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>points</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>ts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>point</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    	<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>dataPoint</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>DataPoint</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span> <span class=nx>point</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>ts</span><span class=p>,}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>dataPoint</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=9>Part 7. Client Commands<a hidden class=anchor aria-hidden=true href=#9>#</a></h2><p>Please create the following blank files:</p><h4 id=project-hierarchy-5>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy-5>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>üìÅ tstorage-server
</span></span><span class=line><span class=cl>‚îÇ   üìÑ README.md
</span></span><span class=line><span class=cl>‚îÇ   üìÑ main.go
</span></span><span class=line><span class=cl>‚îÇ   üìÑ Makefile
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ cmd
</span></span><span class=line><span class=cl>‚îÇ   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   ‚îî‚îÄ‚îÄ‚îÄüìÑ hello.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ insert_row.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ insert_rows.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ root.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ <span class=k>select</span>.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ serve.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ version.go
</span></span><span class=line><span class=cl>‚îÇ
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ internal
</span></span><span class=line><span class=cl><span class=p>|</span>    ‚îÇ
</span></span><span class=line><span class=cl><span class=p>|</span>    ‚îî‚îÄ‚îÄüìÑ server_impl.go
</span></span><span class=line><span class=cl><span class=p>|</span>       üìÑ server.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ‚îÄüìÅ proto
</span></span><span class=line><span class=cl>     ‚îÇ
</span></span><span class=line><span class=cl>     ‚îî‚îÄ‚îÄüìÑ tstorage_grpc.pb.go
</span></span><span class=line><span class=cl>        üìÑ tstorage.proto
</span></span><span class=line><span class=cl>        üìÑ tstorage.pb.go</span></span></code></pre></div><p>Next populate the following:</p><h4 id=1-of-3-cmdinsert_rowgo>(1 of 3) cmd/insert_row.go<a hidden class=anchor aria-hidden=true href=#1-of-3-cmdinsert_rowgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/insert_row.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>tspb</span> <span class=s>&#34;github.com/golang/protobuf/ptypes/timestamp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>metric</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>value</span> <span class=kt>float64</span>
</span></span><span class=line><span class=cl>	<span class=nx>tsv</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are required.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metric</span><span class=p>,</span> <span class=s>&#34;metric&#34;</span><span class=p>,</span> <span class=s>&#34;m&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;The metric to attach to the TSD.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;metric&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Float64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>value</span><span class=p>,</span> <span class=s>&#34;value&#34;</span><span class=p>,</span> <span class=s>&#34;v&#34;</span><span class=p>,</span> <span class=mf>0.00</span><span class=p>,</span> <span class=s>&#34;The value to attach to the TSD.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Int64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>tsv</span><span class=p>,</span> <span class=s>&#34;timestamp&#34;</span><span class=p>,</span> <span class=s>&#34;t&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;The timestamp to attach to the TSD.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;timestamp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are optional and will have defaults placed when missing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>insertRowCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doInsertRow</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up a direct connection to the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>port</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up our protocol buffer interface.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewTStorageClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>tsv</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Generate our labels.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Source&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span><span class=s>&#34;Command&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Perform our gRPC request.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>InsertRow</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>{</span><span class=nx>Labels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span> <span class=nx>Metric</span><span class=p>:</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>ts</span><span class=p>,})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not add: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Print out the gRPC response.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetMessage</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>insertRowCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;insert_row&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Insert single datum&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and sends a single time-series datum.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doInsertRow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=2-of-3-cmdinsert_rowsgo>(2 of 3) cmd/insert_rows.go<a hidden class=anchor aria-hidden=true href=#2-of-3-cmdinsert_rowsgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/insert_rows.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>tspb</span> <span class=s>&#34;github.com/golang/protobuf/ptypes/timestamp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are required.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metric</span><span class=p>,</span> <span class=s>&#34;metric&#34;</span><span class=p>,</span> <span class=s>&#34;m&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;The metric to attach to the TSD.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;metric&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Float64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>value</span><span class=p>,</span> <span class=s>&#34;value&#34;</span><span class=p>,</span> <span class=s>&#34;v&#34;</span><span class=p>,</span> <span class=mf>0.00</span><span class=p>,</span> <span class=s>&#34;The value to attach to the TSD.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Int64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>tsv</span><span class=p>,</span> <span class=s>&#34;timestamp&#34;</span><span class=p>,</span> <span class=s>&#34;t&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;The timestamp to attach to the TSD.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;timestamp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are optional and will have defaults placed when missing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>insertRowsCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doInsertRows</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up a direct connection to the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>port</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up our protocol buffer interface.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewTStorageClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>tsv</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Generate our labels.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Source&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span><span class=s>&#34;Command&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Perform our gRPC request.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>InsertRow</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>{</span><span class=nx>Labels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span> <span class=nx>Metric</span><span class=p>:</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>ts</span><span class=p>,})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not add: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Print out the gRPC response.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetMessage</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>insertRowsCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;insert_rows&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Insert single datum using streaming&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and send a time-series datum using the streaming RPC.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doInsertRows</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=3-of-3-cmdselectgo>(3 of 3) cmd/select.go<a hidden class=anchor aria-hidden=true href=#3-of-3-cmdselectgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/select.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;io&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>tspb</span> <span class=s>&#34;github.com/golang/protobuf/ptypes/timestamp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>start</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>end</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are required.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metric</span><span class=p>,</span> <span class=s>&#34;metric&#34;</span><span class=p>,</span> <span class=s>&#34;m&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;The metric to filter by&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;metric&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Int64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>start</span><span class=p>,</span> <span class=s>&#34;start&#34;</span><span class=p>,</span> <span class=s>&#34;s&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;The start timestamp to begin our range&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;start&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Int64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>end</span><span class=p>,</span> <span class=s>&#34;end&#34;</span><span class=p>,</span> <span class=s>&#34;e&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;The end timestamp to finish our range&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;end&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are optional and will have defaults placed when missing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>selectCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doSelectRow</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up a direct connection to the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>port</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up our protocol buffer interface.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewTStorageClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Convert the unix timestamp into the protocal buffers timestamp format.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>start</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>ets</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>end</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Generate our labels.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Source&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span><span class=s>&#34;Command&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Perform our gRPC request.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>stream</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Filter</span><span class=p>{</span><span class=nx>Labels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span> <span class=nx>Metric</span><span class=p>:</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>Start</span><span class=p>:</span> <span class=nx>sts</span><span class=p>,</span> <span class=nx>End</span><span class=p>:</span> <span class=nx>ets</span><span class=p>,})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not select: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Handle our stream of data from the server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>dataPoint</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error with stream: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Print out the gRPC response.
</span></span></span><span class=line><span class=cl><span class=c1></span>	    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>dataPoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>selectCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;select&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;List data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and return list of results based on a selection filter.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doSelectRow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=10>Part 8. Usage Examples<a hidden class=anchor aria-hidden=true href=#10>#</a></h2><h3 id=server-start>Server Start<a hidden class=anchor aria-hidden=true href=#server-start>#</a></h3><p>To begin please start the server. For all the sub-commands <code>insert_row</code>, <code>insert_rows</code>, and <code>select</code> to work, this server must be running or else you will get an error.</p><pre tabindex=0><code>go run main.go serve
</code></pre><p>If you get a message saying:</p><pre tabindex=0><code>2021/07/09 12:48:05 gRPC server is running.
</code></pre><p>Then success!</p><h3 id=insert-row>Insert Row<a hidden class=anchor aria-hidden=true href=#insert-row>#</a></h3><p>In a new <strong>terminal tab</strong> or <strong>terminal window</strong>, please run the follow:</p><p>Insert a new time series datum, try:</p><pre tabindex=0><code>go run main.go insert_row --metric=&#34;Bart&#34; --value=123.4 --timestamp=1600000001
</code></pre><p>If you get a response like this then success then you have successfully created a record.</p><pre tabindex=0><code>2021/07/09 23:54:05 Server Response: Created
</code></pre><h3 id=insert-row-with-streams>Insert Row (with streams)<a hidden class=anchor aria-hidden=true href=#insert-row-with-streams>#</a></h3><p>To verify the client connects and produces the output we want, run the following:</p><pre tabindex=0><code>go run main.go insert_rows --metric=&#34;Bart&#34; --value=123.4 --timestamp=1600000002
</code></pre><p>If you get a response like this then success!</p><pre tabindex=0><code>2021/07/08 23:54:05 Server Response: Created
</code></pre><h3 id=select>Select<a hidden class=anchor aria-hidden=true href=#select>#</a></h3><p>To verify the client connects and produces the output we want, run the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go run main.go <span class=k>select</span> --metric<span class=o>=</span><span class=s2>&#34;Bart&#34;</span> --start<span class=o>=</span><span class=m>1600000000</span> --end<span class=o>=</span><span class=m>1600000006</span>
</span></span></code></pre></div><p>If you get a response like this then success!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>2021/07/09 00:27:11 Server Response: <span class=o>[</span>value:123.4  timestamp:<span class=o>{</span>seconds:1600000001<span class=o>}</span> value:123.4  timestamp:<span class=o>{</span>seconds:1600000002<span class=o>}</span> value:123.4  timestamp:<span class=o>{</span>seconds:1600000003<span class=o>}</span> value:123.4  timestamp:<span class=o>{</span>seconds:1600000004<span class=o>}</span> value:123.4  timestamp:<span class=o>{</span>seconds:1600000005<span class=o>}]</span>
</span></span></code></pre></div><p>You have successfully wrote a <a href=https://grpc.io><code>gRPC</code></a> server overtop a fast time-series database.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bartlomiejmika.com/tags/grpc/>gRPC</a></li><li><a href=https://bartlomiejmika.com/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://bartlomiejmika.com/posts/2021/docker-learning-resources-for-absolute-beginners-programming-with-golang/><span class=title>¬´ Prev</span><br><span>Docker Learning Resources for Absolute Beginners Programming With Golang</span></a>
<a class=next href=https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/><span class=title>Next ¬ª</span><br><span>How to Build a gRPC Server for a SparkFun Weather Shield</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server over tstorage to create tstorage-server on twitter" href="https://twitter.com/intent/tweet/?text=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f&hashtags=gRPC%2cGolang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server over tstorage to create tstorage-server on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f&title=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server&summary=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server&source=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server over tstorage to create tstorage-server on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f&title=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server over tstorage to create tstorage-server on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server over tstorage to create tstorage-server on whatsapp" href="https://api.whatsapp.com/send?text=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server%20-%20https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server over tstorage to create tstorage-server on telegram" href="https://telegram.me/share/url?text=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://bartlomiejmika.com/>Bartlomiej Mika</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>