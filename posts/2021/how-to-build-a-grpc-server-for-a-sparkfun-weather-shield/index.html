<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Build a gRPC Server for a SparkFun Weather Shield | Bartlomiej Mika</title><meta name=keywords content="IoT,gRPC,Golang"><meta name=description content="We will take what we learned in the previous post and rewrite it to support interprocess communication of our SparkFun Weather Shield from other applications using the gRPC."><meta name=author content="Bartlomiej Mika"><link rel=canonical href=https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/><meta name=google-site-verification content="UA-172742383-1"><link crossorigin=anonymous href=/assets/css/stylesheet.8b523f1730c922e314350296d83fd666efa16519ca136320a93df674d00b6325.css integrity="sha256-i1I/FzDJIuMUNQKW2D/WZu+hZRnKE2MgqT32dNALYyU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://bartlomiejmika.com/img/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://bartlomiejmika.com/img/favicon.ico><link rel=apple-touch-icon href=https://bartlomiejmika.com/img/favicon.ico><link rel=mask-icon href=https://bartlomiejmika.com/img/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-172742383-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="How to Build a gRPC Server for a SparkFun Weather Shield"><meta property="og:description" content="We will take what we learned in the previous post and rewrite it to support interprocess communication of our SparkFun Weather Shield from other applications using the gRPC."><meta property="og:type" content="article"><meta property="og:url" content="https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/"><meta property="og:image" content="https://bartlomiejmika.com/img/2021/03-27/grpc.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-09T18:35:46-04:00"><meta property="article:modified_time" content="2021-07-09T18:35:46-04:00"><meta property="og:site_name" content="Bartlomiej Mika"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bartlomiejmika.com/img/2021/03-27/grpc.jpg"><meta name=twitter:title content="How to Build a gRPC Server for a SparkFun Weather Shield"><meta name=twitter:description content="We will take what we learned in the previous post and rewrite it to support interprocess communication of our SparkFun Weather Shield from other applications using the gRPC."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://bartlomiejmika.com/posts/"},{"@type":"ListItem","position":2,"name":"How to Build a gRPC Server for a SparkFun Weather Shield","item":"https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Build a gRPC Server for a SparkFun Weather Shield","name":"How to Build a gRPC Server for a SparkFun Weather Shield","description":"We will take what we learned in the previous post and rewrite it to support interprocess communication of our SparkFun Weather Shield from other applications using the gRPC.\n","keywords":["IoT","gRPC","Golang"],"articleBody":"We will take what we learned in the previous post and rewrite it to support interprocess communication of our SparkFun Weather Shield from other applications using the gRPC.\nSetup a Basic gRPC Server Before writing any business logic, start off by building the project scaffolding. The scaffolding we will use is found if you read the gRPC Basics tutorial. Our goal is to create a simple RPC server which we can call with a client; afterwords, we’ll focus on writing our business logic. If you don’t know anything about gRPC then checkout this we article on gRPC basics.\nStart off by setting up the an empty repository in github and run the following in your terminal:\ncd ~/go/src/github.com/bartmika git clone https://github.com/bartmika/serialreader-server.git cd serialreader-server Initialize golang modules.\ngo mod init github.com/bartmika/serialreader-server Install our project’s dependencies.\nexport GO111MODULE=on # Enable module mode go get google.golang.org/protobuf/cmd/protoc-gen-go go get google.golang.org/grpc/cmd/protoc-gen-go-grpc go get google.golang.org/grpc go get github.com/golang/protobuf/ptypes/timestamp go get github.com/spf13/cobra go get github.com/tarm/serial Setup our initial project structure. We will use this structure to grow our application. Please look at the folder and file names in the “Project Hierarchy” and create them in your computer as blank files.\nProject Hierarchy 📁 serialreader-server │ 📄 main.go │ └───📁 cmd | | | └───📄 hello.go | 📄 root.go | 📄 serve.go | 📄 version.go | └───📁 internal | | | └───📄 server_impl.go | 📄 server.go | └───📁 proto | └───📄 serialreader.proto What are going to do? We want our project structured in such a way that it uses the spf13/cobra package so we can easily commands in our application.\nPlease copy and paste the following code into those empty files.\n(1 of 8) main.go package main // github.com/bartmika/serialreader-server/main.go import ( \"github.com/bartmika/serialreader-server/cmd\" ) func main() { cmd.Execute() } (2 of 8) cmd/root.go package cmd // github.com/bartmika/serialreader-server/cmd/root.go import ( \"fmt\" \"os\" \"github.com/spf13/cobra\" ) var rootCmd = \u0026cobra.Command{ Use: \"serialreader-server\", Short: \"Serve time-series data\", Long: `Serve time-series data from a connected Arduino device with an attached 'SparkFun Weather Shield' device over gRPC.`, Run: func(cmd *cobra.Command, args []string) { // Do nothing... }, } func Execute() { if err := rootCmd.Execute(); err != nil { fmt.Fprintln(os.Stderr, err) os.Exit(1) } } (3 of 8) cmd/version.go package cmd // github.com/bartmika/serialreader-server/cmd/version.go import ( \"fmt\" \"github.com/spf13/cobra\" ) func init() { rootCmd.AddCommand(versionCmd) } var versionCmd = \u0026cobra.Command{ Use: \"version\", Short: \"Print the version number\", Long: `Print the current version that this server is on.`, Run: func(cmd *cobra.Command, args []string) { fmt.Println(\"serialreader-server v1.0\") }, } (4 of 8) proto/serialreader.proto syntax = \"proto3\"; // github.com/bartmika/serialreader-server/proto/serialreader.proto option go_package = \"github.com/bartmika/serialreader-server\"; package proto; service SerialReader { rpc SayHello (HelloRequest) returns (HelloReply) {} } // --- HELLO ENDPOINT --- // The request message containing the user's name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } (5 of 8) internal/server.go package internal // github.com/bartmika/serialreader-server/internal/server.go import ( \"fmt\" \"log\" \"net\" \"google.golang.org/grpc\" pb \"github.com/bartmika/serialreader-server/proto\" ) type SerialReaderServer struct { port int grpcServer *grpc.Server } func New(port int) *SerialReaderServer { return \u0026SerialReaderServer{ port: port, grpcServer: nil, } } // Function will consume the main runtime loop and run the business logic // of the application. func (s *SerialReaderServer) RunMainRuntimeLoop() { // Open a TCP server to the specified localhost and environment variable // specified port number. lis, err := net.Listen(\"tcp\", fmt.Sprintf(\":%v\", s.port)) if err != nil { log.Fatalf(\"failed to listen: %v\", err) } // Initialize our gRPC server using our TCP server. grpcServer := grpc.NewServer() // Save reference to our application state. s.grpcServer = grpcServer // For debugging purposes only. log.Printf(\"gRPC server is running.\") // Block the main runtime loop for accepting and processing gRPC requests. pb.RegisterSerialReaderServer(grpcServer, \u0026SerialReaderServerImpl{ // DEVELOPERS NOTE: // We want to attach to every gRPC call the following variables... // ... }) if err := grpcServer.Serve(lis); err != nil { log.Fatalf(\"failed to serve: %v\", err) } } // Function will tell the application to stop the main runtime loop when // the process has been finished. func (s *SerialReaderServer) StopMainRuntimeLoop() { log.Printf(\"Starting graceful shutdown now...\") // Finish any RPC communication taking place at the moment before // shutting down the gRPC server. s.grpcServer.GracefulStop() } (6 of 8) internal/server_impl.go package internal // github.com/bartmika/serialreader-server/internal/server_impl.go import ( \"context\" \"log\" pb \"github.com/bartmika/serialreader-server/proto\" ) type SerialReaderServerImpl struct { pb.SerialReaderServer } func (s *SerialReaderServerImpl) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) { log.Printf(\"Received: %v\", in.GetName()) return \u0026pb.HelloReply{Message: \"Hello \" + in.GetName()}, nil } (7 of 8) cmd/serve.go package cmd // github.com/bartmika/serialreader-server/cmd/serve.go import ( \"os\" \"os/signal\" \"syscall\" \"github.com/spf13/cobra\" server \"github.com/bartmika/serialreader-server/internal\" ) var ( port int ) func init() { // The following are optional and will have defaults placed when missing. serveCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port to run this server on\") // Make this sub-command part of our application. rootCmd.AddCommand(serveCmd) } func doServe() { // Setup our server. server := server.New(port) // DEVELOPERS CODE: // The following code will create an anonymous goroutine which will have a // blocking chan `sigs`. This blocking chan will only unblock when the // golang app receives a termination command; therfore the anyomous // goroutine will run and terminate our running application. // // Special Thanks: // (1) https://gobyexample.com/signals // (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html // sigs := make(chan os.Signal, 1) signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM) go func() { \u003c-sigs // Block execution until signal from terminal gets triggered here. server.StopMainRuntimeLoop() }() server.RunMainRuntimeLoop() } var serveCmd = \u0026cobra.Command{ Use: \"serve\", Short: \"Run the gRPC server\", Long: `Run the gRPC server to allow other services to access the serial reader`, Run: func(cmd *cobra.Command, args []string) { doServe() }, } (8 of 8) cmd/hello.go package cmd // github.com/bartmika/serialreader-server/cmd/hello.go import ( \"context\" \"fmt\" \"log\" \"time\" \"github.com/spf13/cobra\" \"google.golang.org/grpc\" // \"google.golang.org/grpc/credentials\" pb \"github.com/bartmika/serialreader-server/proto\" ) var ( name string ) func init() { // The following are required. helloCmd.Flags().StringVarP(\u0026name, \"name\", \"n\", \"Anonymous\", \"The name to send the server.\") helloCmd.MarkFlagRequired(\"name\") // The following are optional and will have defaults placed when missing. helloCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port of our server.\") rootCmd.AddCommand(helloCmd) } func doHello() { // Set up a direct connection to the gRPC server. conn, err := grpc.Dial( fmt.Sprintf(\":%v\", port), grpc.WithInsecure(), grpc.WithBlock(), ) if err != nil { log.Fatalf(\"did not connect: %v\", err) } // Set up our protocol buffer interface. client := pb.NewSerialReaderClient(conn) defer conn.Close() ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() // Perform our gRPC request. r, err := client.SayHello(ctx, \u0026pb.HelloRequest{Name: name}) if err != nil { log.Fatalf(\"could not greet: %v\", err) } // Print out the gRPC response. log.Printf(\"Server Response: %s\", r.GetMessage()) } var helloCmd = \u0026cobra.Command{ Use: \"hello\", Short: \"Send hello message to gRPC server\", Long: `Connect to the gRPC server and send a hello message. Command used to test out that the server is running.`, Run: func(cmd *cobra.Command, args []string) { doHello() }, } Usage of the Basic gRPC Server In your primary terminal, please run the server by entering the following command:\ngo run main.go serve You should see something like this:\nIf you see this then you have successfully setup the basic gRPC server. In a another terminal window or tab, please execute the following command to verify our server is working.\ngo run main.go hello --name=\"Bartlomiej\" You should see something like this:\nGood stuff, our server works! Now let’s build a gRPC service definition over our serial reader.\nIntegrate the SparkFun Weather Shield Reader Before we begin, I am assuming you have successfully read through our previous article before continuing. If you did not the next steps will note make sense.\nTake a look at the following folder structure and create the necessary empty files:\nProject Hierarchy 📁 serialreader-server │ 📄 main.go │ └───📁 cmd | | | └───📄 get_data.go (*) | 📄 hello.go | 📄 root.go | 📄 serve.go | 📄 version.go | └───📁 internal | | | └───📄 arduino_reader.go (*) | 📄 server_impl.go | 📄 server.go | └───📁 proto | └───📄 serialreader.proto Notice the asterisks (*), those are the new files you will need to create.\nPlease copy and paste the following files. It’s important to note you need to override the entire file when pasting!\n(1 of 6) proto/serialreader.proto syntax = \"proto3\"; // github.com/bartmika/serialreader-server/proto/serialreader.proto option go_package = \"github.com/bartmika/serialreader-server\"; package proto; import \"google/protobuf/timestamp.proto\"; service SerialReader { rpc SayHello (HelloRequest) returns (HelloReply) {} rpc GetSparkFunWeatherShieldData (GetTimeSeriesData) returns (SparkFunWeatherShieldTimeSeriesData) {} } // --- HELLO ENDPOINT --- // The request message containing the user's name. message HelloRequest { string name = 1; } // The response message containing the greetings message HelloReply { string message = 1; } // --- POLLING ENDPOINT --- message GetTimeSeriesData {} message SparkFunWeatherShieldTimeSeriesData { bool status = 1; google.protobuf.Timestamp timestamp = 2; float humidityValue = 3; string humidityUnit = 4; float temperatureValue = 5; string temperatureUnit = 6; float pressureValue = 7; string pressureUnit = 8; float temperatureBackupValue = 9; string temperatureBackupUnit = 10; float altitudeValue = 11; string altitudeUnit = 12; float illuminanceValue = 13; string illuminanceUnit = 14; float soilMoistureValue = 15; string soilMoistureUnit = 16; } (2 of 6) internal/arduino_reader.go package internal // github.com/bartmika/serialreader-server/internal/arduino_reader.go import ( \"fmt\" \"encoding/json\" \"log\" \"time\" \"github.com/tarm/serial\" ) const RX_BYTE = \"1\" // The time-series data structure used to store all the data that will be // returned by the `SparkFun Weather Shield` Arduino device. type TimeSeriesData struct { Status string `json:\"status,omitempty\"` Runtime int `json:\"runtime,omitempty\"` Id int `json:\"id,omitempty\"` HumidityValue float32 `json:\"humidity_value,omitempty\"` HumidityUnit string `json:\"humidity_unit,omitempty\"` TemperatureValue float32 `json:\"temperature_primary_value,omitempty\"` TemperatureUnit string `json:\"temperature_primary_unit,omitempty\"` PressureValue float32 `json:\"pressure_value,omitempty\"` PressureUnit string `json:\"pressure_unit,omitempty\"` TemperatureBackupValue float32 `json:\"temperature_secondary_value,omitempty\"` TemperatureBackupUnit string `json:\"temperature_secondary_unit,omitempty\"` AltitudeValue float32 `json:\"altitude_value,omitempty\"` AltitudeUnit string `json:\"altitude_unit,omitempty\"` IlluminanceValue float32 `json:\"illuminance_value,omitempty\"` IlluminanceUnit string `json:\"illuminance_unit,omitempty\"` Timestamp int64 `json:\"timestamp,omitempty\"` } // The abstraction of the `SparkFun Weather Shield` reader. type ArduinoReader struct { serialPort *serial.Port } // Constructor used to intialize the serial reader designed to communicate // with Arduino configured for the `SparkFun Weather Shield` settings. func NewArduinoReader(devicePath string) *ArduinoReader { log.Printf(\"READER: Attempting to connect Arduino device...\") c := \u0026serial.Config{Name: devicePath, Baud: 9600} s, err := serial.OpenPort(c) if err != nil { log.Fatal(err) } // DEVELOPERS NOTE: // The following code will warm up the Arduino device before we are // able to make calls to the external sensors. log.Printf(\"READER: Waiting for Arduino external sensors to warm up\") ar := \u0026ArduinoReader{serialPort: s} ar.GetSparkFunWeatherShieldData() time.Sleep(5 * time.Second) ar.GetSparkFunWeatherShieldData() time.Sleep(5 * time.Second) return ar } // Function returns the JSON data of the instrument readings from our Arduino // device configured for the `SparkFun Weather Shield` settings. func (ar *ArduinoReader) GetSparkFunWeatherShieldData() *TimeSeriesData { // DEVELOPERS NOTE: // (1) The external device (Arduino) is setup to standby idle until it // receives a poll request from this code, once a poll request has // been submitted then all the sensors get polled and their data is // returned. // (2) Please look at the following code to understand how the external // device works in: // // (3) The reason for design is as follows: // (a) The external device does not have a real-time clock // (b) We don't want to add any real-time clock shields because // extra hardware means it costs more. // (c) We don't want to write complicated code of synching time // from this code because it will make the code complicated. // (d) Therefore we chose to make sensor polling be event based // and this code needs to send a \"poll request\". // STEP 1: // We need to send a single byte to the external device (Arduino) which // will trigger a polling event on all the sensors. n, err := ar.serialPort.Write([]byte(RX_BYTE)) if err != nil { log.Fatal(err) } // STEP 2: // The external device will poll the device, we need to make our main // runtime loop to be blocked so we wait until the device finishes and // returns all the sensor measurements. buf := make([]byte, 1028) n, err = ar.serialPort.Read(buf) if err != nil { log.Fatal(err) } // STEP 3: // Check to see if ANY data was returned from the external device, if // there was then we load up the string into a JSON object. var tsd TimeSeriesData err = json.Unmarshal(buf[:n], \u0026tsd) if err != nil { return nil } tsd.Timestamp = time.Now().Unix() return \u0026tsd } // Function used to print to the console the time series data. func PrettyPrintTimeSeriesData(tsd *TimeSeriesData) { fmt.Println(\"Status: \", tsd.Status) fmt.Println(\"Runtime: \", tsd.Runtime) fmt.Println(\"Status: \", tsd.Id) fmt.Println(\"HumidityValue: \", tsd.HumidityValue) fmt.Println(\"HumidityUnit: \", tsd.HumidityUnit) fmt.Println(\"TemperatureValue: \", tsd.TemperatureValue) fmt.Println(\"TemperatureUnit: \", tsd.TemperatureUnit) fmt.Println(\"PressureValue: \", tsd.PressureValue) fmt.Println(\"PressureUnit: \", tsd.PressureUnit) fmt.Println(\"TemperatureBackupValue: \", tsd.TemperatureBackupValue) fmt.Println(\"TemperatureBackupUnit: \", tsd.TemperatureBackupUnit) fmt.Println(\"AltitudeValue: \", tsd.AltitudeValue) fmt.Println(\"AltitudeUnit: \", tsd.AltitudeUnit) fmt.Println(\"IlluminanceValue: \", tsd.IlluminanceValue) fmt.Println(\"IlluminanceUnit: \", tsd.IlluminanceUnit) fmt.Println(\"Timestamp: \", tsd.Timestamp) } (3 of 6) internal/server.go package internal // github.com/bartmika/serialreader-server/internal/server.go import ( \"fmt\" \"log\" \"net\" \"google.golang.org/grpc\" pb \"github.com/bartmika/serialreader-server/proto\" ) type SerialReaderServer struct { port int arduinoDevicePath string arduinoReader *ArduinoReader grpcServer *grpc.Server } func New(arduinoDevicePath string, port int) *SerialReaderServer { return \u0026SerialReaderServer{ port: port, arduinoDevicePath: arduinoDevicePath, arduinoReader: nil, grpcServer: nil, } } // Function will consume the main runtime loop and run the business logic // of the application. func (s *SerialReaderServer) RunMainRuntimeLoop() { // Open a TCP server to the specified localhost and environment variable // specified port number. lis, err := net.Listen(\"tcp\", fmt.Sprintf(\":%v\", s.port)) if err != nil { log.Fatalf(\"failed to listen: %v\", err) } // Establish our device connection. arduinoReader := NewArduinoReader(s.arduinoDevicePath) // Initialize our gRPC server using our TCP server. grpcServer := grpc.NewServer() // Save reference to our application state. s.grpcServer = grpcServer s.arduinoReader = arduinoReader // For debugging purposes only. log.Printf(\"gRPC server is running.\") // Block the main runtime loop for accepting and processing gRPC requests. pb.RegisterSerialReaderServer(grpcServer, \u0026SerialReaderServerImpl{ // DEVELOPERS NOTE: // We want to attach to every gRPC call the following variables... arduinoReader: arduinoReader, }) if err := grpcServer.Serve(lis); err != nil { log.Fatalf(\"failed to serve: %v\", err) } } // Function will tell the application to stop the main runtime loop when // the process has been finished. func (s *SerialReaderServer) StopMainRuntimeLoop() { log.Printf(\"Starting graceful shutdown now...\") s.arduinoReader = nil // Finish any RPC communication taking place at the moment before // shutting down the gRPC server. s.grpcServer.GracefulStop() } (4 of 6) internal/server_impl.go package internal // github.com/bartmika/serialreader-server/internal/server_impl.go import ( \"context\" \"log\" \"github.com/golang/protobuf/ptypes\" pb \"github.com/bartmika/serialreader-server/proto\" ) type SerialReaderServerImpl struct { arduinoReader *ArduinoReader pb.SerialReaderServer } func (s *SerialReaderServerImpl) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) { log.Printf(\"Received: %v\", in.GetName()) return \u0026pb.HelloReply{Message: \"Hello \" + in.GetName()}, nil } func (s *SerialReaderServerImpl) GetSparkFunWeatherShieldData(ctx context.Context, in *pb.GetTimeSeriesData) (*pb.SparkFunWeatherShieldTimeSeriesData, error) { datum := s.arduinoReader.GetSparkFunWeatherShieldData() return \u0026pb.SparkFunWeatherShieldTimeSeriesData{ Status: true, Timestamp: ptypes.TimestampNow(), // Note: https://godoc.org/github.com/golang/protobuf/ptypes#Timestamp HumidityValue: datum.HumidityValue, HumidityUnit: datum.HumidityUnit, TemperatureValue: datum.TemperatureValue, TemperatureUnit: datum.TemperatureUnit, PressureValue: datum.PressureValue, PressureUnit: datum.PressureUnit, TemperatureBackupValue: datum.TemperatureBackupValue, TemperatureBackupUnit: datum.TemperatureBackupUnit, AltitudeValue: datum.AltitudeValue, AltitudeUnit: datum.AltitudeUnit, IlluminanceValue: datum.IlluminanceValue, IlluminanceUnit: datum.IlluminanceUnit, }, nil } (5 of 6) cmd/serve.go package cmd // github.com/bartmika/serialreader-server/cmd/serve.go import ( \"os\" \"os/signal\" \"syscall\" \"github.com/spf13/cobra\" server \"github.com/bartmika/serialreader-server/internal\" ) var ( port int arduinoDevicePath string ) func init() { // The following are required. serveCmd.Flags().StringVarP(\u0026arduinoDevicePath, \"arduino_path\", \"f\", \"/dev/cu.usbmodem14201\", \"The location of the connected arduino device on your computer.\") serveCmd.MarkFlagRequired(\"arduino_path\") // The following are optional and will have defaults placed when missing. serveCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port to run this server on\") // Make this sub-command part of our application. rootCmd.AddCommand(serveCmd) } func doServe() { // Setup our server. server := server.New(arduinoDevicePath, port) // DEVELOPERS CODE: // The following code will create an anonymous goroutine which will have a // blocking chan `sigs`. This blocking chan will only unblock when the // golang app receives a termination command; therfore the anyomous // goroutine will run and terminate our running application. // // Special Thanks: // (1) https://gobyexample.com/signals // (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html // sigs := make(chan os.Signal, 1) signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM) go func() { \u003c-sigs // Block execution until signal from terminal gets triggered here. server.StopMainRuntimeLoop() }() server.RunMainRuntimeLoop() } var serveCmd = \u0026cobra.Command{ Use: \"serve\", Short: \"Run the gRPC server\", Long: `Run the gRPC server to allow other services to access the serial reader`, Run: func(cmd *cobra.Command, args []string) { doServe() }, } (6 of 6) cmd/get_data.go package cmd // github.com/bartmika/serialreader-server/cmd/get_data.go import ( \"context\" \"fmt\" \"log\" \"time\" \"github.com/spf13/cobra\" \"google.golang.org/grpc\" // \"google.golang.org/grpc/credentials\" pb \"github.com/bartmika/serialreader-server/proto\" ) func init() { // The following are optional and will have defaults placed when missing. getDataCmd.Flags().IntVarP(\u0026port, \"port\", \"p\", 50051, \"The port of our server.\") rootCmd.AddCommand(getDataCmd) } func doGetData() { // Set up a direct connection to the gRPC server. conn, err := grpc.Dial( fmt.Sprintf(\":%v\", port), grpc.WithInsecure(), grpc.WithBlock(), ) if err != nil { log.Fatalf(\"did not connect: %v\", err) } // Set up our protocol buffer interface. client := pb.NewSerialReaderClient(conn) defer conn.Close() ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() // Perform our gRPC request. tsd, err := client.GetSparkFunWeatherShieldData(ctx, \u0026pb.GetTimeSeriesData{}) if err != nil { log.Fatalf(\"could not greet: %v\", err) } // Print out the gRPC response. log.Println(\"Server Response:\") fmt.Println(\"Status: \", tsd.Status) fmt.Println(\"HumidityValue: \", tsd.HumidityValue) fmt.Println(\"HumidityUnit: \", tsd.HumidityUnit) fmt.Println(\"TemperatureValue: \", tsd.TemperatureValue) fmt.Println(\"TemperatureUnit: \", tsd.TemperatureUnit) fmt.Println(\"PressureValue: \", tsd.PressureValue) fmt.Println(\"PressureUnit: \", tsd.PressureUnit) fmt.Println(\"TemperatureBackupValue: \", tsd.TemperatureBackupValue) fmt.Println(\"TemperatureBackupUnit: \", tsd.TemperatureBackupUnit) fmt.Println(\"AltitudeValue: \", tsd.AltitudeValue) fmt.Println(\"AltitudeUnit: \", tsd.AltitudeUnit) fmt.Println(\"IlluminanceValue: \", tsd.IlluminanceValue) fmt.Println(\"IlluminanceUnit: \", tsd.IlluminanceUnit) fmt.Println(\"Timestamp: \", tsd.Timestamp) } var getDataCmd = \u0026cobra.Command{ Use: \"get_data\", Short: \"Poll data from the gRPC server\", Long: `Connect to the gRPC server and poll the time series data. Command used to test out that the server is running.`, Run: func(cmd *cobra.Command, args []string) { doGetData() }, } Usage of our Serial Data Reader gRPC Server In your primary terminal, please run the server by entering the following command:\ngo run main.go serve -f=\"/dev/cu.usbmodem14401\" Please note that the value /dev/cu.usbmodem14401 was taken from the Arduino IDE, if you don’t know how to get this value, please read this article.\nIn another terminal window or terminal tab, please execute the following command to verify our server is working.\ngo run main.go get_data You should see something like this:\nIf you see the above, congratulations! You have written a gRPC server overtop your serial reader so you can now write an unlimited applications to poll the data.\nWhere do we go from here? You know how to read from the device and you now know how to serve it across many localhost applications or remote applications using gRPC. The next logic step is figuring out how to store the time-series data we retrieved. In the next post we will discuss building a gRPC server for storing and retrieving data.\n","wordCount":"2996","inLanguage":"en","image":"https://bartlomiejmika.com/img/2021/03-27/grpc.jpg","datePublished":"2021-07-09T18:35:46-04:00","dateModified":"2021-07-09T18:35:46-04:00","author":{"@type":"Person","name":"Bartlomiej Mika"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/"},"publisher":{"@type":"Organization","name":"Bartlomiej Mika","logo":{"@type":"ImageObject","url":"https://bartlomiejmika.com/img/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bartlomiejmika.com/ accesskey=h title="Bartlomiej Mika (Alt + H)"><img src=https://bartlomiejmika.com/img/bartlomiej_mika.jpeg alt=logo aria-label=logo height=35>Bartlomiej Mika</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bartlomiejmika.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://bartlomiejmika.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://bartlomiejmika.com/pages/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://bartlomiejmika.com/>Home</a>&nbsp;»&nbsp;<a href=https://bartlomiejmika.com/posts/>Posts</a></div><h1 class=post-title>How to Build a gRPC Server for a SparkFun Weather Shield</h1><div class=post-meta><span title='2021-07-09 18:35:46 -0400 -0400'>July 9, 2021</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;2996 words&nbsp;·&nbsp;Bartlomiej Mika&nbsp;|&nbsp;<a href=https://github.com/bartmika/bartlomiejmika-hugo/tree/master/content/posts/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://bartlomiejmika.com/img/2021/03-27/grpc.jpg alt></figure><div class=post-content><p>We will take what we learned in the <a href=/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/><em>previous post</em></a> and rewrite it to support interprocess communication of our SparkFun Weather Shield from other applications using the <a href=https://grpc.io><code>gRPC</code></a>.</p><h2 id=setup-a-basic-grpc-server>Setup a Basic gRPC Server<a hidden class=anchor aria-hidden=true href=#setup-a-basic-grpc-server>#</a></h2><p><em>Before writing any business logic, start off by building the project scaffolding. The scaffolding we will use is found if you read the <a href=https://grpc.io/docs/languages/go/basics/>gRPC Basics tutorial</a>. Our goal is to create a simple RPC server which we can call with a client; afterwords, we&rsquo;ll focus on writing our business logic. If you don&rsquo;t know anything about gRPC then checkout <a href=/posts/2021/example-of-writing-a-simple-grpc-server-in-golang-from-scratch/>this we article on gRPC basics</a>.</em></p><p>Start off by setting up the an empty repository in <a href=https://github.com/bartmika/serialreader-server>github</a> and run the following in your <code>terminal</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> ~/go/src/github.com/bartmika
</span></span><span class=line><span class=cl>git clone https://github.com/bartmika/serialreader-server.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> serialreader-server</span></span></code></pre></div><p>Initialize golang modules.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go mod init github.com/bartmika/serialreader-server</span></span></code></pre></div><p>Install our project&rsquo;s dependencies.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GO111MODULE</span><span class=o>=</span>on  <span class=c1># Enable module mode</span>
</span></span><span class=line><span class=cl>go get google.golang.org/protobuf/cmd/protoc-gen-go
</span></span><span class=line><span class=cl>go get google.golang.org/grpc/cmd/protoc-gen-go-grpc
</span></span><span class=line><span class=cl>go get google.golang.org/grpc
</span></span><span class=line><span class=cl>go get github.com/golang/protobuf/ptypes/timestamp
</span></span><span class=line><span class=cl>go get github.com/spf13/cobra
</span></span><span class=line><span class=cl>go get github.com/tarm/serial</span></span></code></pre></div><p>Setup our initial project structure. We will use this structure to grow our application. Please look at the folder and file names in the &ldquo;Project Hierarchy&rdquo; and create them in your computer as blank files.</p><h4 id=project-hierarchy>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>📁 serialreader-server
</span></span><span class=line><span class=cl>│   📄 main.go
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>└───📁 cmd
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   └───📄 hello.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 root.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 serve.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 version.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>└───📁 internal
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   └───📄 server_impl.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 server.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>└───📁 proto
</span></span><span class=line><span class=cl>    <span class=p>|</span>
</span></span><span class=line><span class=cl>    └───📄 serialreader.proto</span></span></code></pre></div><p>What are going to do? We want our project structured in such a way that it uses the <a href=https://github.com/spf13/cobra><code>spf13/cobra</code></a> package so we can easily commands in our application.</p><p>Please copy and paste the following code into those empty files.</p><h4 id=1-of-8-maingo>(1 of 8) main.go<a hidden class=anchor aria-hidden=true href=#1-of-8-maingo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span> <span class=c1>// github.com/bartmika/serialreader-server/main.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/bartmika/serialreader-server/cmd&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=2-of-8-cmdrootgo>(2 of 8) cmd/root.go<a hidden class=anchor aria-hidden=true href=#2-of-8-cmdrootgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-server/cmd/root.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>rootCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serialreader-server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Serve time-series data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Serve time-series data from a connected Arduino device with an attached &#39;SparkFun Weather Shield&#39; device over gRPC.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Do nothing...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Execute</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rootCmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintln</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=3-of-8-cmdversiongo>(3 of 8) cmd/version.go<a hidden class=anchor aria-hidden=true href=#3-of-8-cmdversiongo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-server/cmd/version.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>versionCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>versionCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;version&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Print the version number&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Print the current version that this server is on.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;serialreader-server v1.0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=4-of-8-protoserialreaderproto>(4 of 8) proto/serialreader.proto<a hidden class=anchor aria-hidden=true href=#4-of-8-protoserialreaderproto>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>syntax</span> <span class=p>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span> <span class=c1>// github.com/bartmika/serialreader-server/proto/serialreader.proto
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>option</span> <span class=nx>go_package</span> <span class=p>=</span> <span class=s>&#34;github.com/bartmika/serialreader-server&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>package</span> <span class=nx>proto</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>service</span> <span class=nx>SerialReader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>rpc</span> <span class=nf>SayHello</span> <span class=p>(</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=nf>returns</span> <span class=p>(</span><span class=nx>HelloReply</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// --- HELLO ENDPOINT ---
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// The request message containing the user&#39;s name.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>message</span> <span class=nx>HelloRequest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=nx>name</span> <span class=p>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The response message containing the greetings
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>message</span> <span class=nx>HelloReply</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>string</span> <span class=nx>message</span> <span class=p>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=5-of-8-internalservergo>(5 of 8) internal/server.go<a hidden class=anchor aria-hidden=true href=#5-of-8-internalservergo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/serialreader-server/internal/server.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/serialreader-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SerialReaderServer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>port</span>               <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>grpcServer</span>         <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>Server</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>port</span> <span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>SerialReaderServer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>SerialReaderServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>port</span><span class=p>:</span>               <span class=nx>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpcServer</span><span class=p>:</span>         <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function will consume the main runtime loop and run the business logic
</span></span></span><span class=line><span class=cl><span class=c1>// of the application.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>SerialReaderServer</span><span class=p>)</span> <span class=nf>RunMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Open a TCP server to the specified localhost and environment variable
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// specified port number.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Initialize our gRPC server using our TCP server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>grpcServer</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Save reference to our application state.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>.</span><span class=nx>grpcServer</span> <span class=p>=</span> <span class=nx>grpcServer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;gRPC server is running.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Block the main runtime loop for accepting and processing gRPC requests.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterSerialReaderServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>SerialReaderServerImpl</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// DEVELOPERS NOTE:
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// We want to attach to every gRPC call the following variables...
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpcServer</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function will tell the application to stop the main runtime loop when
</span></span></span><span class=line><span class=cl><span class=c1>// the process has been finished.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>SerialReaderServer</span><span class=p>)</span> <span class=nf>StopMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Starting graceful shutdown now...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Finish any RPC communication taking place at the moment before
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// shutting down the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>.</span><span class=nx>grpcServer</span><span class=p>.</span><span class=nf>GracefulStop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=6-of-8-internalserver_implgo>(6 of 8) internal/server_impl.go<a hidden class=anchor aria-hidden=true href=#6-of-8-internalserver_implgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/serialreader-server/internal/server_impl.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/serialreader-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SerialReaderServerImpl</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span><span class=p>.</span><span class=nx>SerialReaderServer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>SerialReaderServerImpl</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received: %v&#34;</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>{</span><span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Hello &#34;</span> <span class=o>+</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=7-of-8-cmdservego>(7 of 8) cmd/serve.go<a hidden class=anchor aria-hidden=true href=#7-of-8-cmdservego>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-server/cmd/serve.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;syscall&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>server</span> <span class=s>&#34;github.com/bartmika/serialreader-server/internal&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>port</span>                     <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are optional and will have defaults placed when missing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port to run this server on&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Make this sub-command part of our application.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>serveCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doServe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Setup our server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>server</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// DEVELOPERS CODE:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The following code will create an anonymous goroutine which will have a
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// blocking chan `sigs`. This blocking chan will only unblock when the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// golang app receives a termination command; therfore the anyomous
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// goroutine will run and terminate our running application.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Special Thanks:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (1) https://gobyexample.com/signals
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sigs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>sigs</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;-</span><span class=nx>sigs</span> <span class=c1>// Block execution until signal from terminal gets triggered here.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>server</span><span class=p>.</span><span class=nf>StopMainRuntimeLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=nx>server</span><span class=p>.</span><span class=nf>RunMainRuntimeLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>serveCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serve&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Run the gRPC server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Run the gRPC server to allow other services to access the serial reader`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doServe</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=8-of-8-cmdhellogo>(8 of 8) cmd/hello.go<a hidden class=anchor aria-hidden=true href=#8-of-8-cmdhellogo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-server/cmd/hello.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/serialreader-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are required.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>name</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;n&#34;</span><span class=p>,</span> <span class=s>&#34;Anonymous&#34;</span><span class=p>,</span> <span class=s>&#34;The name to send the server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are optional and will have defaults placed when missing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>helloCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doHello</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up a direct connection to the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up our protocol buffer interface.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewSerialReaderClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Perform our gRPC request.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not greet: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Print out the gRPC response.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetMessage</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>helloCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;hello&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Send hello message to gRPC server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and send a hello message. Command used to test out that the server is running.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doHello</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h2 id=usage-of-the-basic-grpc-server>Usage of the Basic gRPC Server<a hidden class=anchor aria-hidden=true href=#usage-of-the-basic-grpc-server>#</a></h2><p>In your primary <strong>terminal</strong>, please run the server by entering the following <strong>command</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go run main.go serve</span></span></code></pre></div><p>You should see something like this:</p><p><img loading=lazy src=/img/2021/07-09/a1.png alt></p><p>If you see this then you have successfully setup the basic gRPC server. In a another <strong>terminal</strong> window or tab, please execute the following <strong>command</strong> to verify our server is working.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go run main.go hello --name<span class=o>=</span><span class=s2>&#34;Bartlomiej&#34;</span></span></span></code></pre></div><p>You should see something like this:</p><p><img loading=lazy src=/img/2021/07-09/a2.png alt></p><p>Good stuff, our server works! Now let&rsquo;s build a gRPC service definition over our serial reader.</p><h2 id=integrate-the-sparkfun-weather-shield-reader>Integrate the SparkFun Weather Shield Reader<a hidden class=anchor aria-hidden=true href=#integrate-the-sparkfun-weather-shield-reader>#</a></h2><p><em>Before we begin, I am assuming you have successfully read through our <a href=/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/>previous article</a> before continuing. If you did not the next steps will note make sense.</em></p><p>Take a look at the following folder structure and create the necessary empty files:</p><h4 id=project-hierarchy-1>Project Hierarchy<a hidden class=anchor aria-hidden=true href=#project-hierarchy-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>📁 serialreader-server
</span></span><span class=line><span class=cl>│   📄 main.go
</span></span><span class=line><span class=cl>│
</span></span><span class=line><span class=cl>└───📁 cmd
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   └───📄 get_data.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 hello.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 root.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 serve.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 version.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>└───📁 internal
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   └───📄 arduino_reader.go <span class=o>(</span>*<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 server_impl.go
</span></span><span class=line><span class=cl><span class=p>|</span>       📄 server.go
</span></span><span class=line><span class=cl><span class=p>|</span>
</span></span><span class=line><span class=cl>└───📁 proto
</span></span><span class=line><span class=cl>    <span class=p>|</span>
</span></span><span class=line><span class=cl>    └───📄 serialreader.proto</span></span></code></pre></div><p>Notice the asterisks (*), those are the new files you will need to create.</p><p>Please copy and paste the following files. It&rsquo;s important to note you need to override the entire file when pasting!</p><h4 id=1-of-6-protoserialreaderproto>(1 of 6) proto/serialreader.proto<a hidden class=anchor aria-hidden=true href=#1-of-6-protoserialreaderproto>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span> <span class=c1>// github.com/bartmika/serialreader-server/proto/serialreader.proto
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/bartmika/serialreader-server&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>proto</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>import</span> <span class=s>&#34;google/protobuf/timestamp.proto&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>service</span> <span class=n>SerialReader</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>GetSparkFunWeatherShieldData</span> <span class=p>(</span><span class=n>GetTimeSeriesData</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>SparkFunWeatherShieldTimeSeriesData</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// --- HELLO ENDPOINT ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// The request message containing the user&#39;s name.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// The response message containing the greetings
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// --- POLLING ENDPOINT ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>GetTimeSeriesData</span> <span class=p>{}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>SparkFunWeatherShieldTimeSeriesData</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>bool</span> <span class=n>status</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>float</span> <span class=n>humidityValue</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>humidityUnit</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>float</span> <span class=n>temperatureValue</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>temperatureUnit</span> <span class=o>=</span> <span class=mi>6</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>float</span> <span class=n>pressureValue</span> <span class=o>=</span> <span class=mi>7</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>pressureUnit</span> <span class=o>=</span> <span class=mi>8</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>float</span> <span class=n>temperatureBackupValue</span> <span class=o>=</span> <span class=mi>9</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>temperatureBackupUnit</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>float</span> <span class=n>altitudeValue</span> <span class=o>=</span> <span class=mi>11</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>altitudeUnit</span> <span class=o>=</span> <span class=mi>12</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>float</span> <span class=n>illuminanceValue</span> <span class=o>=</span> <span class=mi>13</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>illuminanceUnit</span> <span class=o>=</span> <span class=mi>14</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>float</span> <span class=n>soilMoistureValue</span> <span class=o>=</span> <span class=mi>15</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>soilMoistureUnit</span> <span class=o>=</span> <span class=mi>16</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span></span></span></code></pre></div><h4 id=2-of-6-internalarduino_readergo>(2 of 6) internal/arduino_reader.go<a hidden class=anchor aria-hidden=true href=#2-of-6-internalarduino_readergo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/serialreader-server/internal/arduino_reader.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/tarm/serial&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=nx>RX_BYTE</span> <span class=p>=</span> <span class=s>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The time-series data structure used to store all the data that will be
</span></span></span><span class=line><span class=cl><span class=c1>// returned by the `SparkFun Weather Shield` Arduino device.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>TimeSeriesData</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Status</span>                     <span class=kt>string</span>  <span class=s>`json:&#34;status,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Runtime</span>                    <span class=kt>int</span>     <span class=s>`json:&#34;runtime,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Id</span>                         <span class=kt>int</span>     <span class=s>`json:&#34;id,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>HumidityValue</span>              <span class=kt>float32</span> <span class=s>`json:&#34;humidity_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>HumidityUnit</span>               <span class=kt>string</span>  <span class=s>`json:&#34;humidity_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>TemperatureValue</span>           <span class=kt>float32</span> <span class=s>`json:&#34;temperature_primary_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>TemperatureUnit</span>            <span class=kt>string</span>  <span class=s>`json:&#34;temperature_primary_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>PressureValue</span>              <span class=kt>float32</span> <span class=s>`json:&#34;pressure_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>PressureUnit</span>               <span class=kt>string</span>  <span class=s>`json:&#34;pressure_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>TemperatureBackupValue</span>     <span class=kt>float32</span> <span class=s>`json:&#34;temperature_secondary_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>TemperatureBackupUnit</span>      <span class=kt>string</span>  <span class=s>`json:&#34;temperature_secondary_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>AltitudeValue</span>              <span class=kt>float32</span> <span class=s>`json:&#34;altitude_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>AltitudeUnit</span>               <span class=kt>string</span>  <span class=s>`json:&#34;altitude_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>IlluminanceValue</span>           <span class=kt>float32</span> <span class=s>`json:&#34;illuminance_value,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>IlluminanceUnit</span>            <span class=kt>string</span>  <span class=s>`json:&#34;illuminance_unit,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Timestamp</span>                  <span class=kt>int64</span>   <span class=s>`json:&#34;timestamp,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// The abstraction of the `SparkFun Weather Shield` reader.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ArduinoReader</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>serialPort</span> <span class=o>*</span><span class=nx>serial</span><span class=p>.</span><span class=nx>Port</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Constructor used to intialize the serial reader designed to communicate
</span></span></span><span class=line><span class=cl><span class=c1>// with Arduino configured for the `SparkFun Weather Shield` settings.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewArduinoReader</span><span class=p>(</span><span class=nx>devicePath</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>ArduinoReader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;READER: Attempting to connect Arduino device...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>serial</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>devicePath</span><span class=p>,</span> <span class=nx>Baud</span><span class=p>:</span> <span class=mi>9600</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>serial</span><span class=p>.</span><span class=nf>OpenPort</span><span class=p>(</span><span class=nx>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// DEVELOPERS NOTE:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The following code will warm up the Arduino device before we are
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// able to make calls to the external sensors.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;READER: Waiting for Arduino external sensors to warm up&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>ar</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>ArduinoReader</span><span class=p>{</span><span class=nx>serialPort</span><span class=p>:</span> <span class=nx>s</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>ar</span><span class=p>.</span><span class=nf>GetSparkFunWeatherShieldData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>ar</span><span class=p>.</span><span class=nf>GetSparkFunWeatherShieldData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ar</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function returns the JSON data of the instrument readings from our Arduino
</span></span></span><span class=line><span class=cl><span class=c1>// device configured for the `SparkFun Weather Shield` settings.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>ar</span> <span class=o>*</span><span class=nx>ArduinoReader</span><span class=p>)</span> <span class=nf>GetSparkFunWeatherShieldData</span><span class=p>()</span> <span class=o>*</span><span class=nx>TimeSeriesData</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// DEVELOPERS NOTE:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (1) The external device (Arduino) is setup to standby idle until it
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     receives a poll request from this code, once a poll request has
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     been submitted then all the sensors get polled and their data is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     returned.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (2) Please look at the following code to understand how the external
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     device works in: &lt;TODO ADD&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (3) The reason for design is as follows:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     (a) The external device does not have a real-time clock
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     (b) We don&#39;t want to add any real-time clock shields because
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//         extra hardware means it costs more.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     (c) We don&#39;t want to write complicated code of synching time
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//         from this code because it will make the code complicated.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     (d) Therefore we chose to make sensor polling be event based
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//         and this code needs to send a &#34;poll request&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// STEP 1:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// We need to send a single byte to the external device (Arduino) which
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// will trigger a polling event on all the sensors.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>n</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ar</span><span class=p>.</span><span class=nx>serialPort</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>RX_BYTE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// STEP 2:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The external device will poll the device, we need to make our main
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// runtime loop to be blocked so we wait until the device finishes and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// returns all the sensor measurements.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>buf</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>1028</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>n</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>ar</span><span class=p>.</span><span class=nx>serialPort</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// STEP 3:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Check to see if ANY data was returned from the external device, if
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// there was then we load up the string into a JSON object.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=kd>var</span> <span class=nx>tsd</span> <span class=nx>TimeSeriesData</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=p>=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>buf</span><span class=p>[:</span><span class=nx>n</span><span class=p>],</span> <span class=o>&amp;</span><span class=nx>tsd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>tsd</span><span class=p>.</span><span class=nx>Timestamp</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Unix</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>tsd</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function used to print to the console the time series data.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>PrettyPrintTimeSeriesData</span><span class=p>(</span><span class=nx>tsd</span> <span class=o>*</span><span class=nx>TimeSeriesData</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Status: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Runtime: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Runtime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Status: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;HumidityValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>HumidityValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;HumidityUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>HumidityUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;PressureValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>PressureValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;PressureUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>PressureUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureBackupValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureBackupValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureBackupUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureBackupUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;AltitudeValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>AltitudeValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;AltitudeUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>AltitudeUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;IlluminanceValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>IlluminanceValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;IlluminanceUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>IlluminanceUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Timestamp: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=3-of-6-internalservergo>(3 of 6) internal/server.go<a hidden class=anchor aria-hidden=true href=#3-of-6-internalservergo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/serialreader-server/internal/server.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/serialreader-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SerialReaderServer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>port</span>               <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>arduinoDevicePath</span>  <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>arduinoReader</span>             <span class=o>*</span><span class=nx>ArduinoReader</span>
</span></span><span class=line><span class=cl>	<span class=nx>grpcServer</span>         <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>Server</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>arduinoDevicePath</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>port</span> <span class=kt>int</span><span class=p>)</span> <span class=o>*</span><span class=nx>SerialReaderServer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>SerialReaderServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>port</span><span class=p>:</span>               <span class=nx>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>arduinoDevicePath</span><span class=p>:</span>  <span class=nx>arduinoDevicePath</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>arduinoReader</span><span class=p>:</span>             <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpcServer</span><span class=p>:</span>         <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function will consume the main runtime loop and run the business logic
</span></span></span><span class=line><span class=cl><span class=c1>// of the application.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>SerialReaderServer</span><span class=p>)</span> <span class=nf>RunMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Open a TCP server to the specified localhost and environment variable
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// specified port number.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>port</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Establish our device connection.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>arduinoReader</span> <span class=o>:=</span> <span class=nf>NewArduinoReader</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>arduinoDevicePath</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Initialize our gRPC server using our TCP server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>grpcServer</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Save reference to our application state.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>.</span><span class=nx>grpcServer</span> <span class=p>=</span> <span class=nx>grpcServer</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>arduinoReader</span> <span class=p>=</span> <span class=nx>arduinoReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// For debugging purposes only.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;gRPC server is running.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Block the main runtime loop for accepting and processing gRPC requests.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterSerialReaderServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>SerialReaderServerImpl</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// DEVELOPERS NOTE:
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// We want to attach to every gRPC call the following variables...
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>arduinoReader</span><span class=p>:</span> <span class=nx>arduinoReader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpcServer</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Function will tell the application to stop the main runtime loop when
</span></span></span><span class=line><span class=cl><span class=c1>// the process has been finished.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>SerialReaderServer</span><span class=p>)</span> <span class=nf>StopMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Starting graceful shutdown now...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>arduinoReader</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Finish any RPC communication taking place at the moment before
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// shutting down the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>.</span><span class=nx>grpcServer</span><span class=p>.</span><span class=nf>GracefulStop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=4-of-6-internalserver_implgo>(4 of 6) internal/server_impl.go<a hidden class=anchor aria-hidden=true href=#4-of-6-internalserver_implgo>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/serialreader-server/internal/server_impl.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/golang/protobuf/ptypes&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/serialreader-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SerialReaderServerImpl</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>arduinoReader</span> <span class=o>*</span><span class=nx>ArduinoReader</span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span><span class=p>.</span><span class=nx>SerialReaderServer</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>SerialReaderServerImpl</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received: %v&#34;</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>{</span><span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Hello &#34;</span> <span class=o>+</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>SerialReaderServerImpl</span><span class=p>)</span> <span class=nf>GetSparkFunWeatherShieldData</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>GetTimeSeriesData</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>SparkFunWeatherShieldTimeSeriesData</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>datum</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>arduinoReader</span><span class=p>.</span><span class=nf>GetSparkFunWeatherShieldData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>SparkFunWeatherShieldTimeSeriesData</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Status</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>ptypes</span><span class=p>.</span><span class=nf>TimestampNow</span><span class=p>(),</span> <span class=c1>// Note: https://godoc.org/github.com/golang/protobuf/ptypes#Timestamp
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>HumidityValue</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>HumidityValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>HumidityUnit</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>HumidityUnit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>TemperatureValue</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>TemperatureValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>TemperatureUnit</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>TemperatureUnit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>PressureValue</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>PressureValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>PressureUnit</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>PressureUnit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>TemperatureBackupValue</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>TemperatureBackupValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>TemperatureBackupUnit</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>TemperatureBackupUnit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>AltitudeValue</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>AltitudeValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>AltitudeUnit</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>AltitudeUnit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>IlluminanceValue</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>IlluminanceValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>IlluminanceUnit</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>IlluminanceUnit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=5-of-6-cmdservego>(5 of 6) cmd/serve.go<a hidden class=anchor aria-hidden=true href=#5-of-6-cmdservego>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-server/cmd/serve.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os/signal&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;syscall&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>server</span> <span class=s>&#34;github.com/bartmika/serialreader-server/internal&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>port</span>                     <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>arduinoDevicePath</span>        <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are required.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>arduinoDevicePath</span><span class=p>,</span> <span class=s>&#34;arduino_path&#34;</span><span class=p>,</span> <span class=s>&#34;f&#34;</span><span class=p>,</span> <span class=s>&#34;/dev/cu.usbmodem14201&#34;</span><span class=p>,</span> <span class=s>&#34;The location of the connected arduino device on your computer.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;arduino_path&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are optional and will have defaults placed when missing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port to run this server on&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Make this sub-command part of our application.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>serveCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doServe</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Setup our server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>server</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>arduinoDevicePath</span><span class=p>,</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// DEVELOPERS CODE:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The following code will create an anonymous goroutine which will have a
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// blocking chan `sigs`. This blocking chan will only unblock when the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// golang app receives a termination command; therfore the anyomous
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// goroutine will run and terminate our running application.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Special Thanks:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (1) https://gobyexample.com/signals
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>sigs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>sigs</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;-</span><span class=nx>sigs</span> <span class=c1>// Block execution until signal from terminal gets triggered here.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>server</span><span class=p>.</span><span class=nf>StopMainRuntimeLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=nx>server</span><span class=p>.</span><span class=nf>RunMainRuntimeLoop</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>serveCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serve&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Run the gRPC server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Run the gRPC server to allow other services to access the serial reader`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doServe</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=6-of-6-cmdget_datago>(6 of 6) cmd/get_data.go<a hidden class=anchor aria-hidden=true href=#6-of-6-cmdget_datago>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/serialreader-server/cmd/get_data.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/serialreader-server/proto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// The following are optional and will have defaults placed when missing.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>getDataCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>getDataCmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>doGetData</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up a direct connection to the gRPC server.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span> <span class=nx>port</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Set up our protocol buffer interface.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewSerialReaderClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Perform our gRPC request.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>tsd</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>GetSparkFunWeatherShieldData</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>GetTimeSeriesData</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not greet: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Print out the gRPC response.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server Response:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Status: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;HumidityValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>HumidityValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;HumidityUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>HumidityUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;PressureValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>PressureValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;PressureUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>PressureUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureBackupValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureBackupValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;TemperatureBackupUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>TemperatureBackupUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;AltitudeValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>AltitudeValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;AltitudeUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>AltitudeUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;IlluminanceValue: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>IlluminanceValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;IlluminanceUnit: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>IlluminanceUnit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Timestamp: &#34;</span><span class=p>,</span> <span class=nx>tsd</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>getDataCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;get_data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Poll data from the gRPC server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and poll the time series data. Command used to test out that the server is running.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>doGetData</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h2 id=usage-of-our-serial-data-reader-grpc-server>Usage of our Serial Data Reader gRPC Server<a hidden class=anchor aria-hidden=true href=#usage-of-our-serial-data-reader-grpc-server>#</a></h2><p>In your primary <strong>terminal</strong>, please run the server by entering the following <strong>command</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go run main.go serve -f<span class=o>=</span><span class=s2>&#34;/dev/cu.usbmodem14401&#34;</span></span></span></code></pre></div><p>Please note that the value <code>/dev/cu.usbmodem14401</code> was taken from the <strong>Arduino IDE</strong>, if you don&rsquo;t know how to get this value, please <a href=/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/>read this article</a>.</p><p>In another <strong>terminal window</strong> or <strong>terminal tab</strong>, please execute the following <strong>command</strong> to verify our server is working.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>go run main.go get_data</span></span></code></pre></div><p>You should see something like this:</p><p><img loading=lazy src=/img/2021/07-09/a3.png alt></p><p>If you see the above, congratulations! You have written a gRPC server overtop your serial reader so you can now write an unlimited applications to poll the data.</p><h2 id=where-do-we-go-from-here>Where do we go from here?<a hidden class=anchor aria-hidden=true href=#where-do-we-go-from-here>#</a></h2><p>You know how to read from the device and you now know how to serve it across many localhost applications or remote applications using <a href=https://grpc.io><code>gRPC</code></a>. The next logic step is figuring out <em>how</em> to store the time-series data we retrieved. In the <a href=/posts/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server/>next post</a> we will discuss building a <a href=https://grpc.io><code>gRPC</code></a> server for storing and retrieving data.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bartlomiejmika.com/tags/iot/>IoT</a></li><li><a href=https://bartlomiejmika.com/tags/grpc/>gRPC</a></li><li><a href=https://bartlomiejmika.com/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=https://bartlomiejmika.com/posts/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server/><span class=title>« Prev</span><br><span>How to Build a gRPC Server over tstorage to create tstorage-server</span></a>
<a class=next href=https://bartlomiejmika.com/posts/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/><span class=title>Next »</span><br><span>How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server for a SparkFun Weather Shield on twitter" href="https://twitter.com/intent/tweet/?text=How%20to%20Build%20a%20gRPC%20Server%20for%20a%20SparkFun%20Weather%20Shield&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-for-a-sparkfun-weather-shield%2f&hashtags=IoT%2cgRPC%2cGolang"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server for a SparkFun Weather Shield on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-for-a-sparkfun-weather-shield%2f&title=How%20to%20Build%20a%20gRPC%20Server%20for%20a%20SparkFun%20Weather%20Shield&summary=How%20to%20Build%20a%20gRPC%20Server%20for%20a%20SparkFun%20Weather%20Shield&source=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-for-a-sparkfun-weather-shield%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server for a SparkFun Weather Shield on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-for-a-sparkfun-weather-shield%2f&title=How%20to%20Build%20a%20gRPC%20Server%20for%20a%20SparkFun%20Weather%20Shield"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server for a SparkFun Weather Shield on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-for-a-sparkfun-weather-shield%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server for a SparkFun Weather Shield on whatsapp" href="https://api.whatsapp.com/send?text=How%20to%20Build%20a%20gRPC%20Server%20for%20a%20SparkFun%20Weather%20Shield%20-%20https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-for-a-sparkfun-weather-shield%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share How to Build a gRPC Server for a SparkFun Weather Shield on telegram" href="https://telegram.me/share/url?text=How%20to%20Build%20a%20gRPC%20Server%20for%20a%20SparkFun%20Weather%20Shield&url=https%3a%2f%2fbartlomiejmika.com%2fposts%2f2021%2fhow-to-build-a-grpc-server-for-a-sparkfun-weather-shield%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://bartlomiejmika.com/>Bartlomiej Mika</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>