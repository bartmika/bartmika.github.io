<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>How to Build a gRPC Server over tstorage to create tstorage-server - Bartlomiej Mika</title><meta name=description content="Did you just finish reading the gRPC Basics tutorial and you don&rsquo;t know where to begin with using it? In this post I&rsquo;ll explain how to take a fast time-series database called tstorage and write a gRPC server and client with it."><meta name=author content="Mika Software Corporation"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"Bartlomiej Mika","url":"https:\/\/bartlomiejmika.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/bartlomiejmika.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/bartlomiejmika.com","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/bartlomiejmika.com\/post\/2021\/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server\/","name":"How to build a g r p c server over tstorage to create tstorage server"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Bartlomiej Mika"},"headline":"How to Build a gRPC Server over tstorage to create tstorage-server","description":"Did you just finish reading the gRPC Basics tutorial and you don\u0026rsquo;t know where to begin with using it? In this post I\u0026rsquo;ll explain how to take a fast time-series database called tstorage and write a gRPC server and client with it.\n","inLanguage":"en","wordCount":4011,"datePublished":"2021-07-09T23:45:08","dateModified":"2021-07-09T23:45:08","image":"https:\/\/bartlomiejmika.com\/img\/bartlomiej_mika.jpeg","keywords":["gRPC, Golang"],"mainEntityOfPage":"https:\/\/bartlomiejmika.com\/post\/2021\/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server\/","publisher":{"@type":"Organization","name":"https:\/\/bartlomiejmika.com","logo":{"@type":"ImageObject","url":"https:\/\/bartlomiejmika.com\/img\/bartlomiej_mika.jpeg","height":60,"width":60}}}</script><meta property="og:title" content="How to Build a gRPC Server over tstorage to create tstorage-server"><meta property="og:description" content="Did you just finish reading the gRPC Basics tutorial and you don&rsquo;t know where to begin with using it? In this post I&rsquo;ll explain how to take a fast time-series database called tstorage and write a gRPC server and client with it."><meta property="og:image" content="https://bartlomiejmika.com/img/bartlomiej_mika.jpeg"><meta property="og:url" content="https://bartlomiejmika.com/post/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server/"><meta property="og:type" content="website"><meta property="og:site_name" content="Bartlomiej Mika"><meta name=twitter:title content="How to Build a gRPC Server over tstorage to create tstorage-server"><meta name=twitter:description content="Did you just finish reading the gRPC Basics tutorial and you don&rsquo;t know where to begin with using it? In this post I&rsquo;ll explain how to take a fast time-series database called tstorage and â€¦"><meta name=twitter:image content="https://bartlomiejmika.com/img/bartlomiej_mika.jpeg"><meta name=twitter:card content="summary"><link href=https://bartlomiejmika.com/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.80.0"><link rel=alternate href=https://bartlomiejmika.com/index.xml type=application/rss+xml title="Bartlomiej Mika"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css integrity=sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://bartlomiejmika.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://bartlomiejmika.com/css/highlight.min.css><link rel=stylesheet href=https://bartlomiejmika.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-172742383-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button>
<a class=navbar-brand href=https://bartlomiejmika.com>Bartlomiej Mika</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Blog href=/>Blog</a></li><li><a title=Tags href=/tags>Tags</a></li><li><a title=About href=/about/>About</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title="Bartlomiej Mika" href=https://bartlomiejmika.com><img class=avatar-img src=https://bartlomiejmika.com/img/bartlomiej_mika.jpeg alt="Bartlomiej Mika"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>How to Build a gRPC Server over tstorage to create tstorage-server</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on July 9, 2021
&nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;19&nbsp;minutes
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;4011&nbsp;words
&nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Bartlomiej Mika</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p><img src=/img/2021/07-09/harrison-broadbent-nePxBIvqUlU-unsplash.jpg alt></p><p>Did you just finish reading the <a href=https://grpc.io/docs/languages/go/basics/><strong>gRPC Basics tutorial</strong></a> and you don&rsquo;t know where to begin with using it? In this post I&rsquo;ll explain how to take a fast time-series database called <a href=https://github.com/nakabonne/tstorage><code>tstorage</code></a> and write a gRPC server and client with it.</p><p>Recently I read an article from <a href="https://news.ycombinator.com/item?id=27730854">HackerNews</a> titled <a href=https://nakabonne.dev/posts/write-tsdb-from-scratch/>Write a time-series database engine from scratch</a> where the author, <a href=https://nakabonne.dev/about/>Ryo Nakao</a>, details the lessons he learned from implementing a fast <strong>time-series database</strong> of his own. In the article he mentions that he open sourced it as <a href=https://github.com/nakabonne/tstorage><code>nakabonne/tstorage</code></a>.</p><p>Investigating the <strong>repository</strong>, it looks well thought out and pretty easy to use; as a result, I thought about using it for personal projects. The challenge with the package is <em>interprocess communication</em> (IPC) as I want to have multiple small applications communicate with <code>tstorage</code>.</p><p>To get around the <em>IPC</em> issue, I decide to write a consumable <strong>gRPC service definition</strong> overtop the package so other local or remote applications can use it. I am calling this application <a href=https://github.com/bartmika/tstorage-server><code>tstorage-server</code></a>.</p><p>The purpose of this article is describe how to create a <strong>list</strong>, <strong>create</strong> and <strong>remove</strong> endpoints overtop <code>tstorage</code>. The benefit is if you want to create more <a href=https://grpc.io><code>gRPC</code></a> servers in the future, you can reference this article.</p><p>This article is broken down into the following sections:</p><ul><li>Part 1. Setup the Project</li><li>Part 2. Setup Simple Protocol Buffers</li><li>Part 3. Setup Simple gRPC Server</li><li>Part 4. Setup Simple gRPC Client</li><li>Part 5. Setup <code>tstorage</code> library with our Project |</li><li>Part 6. Server Endpoints</li><li>Part 7. Client Subcommands</li><li>Part 8. Usage examples</li></ul><h2 id=2>Assumptions</h2><p>Please note the following:</p><ul><li>Your developer machine is either MacOS or Linux</li><li>You have <code>golang 1.16</code> installed or greater</li><li>You are proficient with <code>git</code> and the <code>terminal</code>.</li><li>You have basic understanding of the Golang language.</li><li>You have a intermediate understanding of <code>gRPC</code>, and if not then please read my previous article title <a href=/post/2021/example-of-writing-a-simple-grpc-server-in-golang-from-scratch/>&ldquo;Example of Writing a Simple gRPC Server in Golang from Scratch&rdquo;</a> which will get you prepped for this article.</li></ul><h2 id=3>Part 1. Setup the Project</h2><p><em>Before writing any business logic, structure the project so it can grow in a logic and predictable manner.</em></p><p>Start off by setting up the an empty <strong>repository</strong> in <a href=https://github.com/bartmika/tstorage-server>github</a> and run the following in your <code>terminal</code>:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> ~/go/src/github.com/bartmika
git clone https://github.com/bartmika/tstorage-server.git
<span class=nb>cd</span> tstorage-server</code></pre></div><p>Initialize golang modules.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>go mod init github.com/bartmika/tstorage-server</code></pre></div><p>Install our project&rsquo;s dependencies.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>export</span> <span class=nv>GO111MODULE</span><span class=o>=</span>on  <span class=c1># Enable module mode</span>
go get google.golang.org/protobuf/cmd/protoc-gen-go
go get google.golang.org/grpc/cmd/protoc-gen-go-grpc
go get google.golang.org/grpc
go get github.com/golang/protobuf/ptypes/timestamp
go get github.com/nakabonne/tstorage
go get github.com/spf13/cobra</code></pre></div><p>Setup our initial project structure. We will use this structure to grow our application. Please look at the folder and file names in the &ldquo;Project Hierarchy&rdquo; and create them in your computer as blank files.</p><h4 id=project-hierarchy>Project Hierarchy</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ğŸ“ tstorage-server
â”‚   ğŸ“„ main.go
â”‚
â””â”€â”€â”€ğŸ“ cmd
    <span class=p>|</span>
    â””â”€â”€â”€ğŸ“„ root.go
        ğŸ“„ version.go</code></pre></div><p>What are going to do? We want our project structured in such a way that it uses the <a href=https://github.com/spf13/cobra><code>spf13/cobra</code></a> package so we can easily commands in our application.</p><p>To begin, please copy and paste the following code into those empty files.</p><h4 id=1-of-3-maingo>(1 of 3) main.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>main</span> <span class=c1>// github.com/bartmika/tstorage-server/main.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;github.com/bartmika/tstorage-server/cmd&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>cmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></div><h4 id=2-of-3-cmdrootgo>(2 of 3) cmd/root.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/root.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;os&#34;</span>

	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=nx>rootCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;tstorage-server&#34;</span><span class=p>,</span>
	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Time-series data storage gRPC server&#34;</span><span class=p>,</span>
	<span class=nx>Long</span><span class=p>:</span> <span class=s>`The purpose of this application is to provide a local
</span><span class=s>	       database tailored for fast time-series data storage and be
</span><span class=s>		   accessible with remote procedure calls (gRPC).`</span><span class=p>,</span>
	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
		<span class=c1>// Do nothing...
</span><span class=c1></span>	<span class=p>},</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>Execute</span><span class=p>()</span> <span class=p>{</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rootCmd</span><span class=p>.</span><span class=nf>Execute</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintln</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stderr</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></div><h4 id=3-of-3-cmdversiongo>(3 of 3) cmd/version.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/version.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;fmt&#34;</span>

	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>versionCmd</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>versionCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;version&#34;</span><span class=p>,</span>
	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Print the version number&#34;</span><span class=p>,</span>
	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Print the current version that this server is on.`</span><span class=p>,</span>
	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;tstorage-server v1.0&#34;</span><span class=p>)</span>
	<span class=p>},</span>
<span class=p>}</span>
</code></pre></div><p>Once you finished, in your <code>terminal</code> please write the following.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>go run main.go version</code></pre></div><p>If you setup everything correctly, there should be no errors. Good job!</p><h2 id=4>Part 2. Setup Simple Protocol Buffers</h2><p>Now that we have our <strong>application</strong> structured to use <a href=https://github.com/spf13/cobra><code>spf13/cobra</code></a> as our project&rsquo;s scaffolding, we can start by creating our code. We will begin with <strong>protocol buffers</strong>, we need to define a service in <code>.proto</code> file.</p><p>To begin, create the following folders and files in the your project (notice the asterisks for the new files):</p><h4 id=project-hierarchy-1>Project Hierarchy</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ğŸ“ tstorage-server
â”‚   ğŸ“„ README.md
â”‚   ğŸ“„ main.go
â”‚   ğŸ“„ Makefile
â”‚
â””â”€â”€â”€ğŸ“ cmd
â”‚   <span class=p>|</span>
<span class=p>|</span>   â””â”€â”€â”€ğŸ“„ root.go
<span class=p>|</span>       ğŸ“„ version.go
<span class=p>|</span>
â””â”€â”€â”€ğŸ“ proto <span class=o>(</span>*<span class=o>)</span>
     â”‚
     â””â”€â”€ğŸ“„ tstorage.proto <span class=o>(</span>*<span class=o>)</span></code></pre></div><p>Please copy and paste the content of this file.</p><h4 id=1-of-1-prototstorageproto>(1 of 1) proto/tstorage.proto</h4><div class=highlight><pre class=chroma><code class=language-proto data-lang=proto><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span> <span class=c1>// github.com/bartmika/tstorage-server/proto/tstorage.proto
</span><span class=c1></span><span class=err>
</span><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/bartmika/tstorage-server&#34;</span><span class=p>;</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kn>package</span> <span class=nn>proto</span><span class=p>;</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// The greeting service definition.
</span><span class=c1></span><span class=kd>service</span> <span class=n>TStorage</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=c1>// Sends a greeting
</span><span class=c1></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// The request message containing the user&#39;s name.
</span><span class=c1></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// The response message containing the greetings
</span><span class=c1></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span></code></pre></div><p>In your <strong>terminal</strong>, make sure we export our path (if you havenâ€™t done this before) by writing the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$PATH</span><span class=s2>:</span><span class=k>$(</span>go env GOPATH<span class=k>)</span><span class=s2>/bin&#34;</span></code></pre></div><p>Run the following to generate our new <strong>gRPC interface</strong>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>protoc --go_out<span class=o>=</span>. --go_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative --go-grpc_out<span class=o>=</span>. --go-grpc_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative proto/tstorage.proto</code></pre></div><p>After running the <strong>command</strong> your structure should look as follows (notice the asterisks). Please look through the new files to get a feel for the code.</p><h4 id=project-hierarchy-2>Project Hierarchy</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ğŸ“ tstorage-server
â”‚   ğŸ“„ README.md
â”‚   ğŸ“„ main.go
â”‚   ğŸ“„ Makefile
â”‚
â””â”€â”€â”€ğŸ“ cmd
â”‚   <span class=p>|</span>
<span class=p>|</span>   â””â”€â”€â”€ğŸ“„ root.go
<span class=p>|</span>       ğŸ“„ version.go
<span class=p>|</span>
â””â”€â”€â”€ğŸ“ proto
     â”‚
     â””â”€â”€ğŸ“„ tstorage_grpc.pb.go <span class=o>(</span>*<span class=o>)</span>
        ğŸ“„ tstorage.proto
        ğŸ“„ tstorage.pb.go <span class=o>(</span>*<span class=o>)</span></code></pre></div><p>What does this code do?</p><ul><li><strong>tstorage.pb.go</strong>, which contains all the protocol buffer code to populate, serialize, and retrieve request and response message types.</li><li><strong>tstorage_grpc.pb.go</strong>, which contains the following:<ul><li>An interface type (or stub) for clients to call with the methods defined in the TStorage service.</li><li>An interface type for servers to implement, also with the methods defined in the TStorage service.</li></ul></li></ul><h2 id=5>Part 3. Setup Simple gRPC Server</h2><p>Please create the following blank files (notice asterisks):</p><h4 id=project-hierarchy-3>Project Hierarchy</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ğŸ“ tstorage-server
â”‚   ğŸ“„ README.md
â”‚   ğŸ“„ main.go
â”‚   ğŸ“„ Makefile
â”‚
â””â”€â”€â”€ğŸ“ cmd
â”‚   <span class=p>|</span>
<span class=p>|</span>   â””â”€â”€â”€ğŸ“„ root.go
<span class=p>|</span>       ğŸ“„ serve.go <span class=o>(</span>*<span class=o>)</span>
<span class=p>|</span>       ğŸ“„ version.go
â”‚
â””â”€â”€â”€ğŸ“ internal <span class=o>(</span>*<span class=o>)</span>
<span class=p>|</span>    â”‚
<span class=p>|</span>    â””â”€â”€ğŸ“„ server_impl.go <span class=o>(</span>*<span class=o>)</span>
<span class=p>|</span>       ğŸ“„ server.go <span class=o>(</span>*<span class=o>)</span>
<span class=p>|</span>
â””â”€â”€â”€ğŸ“ proto <span class=o>(</span>*<span class=o>)</span>
     â”‚
     â””â”€â”€ğŸ“„ tstorage_grpc.pb.go
        ğŸ“„ tstorage.proto
        ğŸ“„ tstorage.pb.go</code></pre></div><p>Populate the following</p><h4 id=1-of-3-cmdservego>(1 of 3) cmd/serve.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/serve.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;os&#34;</span>
	<span class=s>&#34;os/signal&#34;</span>
	<span class=s>&#34;syscall&#34;</span>

	<span class=s>&#34;github.com/spf13/cobra&#34;</span>

	<span class=nx>server</span> <span class=s>&#34;github.com/bartmika/tstorage-server/internal&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=p>(</span>
	<span class=nx>port</span> <span class=kt>int</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port to run this server on&#34;</span><span class=p>)</span>
	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;port&#34;</span><span class=p>)</span>
	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>serveCmd</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>doServe</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>server</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>port</span><span class=p>)</span>

	<span class=c1>// DEVELOPERS CODE:
</span><span class=c1></span>	<span class=c1>// The following code will create an anonymous goroutine which will have a
</span><span class=c1></span>	<span class=c1>// blocking chan `sigs`. This blocking chan will only unblock when the
</span><span class=c1></span>    <span class=c1>// golang app receives a termination command; therfore the anyomous
</span><span class=c1></span>    <span class=c1>// goroutine will run and terminate our running application.
</span><span class=c1></span>    <span class=c1>//
</span><span class=c1></span>    <span class=c1>// Special Thanks:
</span><span class=c1></span>    <span class=c1>// (1) https://gobyexample.com/signals
</span><span class=c1></span>    <span class=c1>// (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html
</span><span class=c1></span>    <span class=c1>//
</span><span class=c1></span>    <span class=nx>sigs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
    <span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>sigs</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
        <span class=o>&lt;-</span><span class=nx>sigs</span> <span class=c1>// Block execution until signal from terminal gets triggered here.
</span><span class=c1></span>        <span class=nx>server</span><span class=p>.</span><span class=nf>StopMainRuntimeLoop</span><span class=p>()</span>
    <span class=p>}()</span>
	<span class=nx>server</span><span class=p>.</span><span class=nf>RunMainRuntimeLoop</span><span class=p>()</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>serveCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serve&#34;</span><span class=p>,</span>
	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Run the gRPC server&#34;</span><span class=p>,</span>
	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Run the gRPC server to allow other services to access the storage application`</span><span class=p>,</span>
	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
		<span class=nf>doServe</span><span class=p>()</span>
	<span class=p>},</span>
<span class=p>}</span>
</code></pre></div><h4 id=2-of-3-internalservergo>(2 of 3) internal/server.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/tstorage-server/internal/server.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;fmt&#34;</span>
    <span class=s>&#34;log&#34;</span>
    <span class=s>&#34;net&#34;</span>

    <span class=s>&#34;google.golang.org/grpc&#34;</span>

    <span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>TStorageServer</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>port</span><span class=p>:</span> <span class=nx>port</span>
    <span class=nx>grpcServer</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>Server</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>port</span> <span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>TStorageServer</span><span class=p>{</span>
        <span class=nx>port</span><span class=p>:</span> <span class=nx>port</span><span class=p>,</span>
        <span class=nx>grpcServer</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// Function will consume the main runtime loop and run the business logic
</span><span class=c1>// of the application.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>app</span> <span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=nf>RunMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
   <span class=c1>// Open a TCP server to the specified localhost and environment variable
</span><span class=c1></span>   <span class=c1>// specified port number.
</span><span class=c1></span>   <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>s</span><span class=p>.</span><span class=nx>port</span><span class=p>))</span>
   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
   <span class=p>}</span>

   <span class=c1>// Initialize our gRPC server using our TCP server.
</span><span class=c1></span>   <span class=nx>grpcServer</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>

   <span class=c1>// Save reference to our application state.
</span><span class=c1></span>   <span class=nx>app</span><span class=p>.</span><span class=nx>grpcServer</span> <span class=p>=</span> <span class=nx>grpcServer</span>

   <span class=c1>// For debugging purposes only.
</span><span class=c1></span>   <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;gRPC server is running.&#34;</span><span class=p>)</span>

   <span class=c1>// Block the main runtime loop for accepting and processing gRPC requests.
</span><span class=c1></span>   <span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterTStorageServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>TStorageServerImpl</span><span class=p>{</span>
       <span class=c1>// DEVELOPERS NOTE:
</span><span class=c1></span>       <span class=c1>// We want to attach to every gRPC call the following variables...
</span><span class=c1></span>       <span class=c1>// ...
</span><span class=c1></span>       <span class=c1>// ...
</span><span class=c1></span>   <span class=p>})</span>
   <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpcServer</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
   <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// Function will tell the application to stop the main runtime loop when
</span><span class=c1>// the process has been finished.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>app</span> <span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=nf>StopMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Starting graceful shutdown now...&#34;</span><span class=p>)</span>

    <span class=c1>// Finish any RPC communication taking place at the moment before
</span><span class=c1></span>    <span class=c1>// shutting down the gRPC server.
</span><span class=c1></span>    <span class=nx>app</span><span class=p>.</span><span class=nx>grpcServer</span><span class=p>.</span><span class=nf>GracefulStop</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></div><h4 id=3-of-3-internalserver_implgo>(3 of 3) internal/server_impl.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/tstorage-server/internal/server_impl.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;context&#34;</span>
    <span class=s>&#34;log&#34;</span>

    <span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>TStorageServerImpl</span> <span class=kd>struct</span><span class=p>{</span>
    <span class=nx>pb</span><span class=p>.</span><span class=nx>TStorageServer</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received: %v&#34;</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>{</span><span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Hello &#34;</span> <span class=o>+</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()},</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p>You now have implemented a basic server.</p><h2 id=6>Part 4. Setup Simple gRPC Client</h2><p>Please create the following blank files:</p><h4 id=project-hierarchy-4>Project Hierarchy</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ğŸ“ tstorage-server
â”‚   ğŸ“„ README.md
â”‚   ğŸ“„ main.go
â”‚   ğŸ“„ Makefile
â”‚
â””â”€â”€â”€ğŸ“ cmd
â”‚   <span class=p>|</span>
<span class=p>|</span>   â””â”€â”€â”€ğŸ“„ hello.go <span class=o>(</span>*<span class=o>)</span>
<span class=p>|</span>       ğŸ“„ root.go
<span class=p>|</span>       ğŸ“„ serve.go
<span class=p>|</span>       ğŸ“„ version.go
â”‚
â””â”€â”€â”€ğŸ“ internal
<span class=p>|</span>    â”‚
<span class=p>|</span>    â””â”€â”€ğŸ“„ server_impl.go
<span class=p>|</span>       ğŸ“„ server.go
<span class=p>|</span>
â””â”€â”€â”€ğŸ“ proto
     â”‚
     â””â”€â”€ğŸ“„ tstorage_grpc.pb.go
        ğŸ“„ tstorage.proto
        ğŸ“„ tstorage.pb.go</code></pre></div><p>Next populate the following:</p><h4 id=cmdhellogo>cmd/hello.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/hello.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;time&#34;</span>

	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
	<span class=s>&#34;google.golang.org/grpc&#34;</span>
	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span><span class=c1></span>
	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=p>(</span>
	<span class=nx>name</span> <span class=kt>string</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>name</span><span class=p>,</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=s>&#34;n&#34;</span><span class=p>,</span> <span class=s>&#34;Anonymous&#34;</span><span class=p>,</span> <span class=s>&#34;The name to send the server.&#34;</span><span class=p>)</span>
	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>)</span>
	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
	<span class=nx>helloCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;port&#34;</span><span class=p>)</span>
	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>helloCmd</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>doHello</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// Set up a direct connection to the gRPC server.
</span><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>port</span><span class=p>),</span>
		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
	<span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=c1>// Set up our protocol buffer interface.
</span><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewTStorageClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>

	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>

	<span class=c1>// Perform our gRPC request.
</span><span class=c1></span>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>name</span><span class=p>})</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not greet: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

	<span class=c1>// Print out the gRPC response.
</span><span class=c1></span>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetMessage</span><span class=p>())</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>helloCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;hello&#34;</span><span class=p>,</span>
	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Send hello message to gRPC server&#34;</span><span class=p>,</span>
	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and send a hello message. Command used to test out that the server is running.`</span><span class=p>,</span>
	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
		<span class=nf>doHello</span><span class=p>()</span>
	<span class=p>},</span>
<span class=p>}</span>
</code></pre></div><p>Run the following <strong>command</strong> in your <strong>terminal</strong>.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>go run main.go hello --name=&#34;Bart&#34; --port=50051
</code></pre></div><p>You should get a response as follows:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>2021/07/07 23:22:23 Server Response: Hello Bart
</code></pre></div><h2 id=7>Part 5. Setup <code>tstorage</code> library with our Project</h2><h4 id=1-of-2-cmdservego>(1 of 2) cmd/serve.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/serve.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;os&#34;</span>
	<span class=s>&#34;os/signal&#34;</span>
	<span class=s>&#34;syscall&#34;</span>
	<span class=s>&#34;time&#34;</span>

	<span class=s>&#34;github.com/spf13/cobra&#34;</span>

	<span class=nx>server</span> <span class=s>&#34;github.com/bartmika/tstorage-server/internal&#34;</span>
	<span class=s>&#34;github.com/bartmika/tstorage-server/utils&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=p>(</span>
	<span class=nx>port</span> <span class=kt>int</span>
	<span class=nx>dataPath</span> <span class=kt>string</span>
	<span class=nx>timestampPrecision</span> <span class=kt>string</span>
	<span class=nx>partitionDurationInHours</span> <span class=kt>int</span>
	<span class=nx>writeTimeoutInSeconds</span> <span class=kt>int</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// The following are required.
</span><span class=c1></span>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port to run this server on&#34;</span><span class=p>)</span>
	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;port&#34;</span><span class=p>)</span>

	<span class=c1>// The following are optional and will have defaults placed when missing.
</span><span class=c1></span>	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>dataPath</span><span class=p>,</span> <span class=s>&#34;dataPath&#34;</span><span class=p>,</span> <span class=s>&#34;d&#34;</span><span class=p>,</span> <span class=s>&#34;./tsdb&#34;</span><span class=p>,</span> <span class=s>&#34;The location to save the database files to.&#34;</span><span class=p>)</span>
	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>timestampPrecision</span><span class=p>,</span> <span class=s>&#34;timestampPrecision&#34;</span><span class=p>,</span> <span class=s>&#34;t&#34;</span><span class=p>,</span> <span class=s>&#34;s&#34;</span><span class=p>,</span> <span class=s>&#34;The precision of timestamps to be used by all operations. Options: &#34;</span><span class=p>)</span>
	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>partitionDurationInHours</span><span class=p>,</span> <span class=s>&#34;partitionDurationInHours&#34;</span><span class=p>,</span> <span class=s>&#34;b&#34;</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=s>&#34;The timestamp range inside partitions.&#34;</span><span class=p>)</span>
	<span class=nx>serveCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>writeTimeoutInSeconds</span><span class=p>,</span> <span class=s>&#34;writeTimeoutInSeconds&#34;</span><span class=p>,</span> <span class=s>&#34;w&#34;</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=s>&#34;The timeout to wait when workers are busy (in seconds).&#34;</span><span class=p>)</span>

	<span class=c1>// Make this sub-command part of our application.
</span><span class=c1></span>	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>serveCmd</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>doServe</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// Convert the user inputted integer value to be a `time.Duration` type.
</span><span class=c1></span>	<span class=nx>partitionDuration</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>partitionDurationInHours</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Hour</span>
	<span class=nx>writeTimeout</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>writeTimeoutInSeconds</span><span class=p>)</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span>

    <span class=c1>// Setup our server.
</span><span class=c1></span>	<span class=nx>server</span> <span class=o>:=</span> <span class=nx>server</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>port</span><span class=p>,</span> <span class=nx>dataPath</span><span class=p>,</span> <span class=nx>timestampPrecision</span><span class=p>,</span> <span class=nx>partitionDuration</span><span class=p>,</span> <span class=nx>writeTimeout</span><span class=p>)</span>

	<span class=c1>// DEVELOPERS CODE:
</span><span class=c1></span>	<span class=c1>// The following code will create an anonymous goroutine which will have a
</span><span class=c1></span>	<span class=c1>// blocking chan `sigs`. This blocking chan will only unblock when the
</span><span class=c1></span>    <span class=c1>// golang app receives a termination command; therfore the anyomous
</span><span class=c1></span>    <span class=c1>// goroutine will run and terminate our running application.
</span><span class=c1></span>    <span class=c1>//
</span><span class=c1></span>    <span class=c1>// Special Thanks:
</span><span class=c1></span>    <span class=c1>// (1) https://gobyexample.com/signals
</span><span class=c1></span>    <span class=c1>// (2) https://guzalexander.com/2017/05/31/gracefully-exit-server-in-go.html
</span><span class=c1></span>    <span class=c1>//
</span><span class=c1></span>    <span class=nx>sigs</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Signal</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
    <span class=nx>signal</span><span class=p>.</span><span class=nf>Notify</span><span class=p>(</span><span class=nx>sigs</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span> <span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span>
    <span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
        <span class=o>&lt;-</span><span class=nx>sigs</span> <span class=c1>// Block execution until signal from terminal gets triggered here.
</span><span class=c1></span>        <span class=nx>server</span><span class=p>.</span><span class=nf>StopMainRuntimeLoop</span><span class=p>()</span>
    <span class=p>}()</span>
	<span class=nx>server</span><span class=p>.</span><span class=nf>RunMainRuntimeLoop</span><span class=p>()</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>serveCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;serve&#34;</span><span class=p>,</span>
	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Run the gRPC server&#34;</span><span class=p>,</span>
	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Run the gRPC server to allow other services to access the storage application`</span><span class=p>,</span>
	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
		<span class=c1>// Defensive code. Make sure the user selected the correct `timestampPrecision`
</span><span class=c1></span>		<span class=c1>// choices before continuing execution of our command.
</span><span class=c1></span>        <span class=nx>okTimestampPrecision</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;ns&#34;</span><span class=p>,</span> <span class=s>&#34;us&#34;</span><span class=p>,</span> <span class=s>&#34;ms&#34;</span><span class=p>,</span> <span class=s>&#34;s&#34;</span><span class=p>}</span>
		<span class=k>if</span> <span class=nx>utils</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=nx>okTimestampPrecision</span><span class=p>,</span> <span class=nx>timestampPrecision</span><span class=p>)</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;Timestamp precision must be either one of the following: ns, us, ms, or s.&#34;</span><span class=p>)</span>
		<span class=p>}</span>

		<span class=c1>// Execute our command with our validated inputs.
</span><span class=c1></span>		<span class=nf>doServe</span><span class=p>()</span>
	<span class=p>},</span>
<span class=p>}</span>
</code></pre></div><h4 id=2-of-2-internalservergo>(2 of 2) internal/server.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>internal</span> <span class=c1>// github.com/bartmika/tstorage-server/internal/server.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;fmt&#34;</span>
    <span class=s>&#34;log&#34;</span>
    <span class=s>&#34;net&#34;</span>
    <span class=s>&#34;time&#34;</span>

    <span class=s>&#34;google.golang.org/grpc&#34;</span>
    <span class=s>&#34;github.com/nakabonne/tstorage&#34;</span>

    <span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
<span class=p>)</span>


<span class=kd>type</span> <span class=nx>TStorageServer</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>port</span> <span class=kt>int</span>
    <span class=nx>dataPath</span> <span class=kt>string</span>
    <span class=nx>timestampPrecision</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>TimestampPrecision</span>
    <span class=nx>partitionDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
    <span class=nx>writeTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
    <span class=nx>storage</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Storage</span>
    <span class=nx>grpcServer</span> <span class=o>*</span><span class=nx>grpc</span><span class=p>.</span><span class=nx>Server</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>New</span><span class=p>(</span><span class=nx>port</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>dataPath</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>timestampPrecision</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>partitionDuration</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span> <span class=nx>writeTimeout</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Conver to the format that is accepted by the library.
</span><span class=c1></span>    <span class=kd>var</span> <span class=nx>tsp</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>TimestampPrecision</span>
    <span class=k>switch</span> <span class=nx>timestampPrecision</span> <span class=p>{</span>
    <span class=k>case</span> <span class=s>&#34;ns&#34;</span><span class=p>:</span>
        <span class=nx>tsp</span> <span class=p>=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Nanoseconds</span>
    <span class=k>case</span> <span class=s>&#34;us&#34;</span><span class=p>:</span>
        <span class=nx>tsp</span> <span class=p>=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Microseconds</span>
    <span class=k>case</span> <span class=s>&#34;ms&#34;</span><span class=p>:</span>
        <span class=nx>tsp</span> <span class=p>=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Milliseconds</span>
    <span class=k>case</span> <span class=s>&#34;s&#34;</span><span class=p>:</span>
        <span class=nx>tsp</span> <span class=p>=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Seconds</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>TStorageServer</span><span class=p>{</span>
        <span class=nx>port</span><span class=p>:</span> <span class=nx>port</span><span class=p>,</span>
        <span class=nx>dataPath</span><span class=p>:</span> <span class=nx>dataPath</span><span class=p>,</span>
        <span class=nx>timestampPrecision</span><span class=p>:</span> <span class=nx>tsp</span><span class=p>,</span>
        <span class=nx>partitionDuration</span><span class=p>:</span> <span class=nx>partitionDuration</span><span class=p>,</span>
        <span class=nx>writeTimeout</span><span class=p>:</span> <span class=nx>writeTimeout</span><span class=p>,</span>
        <span class=nx>storage</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
        <span class=nx>grpcServer</span><span class=p>:</span> <span class=kc>nil</span><span class=p>,</span>
    <span class=p>}</span>
<span class=p>}</span>


<span class=c1>// Function will consume the main runtime loop and run the business logic
</span><span class=c1>// of the application.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=nf>RunMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
   <span class=c1>// Open a TCP server to the specified localhost and environment variable
</span><span class=c1></span>   <span class=c1>// specified port number.
</span><span class=c1></span>   <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>s</span><span class=p>.</span><span class=nx>port</span><span class=p>))</span>
   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
   <span class=p>}</span>

   <span class=c1>// Initialize our gRPC server using our TCP server.
</span><span class=c1></span>   <span class=nx>grpcServer</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>

   <span class=c1>// Initialize our fast time-series database.
</span><span class=c1></span>    <span class=nx>storage</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nf>NewStorage</span><span class=p>(</span>
        <span class=nx>tstorage</span><span class=p>.</span><span class=nf>WithDataPath</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>dataPath</span><span class=p>),</span>
		<span class=nx>tstorage</span><span class=p>.</span><span class=nf>WithTimestampPrecision</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>timestampPrecision</span><span class=p>),</span>
        <span class=nx>tstorage</span><span class=p>.</span><span class=nf>WithPartitionDuration</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>partitionDuration</span><span class=p>),</span>
        <span class=nx>tstorage</span><span class=p>.</span><span class=nf>WithWriteTimeout</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>writeTimeout</span><span class=p>),</span>
    <span class=p>)</span>

   <span class=c1>// Save reference to our application state.
</span><span class=c1></span>   <span class=nx>s</span><span class=p>.</span><span class=nx>grpcServer</span> <span class=p>=</span> <span class=nx>grpcServer</span>
   <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span> <span class=p>=</span> <span class=nx>storage</span>

   <span class=c1>// For debugging purposes only.
</span><span class=c1></span>   <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;gRPC server is running.&#34;</span><span class=p>)</span>

   <span class=c1>// Block the main runtime loop for accepting and processing gRPC requests.
</span><span class=c1></span>   <span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterTStorageServer</span><span class=p>(</span><span class=nx>grpcServer</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>TStorageServerImpl</span><span class=p>{</span>
       <span class=c1>// DEVELOPERS NOTE:
</span><span class=c1></span>       <span class=c1>// We want to attach to every gRPC call the following variables...
</span><span class=c1></span>       <span class=nx>storage</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>,</span>
   <span class=p>})</span>
   <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpcServer</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
       <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
   <span class=p>}</span>
<span class=p>}</span>


<span class=c1>// Function will tell the application to stop the main runtime loop when
</span><span class=c1>// the process has been finished.
</span><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServer</span><span class=p>)</span> <span class=nf>StopMainRuntimeLoop</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Starting graceful shutdown now...&#34;</span><span class=p>)</span>

    <span class=c1>// Finish our database operations running.
</span><span class=c1></span>    <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>

    <span class=c1>// Finish any RPC communication taking place at the moment before
</span><span class=c1></span>    <span class=c1>// shutting down the gRPC server.
</span><span class=c1></span>    <span class=nx>s</span><span class=p>.</span><span class=nx>grpcServer</span><span class=p>.</span><span class=nf>GracefulStop</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></div><h2 id=8>Part 6. Server Endpoints</h2><p>Please override the following files.</p><h4 id=1-of-2-prototstorageproto>(1 of 2) proto/tstorage.proto</h4><div class=highlight><pre class=chroma><code class=language-proto data-lang=proto><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span> <span class=c1>// github.com/bartmika/tstorage-server/proto/tstorage.proto
</span><span class=c1></span><span class=err>
</span><span class=err></span><span class=k>option</span> <span class=n>go_package</span> <span class=o>=</span> <span class=s>&#34;github.com/bartmika/tstorage-server&#34;</span><span class=p>;</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kn>package</span> <span class=nn>proto</span><span class=p>;</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>import</span> <span class=s>&#34;google/protobuf/timestamp.proto&#34;</span><span class=p>;</span><span class=err>
</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// The tstorage service definition.
</span><span class=c1></span><span class=kd>service</span> <span class=n>TStorage</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span> <span class=p>(</span><span class=n>HelloRequest</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>HelloReply</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span><span class=err></span>    <span class=k>rpc</span> <span class=n>InsertRow</span> <span class=p>(</span><span class=n>TimeSeriesDatum</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>InsertResponse</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span><span class=err></span>    <span class=k>rpc</span> <span class=n>InsertRows</span> <span class=p>(</span><span class=n>stream</span> <span class=n>TimeSeriesDatum</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>InsertResponse</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span><span class=err></span>    <span class=k>rpc</span> <span class=n>Select</span> <span class=p>(</span><span class=n>Filter</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>stream</span> <span class=n>DataPoint</span><span class=p>)</span> <span class=p>{}</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// --- HELLO ENDPOINT ---
</span><span class=c1></span><span class=err>
</span><span class=err></span><span class=c1>// The request message containing the user&#39;s name.
</span><span class=c1></span><span class=kd>message</span> <span class=nc>HelloRequest</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// The response message containing the greetings
</span><span class=c1></span><span class=kd>message</span> <span class=nc>HelloReply</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// --- COMMON TO ALL ENDPOINTS ---
</span><span class=c1></span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>DataPoint</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>double</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>Label</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>TimeSeriesDatum</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=n>metric</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=k>repeated</span> <span class=n>Label</span> <span class=n>labels</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=kt>double</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// --- INSERT ENDPOINT ---
</span><span class=c1></span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>InsertResponse</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=kd>message</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=kt>bool</span> <span class=n>status</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=c1>// --- SELECT ENDPOINT ---
</span><span class=c1></span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>Filter</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=kt>string</span> <span class=n>metric</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=k>repeated</span> <span class=n>Label</span> <span class=n>labels</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>start</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span><span class=err></span>    <span class=n>google.protobuf.Timestamp</span> <span class=n>end</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=kd>message</span> <span class=nc>SelectResponse</span> <span class=p>{</span><span class=err>
</span><span class=err></span>    <span class=k>repeated</span> <span class=n>DataPoint</span> <span class=n>points</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span><span class=err></span><span class=p>}</span><span class=err>
</span></code></pre></div><p>In your <strong>terminal</strong> please write the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>protoc --go_out<span class=o>=</span>.      --go_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative <span class=se>\
</span><span class=se></span>       --go-grpc_out<span class=o>=</span>. --go-grpc_opt<span class=o>=</span><span class=nv>paths</span><span class=o>=</span>source_relative <span class=se>\
</span><span class=se></span>  proto/tstorage.proto
</code></pre></div><p>Afterwards update the following file:</p><h4 id=2-of-2-githubcombartmikatstorage-serverinternalserver_implgo>(2 of 2) github.com/bartmika/tstorage-server/internal/server_impl.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>internal</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&#34;context&#34;</span>
    <span class=s>&#34;log&#34;</span>
    <span class=s>&#34;io&#34;</span>

    <span class=s>&#34;github.com/nakabonne/tstorage&#34;</span>
    <span class=nx>tspb</span> <span class=s>&#34;github.com/golang/protobuf/ptypes/timestamp&#34;</span>

    <span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>TStorageServerImpl</span> <span class=kd>struct</span><span class=p>{</span>
	<span class=nx>storage</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Storage</span>
    <span class=nx>pb</span><span class=p>.</span><span class=nx>TStorageServer</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloRequest</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received: %v&#34;</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>HelloReply</span><span class=p>{</span><span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Hello &#34;</span> <span class=o>+</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()},</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>InsertRow</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>InsertResponse</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// // For debugging purposes only.
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Metric&#34;, in.Metric)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Value&#34;, in.Value)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Timestamp&#34;, in.Timestamp)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Labels&#34;, in.Labels)
</span><span class=c1></span>
    <span class=c1>// Generate our labels, if there are any.
</span><span class=c1></span>    <span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>label</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Labels</span> <span class=p>{</span>
        <span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Value</span><span class=p>,})</span>
    <span class=p>}</span>

    <span class=c1>// Generate our datapoint.
</span><span class=c1></span>    <span class=nx>dataPoint</span> <span class=o>:=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>DataPoint</span><span class=p>{</span><span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nx>Seconds</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Value</span><span class=p>}</span>

    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>InsertRows</span><span class=p>([]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Row</span><span class=p>{</span>
	    <span class=p>{</span>
		    <span class=nx>Metric</span><span class=p>:</span>    <span class=nx>in</span><span class=p>.</span><span class=nx>Metric</span><span class=p>,</span>
		    <span class=nx>Labels</span><span class=p>:</span>    <span class=nx>labels</span><span class=p>,</span>
		    <span class=nx>DataPoint</span><span class=p>:</span> <span class=nx>dataPoint</span><span class=p>,</span>
	    <span class=p>},</span>
    <span class=p>})</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>InsertResponse</span><span class=p>{</span><span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Created&#34;</span><span class=p>},</span> <span class=nx>err</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>InsertRows</span><span class=p>(</span><span class=nx>stream</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>TStorage_InsertRowsServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=c1>// // For debugging purposes only.
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Metric&#34;, in.Metric)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Value&#34;, in.Value)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Timestamp&#34;, in.Timestamp)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Labels&#34;, in.Labels)
</span><span class=c1></span>
    <span class=c1>// Wait and receieve the stream from the client.
</span><span class=c1></span>    <span class=k>for</span> <span class=p>{</span>
        <span class=nx>datum</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>SendAndClose</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>InsertResponse</span><span class=p>{</span>
                <span class=nx>Message</span><span class=p>:</span> <span class=s>&#34;Created&#34;</span><span class=p>,</span>
            <span class=p>})</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nx>err</span>
        <span class=p>}</span>

        <span class=c1>// Generate our labels, if there are any.
</span><span class=c1></span>        <span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>label</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>Labels</span> <span class=p>{</span>
            <span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Value</span><span class=p>,})</span>
        <span class=p>}</span>

        <span class=c1>// Generate our datapoint.
</span><span class=c1></span>        <span class=nx>dataPoint</span> <span class=o>:=</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>DataPoint</span><span class=p>{</span><span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nx>Seconds</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>datum</span><span class=p>.</span><span class=nx>Value</span><span class=p>}</span>

        <span class=nx>err</span> <span class=p>=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>InsertRows</span><span class=p>([]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Row</span><span class=p>{</span>
    	    <span class=p>{</span>
    		    <span class=nx>Metric</span><span class=p>:</span>    <span class=nx>datum</span><span class=p>.</span><span class=nx>Metric</span><span class=p>,</span>
    		    <span class=nx>Labels</span><span class=p>:</span>    <span class=nx>labels</span><span class=p>,</span>
    		    <span class=nx>DataPoint</span><span class=p>:</span> <span class=nx>dataPoint</span><span class=p>,</span>
    	    <span class=p>},</span>
        <span class=p>})</span>
    <span class=p>}</span>


    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TStorageServerImpl</span><span class=p>)</span> <span class=nf>Select</span><span class=p>(</span><span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Filter</span><span class=p>,</span> <span class=nx>stream</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>TStorage_SelectServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=c1>// // For debugging purposes only.
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Metric&#34;, in.Metric)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Labels&#34;, in.Labels)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;Start&#34;, in.Start.Seconds)
</span><span class=c1></span>    <span class=c1>// log.Println(&#34;End&#34;, in.End.Seconds)
</span><span class=c1></span>
    <span class=c1>// Generate our labels, if there are any.
</span><span class=c1></span>    <span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>label</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Labels</span> <span class=p>{</span>
        <span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=nx>tstorage</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>label</span><span class=p>.</span><span class=nx>Value</span><span class=p>,})</span>
    <span class=p>}</span>

    <span class=nx>points</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=nx>in</span><span class=p>.</span><span class=nx>Metric</span><span class=p>,</span> <span class=nx>labels</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Start</span><span class=p>.</span><span class=nx>Seconds</span><span class=p>,</span> <span class=nx>in</span><span class=p>.</span><span class=nx>End</span><span class=p>.</span><span class=nx>Seconds</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>err</span>
    <span class=p>}</span>


    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>point</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>points</span> <span class=p>{</span>
        <span class=nx>ts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
    	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>point</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>,</span>
    	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    	<span class=p>}</span>
        <span class=nx>dataPoint</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>DataPoint</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span> <span class=nx>point</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>ts</span><span class=p>,}</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>dataPoint</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>return</span> <span class=nx>err</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><h2 id=9>Part 7. Client Commands</h2><p>Please create the following blank files:</p><h4 id=project-hierarchy-5>Project Hierarchy</h4><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>ğŸ“ tstorage-server
â”‚   ğŸ“„ README.md
â”‚   ğŸ“„ main.go
â”‚   ğŸ“„ Makefile
â”‚
â””â”€â”€â”€ğŸ“ cmd
â”‚   <span class=p>|</span>
<span class=p>|</span>   â””â”€â”€â”€ğŸ“„ hello.go
<span class=p>|</span>       ğŸ“„ insert_row.go <span class=o>(</span>*<span class=o>)</span>
<span class=p>|</span>       ğŸ“„ insert_rows.go <span class=o>(</span>*<span class=o>)</span>
<span class=p>|</span>       ğŸ“„ root.go
<span class=p>|</span>       ğŸ“„ <span class=k>select</span>.go <span class=o>(</span>*<span class=o>)</span>
<span class=p>|</span>       ğŸ“„ serve.go
<span class=p>|</span>       ğŸ“„ version.go
â”‚
â””â”€â”€â”€ğŸ“ internal
<span class=p>|</span>    â”‚
<span class=p>|</span>    â””â”€â”€ğŸ“„ server_impl.go
<span class=p>|</span>       ğŸ“„ server.go
<span class=p>|</span>
â””â”€â”€â”€ğŸ“ proto
     â”‚
     â””â”€â”€ğŸ“„ tstorage_grpc.pb.go
        ğŸ“„ tstorage.proto
        ğŸ“„ tstorage.pb.go</code></pre></div><p>Next populate the following:</p><h4 id=1-of-3-cmdinsert_rowgo>(1 of 3) cmd/insert_row.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/insert_row.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;time&#34;</span>

	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
	<span class=s>&#34;google.golang.org/grpc&#34;</span>
	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span><span class=c1></span>
	<span class=nx>tspb</span> <span class=s>&#34;github.com/golang/protobuf/ptypes/timestamp&#34;</span>

	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=p>(</span>
	<span class=nx>metric</span> <span class=kt>string</span>
	<span class=nx>value</span> <span class=kt>float64</span>
	<span class=nx>tsv</span> <span class=kt>int64</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// The following are required.
</span><span class=c1></span>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metric</span><span class=p>,</span> <span class=s>&#34;metric&#34;</span><span class=p>,</span> <span class=s>&#34;m&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;The metric to attach to the TSD.&#34;</span><span class=p>)</span>
	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;metric&#34;</span><span class=p>)</span>
	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Float64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>value</span><span class=p>,</span> <span class=s>&#34;value&#34;</span><span class=p>,</span> <span class=s>&#34;v&#34;</span><span class=p>,</span> <span class=mf>0.00</span><span class=p>,</span> <span class=s>&#34;The value to attach to the TSD.&#34;</span><span class=p>)</span>
	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>)</span>
	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Int64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>tsv</span><span class=p>,</span> <span class=s>&#34;timestamp&#34;</span><span class=p>,</span> <span class=s>&#34;t&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;The timestamp to attach to the TSD.&#34;</span><span class=p>)</span>
	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;timestamp&#34;</span><span class=p>)</span>

	<span class=c1>// The following are optional and will have defaults placed when missing.
</span><span class=c1></span>	<span class=nx>insertRowCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>insertRowCmd</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>doInsertRow</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// Set up a direct connection to the gRPC server.
</span><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>port</span><span class=p>),</span>
		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
	<span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=c1>// Set up our protocol buffer interface.
</span><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewTStorageClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>

	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>

	<span class=nx>ts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>tsv</span><span class=p>,</span>
	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
	<span class=p>}</span>

	<span class=c1>// Generate our labels.
</span><span class=c1></span>	<span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
	<span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Source&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span><span class=s>&#34;Command&#34;</span><span class=p>})</span>

	<span class=c1>// Perform our gRPC request.
</span><span class=c1></span>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>InsertRow</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>{</span><span class=nx>Labels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span> <span class=nx>Metric</span><span class=p>:</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>ts</span><span class=p>,})</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not add: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

	<span class=c1>// Print out the gRPC response.
</span><span class=c1></span>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetMessage</span><span class=p>())</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>insertRowCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;insert_row&#34;</span><span class=p>,</span>
	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Insert single datum&#34;</span><span class=p>,</span>
	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and sends a single time-series datum.`</span><span class=p>,</span>
	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
		<span class=nf>doInsertRow</span><span class=p>()</span>
	<span class=p>},</span>
<span class=p>}</span>
</code></pre></div><h4 id=2-of-3-cmdinsert_rowsgo>(2 of 3) cmd/insert_rows.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/insert_rows.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;time&#34;</span>

	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
	<span class=s>&#34;google.golang.org/grpc&#34;</span>
	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span><span class=c1></span>
	<span class=nx>tspb</span> <span class=s>&#34;github.com/golang/protobuf/ptypes/timestamp&#34;</span>

	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// The following are required.
</span><span class=c1></span>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metric</span><span class=p>,</span> <span class=s>&#34;metric&#34;</span><span class=p>,</span> <span class=s>&#34;m&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;The metric to attach to the TSD.&#34;</span><span class=p>)</span>
	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;metric&#34;</span><span class=p>)</span>
	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Float64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>value</span><span class=p>,</span> <span class=s>&#34;value&#34;</span><span class=p>,</span> <span class=s>&#34;v&#34;</span><span class=p>,</span> <span class=mf>0.00</span><span class=p>,</span> <span class=s>&#34;The value to attach to the TSD.&#34;</span><span class=p>)</span>
	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>)</span>
	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Int64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>tsv</span><span class=p>,</span> <span class=s>&#34;timestamp&#34;</span><span class=p>,</span> <span class=s>&#34;t&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;The timestamp to attach to the TSD.&#34;</span><span class=p>)</span>
	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;timestamp&#34;</span><span class=p>)</span>

	<span class=c1>// The following are optional and will have defaults placed when missing.
</span><span class=c1></span>	<span class=nx>insertRowsCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>insertRowsCmd</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>doInsertRows</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// Set up a direct connection to the gRPC server.
</span><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>port</span><span class=p>),</span>
		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
	<span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=c1>// Set up our protocol buffer interface.
</span><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewTStorageClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>

	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>

	<span class=nx>ts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>tsv</span><span class=p>,</span>
	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
	<span class=p>}</span>

	<span class=c1>// Generate our labels.
</span><span class=c1></span>	<span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
	<span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Source&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span><span class=s>&#34;Command&#34;</span><span class=p>})</span>

	<span class=c1>// Perform our gRPC request.
</span><span class=c1></span>    <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>InsertRow</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>TimeSeriesDatum</span><span class=p>{</span><span class=nx>Labels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span> <span class=nx>Metric</span><span class=p>:</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>Timestamp</span><span class=p>:</span> <span class=nx>ts</span><span class=p>,})</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not add: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

	<span class=c1>// Print out the gRPC response.
</span><span class=c1></span>    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nf>GetMessage</span><span class=p>())</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>insertRowsCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;insert_rows&#34;</span><span class=p>,</span>
	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;Insert single datum using streaming&#34;</span><span class=p>,</span>
	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and send a time-series datum using the streaming RPC.`</span><span class=p>,</span>
	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
		<span class=nf>doInsertRows</span><span class=p>()</span>
	<span class=p>},</span>
<span class=p>}</span>
</code></pre></div><h4 id=3-of-3-cmdselectgo>(3 of 3) cmd/select.go</h4><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kn>package</span> <span class=nx>cmd</span> <span class=c1>// github.com/bartmika/tstorage-server/cmd/select.go
</span><span class=c1></span>
<span class=kn>import</span> <span class=p>(</span>
	<span class=s>&#34;context&#34;</span>
	<span class=s>&#34;fmt&#34;</span>
	<span class=s>&#34;io&#34;</span>
	<span class=s>&#34;log&#34;</span>
	<span class=s>&#34;time&#34;</span>

	<span class=s>&#34;github.com/spf13/cobra&#34;</span>
	<span class=s>&#34;google.golang.org/grpc&#34;</span>
	<span class=c1>// &#34;google.golang.org/grpc/credentials&#34;
</span><span class=c1></span>
	<span class=nx>tspb</span> <span class=s>&#34;github.com/golang/protobuf/ptypes/timestamp&#34;</span>

	<span class=nx>pb</span> <span class=s>&#34;github.com/bartmika/tstorage-server/proto&#34;</span>
<span class=p>)</span>

<span class=kd>var</span> <span class=p>(</span>
	<span class=nx>start</span> <span class=kt>int64</span>
	<span class=nx>end</span> <span class=kt>int64</span>
<span class=p>)</span>

<span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// The following are required.
</span><span class=c1></span>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>StringVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>metric</span><span class=p>,</span> <span class=s>&#34;metric&#34;</span><span class=p>,</span> <span class=s>&#34;m&#34;</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=s>&#34;The metric to filter by&#34;</span><span class=p>)</span>
	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;metric&#34;</span><span class=p>)</span>
	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Int64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>start</span><span class=p>,</span> <span class=s>&#34;start&#34;</span><span class=p>,</span> <span class=s>&#34;s&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;The start timestamp to begin our range&#34;</span><span class=p>)</span>
	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;start&#34;</span><span class=p>)</span>
	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>Int64VarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>end</span><span class=p>,</span> <span class=s>&#34;end&#34;</span><span class=p>,</span> <span class=s>&#34;e&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;The end timestamp to finish our range&#34;</span><span class=p>)</span>
	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>MarkFlagRequired</span><span class=p>(</span><span class=s>&#34;end&#34;</span><span class=p>)</span>

	<span class=c1>// The following are optional and will have defaults placed when missing.
</span><span class=c1></span>	<span class=nx>selectCmd</span><span class=p>.</span><span class=nf>Flags</span><span class=p>().</span><span class=nf>IntVarP</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>port</span><span class=p>,</span> <span class=s>&#34;port&#34;</span><span class=p>,</span> <span class=s>&#34;p&#34;</span><span class=p>,</span> <span class=mi>50051</span><span class=p>,</span> <span class=s>&#34;The port of our server.&#34;</span><span class=p>)</span>
	<span class=nx>rootCmd</span><span class=p>.</span><span class=nf>AddCommand</span><span class=p>(</span><span class=nx>selectCmd</span><span class=p>)</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>doSelectRow</span><span class=p>()</span> <span class=p>{</span>
	<span class=c1>// Set up a direct connection to the gRPC server.
</span><span class=c1></span>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span>
		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;:%v&#34;</span><span class=p>,</span><span class=nx>port</span><span class=p>),</span>
		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>(),</span>
		<span class=nx>grpc</span><span class=p>.</span><span class=nf>WithBlock</span><span class=p>(),</span>
	<span class=p>)</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>

	<span class=c1>// Set up our protocol buffer interface.
</span><span class=c1></span>	<span class=nx>client</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewTStorageClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>

	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
    <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>

    <span class=c1>// Convert the unix timestamp into the protocal buffers timestamp format.
</span><span class=c1></span>	<span class=nx>sts</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>start</span><span class=p>,</span>
	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
	<span class=p>}</span>
	<span class=nx>ets</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tspb</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>{</span>
	    <span class=nx>Seconds</span><span class=p>:</span> <span class=nx>end</span><span class=p>,</span>
	    <span class=nx>Nanos</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
	<span class=p>}</span>

	<span class=c1>// Generate our labels.
</span><span class=c1></span>	<span class=nx>labels</span> <span class=o>:=</span> <span class=p>[]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{}</span>
	<span class=nx>labels</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>labels</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Label</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;Source&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span><span class=s>&#34;Command&#34;</span><span class=p>})</span>

	<span class=c1>// Perform our gRPC request.
</span><span class=c1></span>    <span class=nx>stream</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Select</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Filter</span><span class=p>{</span><span class=nx>Labels</span><span class=p>:</span> <span class=nx>labels</span><span class=p>,</span> <span class=nx>Metric</span><span class=p>:</span> <span class=nx>metric</span><span class=p>,</span> <span class=nx>Start</span><span class=p>:</span> <span class=nx>sts</span><span class=p>,</span> <span class=nx>End</span><span class=p>:</span> <span class=nx>ets</span><span class=p>,})</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;could not select: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=c1>// Handle our stream of data from the server.
</span><span class=c1></span>	<span class=k>for</span> <span class=p>{</span>
		<span class=nx>dataPoint</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
			<span class=k>break</span><span class=p>;</span>
		<span class=p>}</span>
		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;error with stream: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
		<span class=p>}</span>

		<span class=c1>// Print out the gRPC response.
</span><span class=c1></span>	    <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Response: %s&#34;</span><span class=p>,</span> <span class=nx>dataPoint</span><span class=p>)</span>
	<span class=p>}</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>selectCmd</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>{</span>
	<span class=nx>Use</span><span class=p>:</span>   <span class=s>&#34;select&#34;</span><span class=p>,</span>
	<span class=nx>Short</span><span class=p>:</span> <span class=s>&#34;List data&#34;</span><span class=p>,</span>
	<span class=nx>Long</span><span class=p>:</span>  <span class=s>`Connect to the gRPC server and return list of results based on a selection filter.`</span><span class=p>,</span>
	<span class=nx>Run</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>cmd</span> <span class=o>*</span><span class=nx>cobra</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span> <span class=nx>args</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
		<span class=nf>doSelectRow</span><span class=p>()</span>
	<span class=p>},</span>
<span class=p>}</span>
</code></pre></div><h2 id=10>Part 8. Usage Examples</h2><h3 id=server-start>Server Start</h3><p>To begin please start the server. For all the sub-commands <code>insert_row</code>, <code>insert_rows</code>, and <code>select</code> to work, this server must be running or else you will get an error.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>go run main.go serve
</code></pre></div><p>If you get a message saying:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>2021/07/09 12:48:05 gRPC server is running.
</code></pre></div><p>Then success!</p><h3 id=insert-row>Insert Row</h3><p>In a new <strong>terminal tab</strong> or <strong>terminal window</strong>, please run the follow:</p><p>Insert a new time series datum, try:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>go run main.go insert_row --metric=&#34;Bart&#34; --value=123.4 --timestamp=1600000001
</code></pre></div><p>If you get a response like this then success then you have successfully created a record.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>2021/07/09 23:54:05 Server Response: Created
</code></pre></div><h3 id=insert-row-with-streams>Insert Row (with streams)</h3><p>To verify the client connects and produces the output we want, run the following:</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>go run main.go insert_rows --metric=&#34;Bart&#34; --value=123.4 --timestamp=1600000002
</code></pre></div><p>If you get a response like this then success!</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>2021/07/08 23:54:05 Server Response: Created
</code></pre></div><h3 id=select>Select</h3><p>To verify the client connects and produces the output we want, run the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>go run main.go <span class=k>select</span> --metric<span class=o>=</span><span class=s2>&#34;Bart&#34;</span> --start<span class=o>=</span><span class=m>1600000000</span> --end<span class=o>=</span><span class=m>1600000006</span>
</code></pre></div><p>If you get a response like this then success!</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>2021/07/09 00:27:11 Server Response: <span class=o>[</span>value:123.4  timestamp:<span class=o>{</span>seconds:1600000001<span class=o>}</span> value:123.4  timestamp:<span class=o>{</span>seconds:1600000002<span class=o>}</span> value:123.4  timestamp:<span class=o>{</span>seconds:1600000003<span class=o>}</span> value:123.4  timestamp:<span class=o>{</span>seconds:1600000004<span class=o>}</span> value:123.4  timestamp:<span class=o>{</span>seconds:1600000005<span class=o>}]</span>
</code></pre></div><p>You have successfully wrote a <a href=https://grpc.io><code>gRPC</code></a> server overtop a fast time-series database.</p><p>Cover photo by <a href=https://unsplash.com/@harrisonbroadbent>Harrison Broadbent</a> on <a href=https://unsplash.com>Unsplash</a>.</p><div class=blog-tags><a href=https://bartlomiejmika.com/tags/grpc/>gRPC</a>&nbsp;
<a href=https://bartlomiejmika.com/tags/golang/>Golang</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fbartlomiejmika.com%2fpost%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f&text=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server&via=" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fbartlomiejmika.com%2fpost%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fbartlomiejmika.com%2fpost%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f&title=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fbartlomiejmika.com%2fpost%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f&title=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fbartlomiejmika.com%2fpost%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f&title=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fbartlomiejmika.com%2fpost%2f2021%2fhow-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server%2f&description=How%20to%20Build%20a%20gRPC%20Server%20over%20tstorage%20to%20create%20tstorage-server" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/2021/quickstart-to-building-golang-apps-using-ipfs/>Quickstart to Building Golang Apps using IPFS</a></li><li><a href=/post/2021/docker-learning-resources-for-absolute-beginners-programming-with-golang/>Docker Learning Resources for Absolute Beginners Programming With Golang</a></li><li><a href=/post/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/>How to Build a gRPC Server for a SparkFun Weather Shield</a></li><li><a href=/post/2021/how-to-read-data-from-a-sparkfun-weather-shield-dev-13956-in-golang/>How to Read Data From a SparkFun Weather Shield (DEV-13956) in Golang</a></li><li><a href=/post/2021/how-to-do-dynamic-filtering-in-golang-using-only-the-database-sql-package-like-in-django/>How to do Dynamic Filtering in Golang using only the Database SQL Package like in Django</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://bartlomiejmika.com/post/2021/how-to-build-a-grpc-server-for-a-sparkfun-weather-shield/ data-toggle=tooltip data-placement=top title="How to Build a gRPC Server for a SparkFun Weather Shield">&larr; Previous Post</a></li><li class=next><a href=https://bartlomiejmika.com/post/2021/docker-learning-resources-for-absolute-beginners-programming-with-golang/ data-toggle=tooltip data-placement=top title="Docker Learning Resources for Absolute Beginners Programming With Golang">Next Post &rarr;</a></li></ul><div class=disqus-comments><button id=show-comments class="btn btn-default" type=button>Show <span class=disqus-comment-count data-disqus-url=https://bartlomiejmika.com/post/2021/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server>comments</span></button><div id=disqus_thread></div><script type=text/javascript>var disqus_config=function(){this.page.url='https:\/\/bartlomiejmika.com\/post\/2021\/how-to-build-a-grpc-server-over-tstorage-to-create-tstorage-server';};</script></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:bart@mikasoftware.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://www.facebook.com/bartlomiej-mika title=Facebook><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/bartmika title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://reddit.com/u/eurasiasoft title=Reddit><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-reddit-alien fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/bartlomiej-mika-a9a5683b title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i><i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=https://mikasoftware.com>Mika Software Corporation</a>
&nbsp;&bull;&nbsp;&copy;
2021
&nbsp;&bull;&nbsp;
<a href=https://bartlomiejmika.com>Bartlomiej Mika</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.80.0</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js integrity=sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js integrity=sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe crossorigin=anonymous></script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=https://bartlomiejmika.com/js/main.js></script><script src=https://bartlomiejmika.com/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0");});</script><script>renderMathInElement(document.body);</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://bartlomiejmika.com/js/load-photoswipe.js></script><script type=text/javascript>$(function(){$('#show-comments').on('click',function(){var disqus_shortname='bartlomiej-mika';(function(){var disqus=document.createElement('script');disqus.type='text/javascript';disqus.async=true;disqus.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(disqus);})();$(this).hide();});});</script><script id=dsq-count-scr src=//bartlomiej-mika.disqus.com/count.js async></script></body></html>