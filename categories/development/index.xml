<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>development on Bartlomiej Mika</title><link>https://bartlomiejmika.com/categories/development/</link><description>Bartlomiej Mika (development)</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Thu, 13 Aug 2020 23:14:55 -0400</lastBuildDate><atom:link href="https://bartlomiejmika.com/categories/development/index.xml" rel="self" type="application/rss+xml"/><item><title>How to Write a Unit Test for a Remote Procedural Call in Golang</title><link>https://bartlomiejmika.com/posts/2020/08/13/how-to-write-a-unit-test-for-a-remote-procedural-call-in-golang/</link><pubDate>Thu, 13 Aug 2020 23:14:55 -0400</pubDate><guid>https://bartlomiejmika.com/posts/2020/08/13/how-to-write-a-unit-test-for-a-remote-procedural-call-in-golang/</guid><description>&lt;p>Recently I have been learning about &lt;strong>remote procedural calls&lt;/strong> (RPCs) in *&lt;em>Golang&lt;/em> and realized I was unable to find an easy example on how to write a unit test for RPCs. In this post, I&amp;rsquo;ll explain how I figured out a solution.&lt;/p>
&lt;h2 id="assumption">Assumption&lt;/h2>
&lt;p>Before I begin, I am assuming you are just starting to learn about &lt;strong>remote procedural calls&lt;/strong> (RPCs) and you don&amp;rsquo;t know how you would go about writing a single unit test.&lt;/p>
&lt;h2 id="what-is-a-remote-procedural-call">What is a remote procedural call?&lt;/h2>
&lt;p>According to &lt;a href="https://en.wikipedia.org/wiki/Remote_procedure_call">this Wikipedia article&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>a &lt;strong>remote procedure call (RPC)&lt;/strong> is when a computer program causes a procedure (subroutine) to execute in a different address space (commonly on another computer on a shared network), which is coded as if it were a normal (local) procedure call, without the programmer explicitly coding the details for the remote interaction. That is, the programmer writes essentially the same code whether the subroutine is local to the executing program, or remote.&lt;/p>
&lt;/blockquote>
&lt;p>So in essence you can write a bunch of &lt;strong>functions&lt;/strong> in your application, serve these functions over the network and other programmers can call your functions locally on their computer and not worry about the network interaction - &lt;em>how cool is that&lt;/em>?&lt;/p>
&lt;h2 id="how-does-rpc-work-in-golang">How does RPC work in Golang?&lt;/h2>
&lt;p>I will skip this section and refer you to an excellent resource I used to learn how RPC works in Golang. Please checkout &lt;a href="https://tumregels.github.io/Network-Programming-with-Go/rpc/go_rpc.html">Chapter 13 Remote Procedure Call via
&amp;ldquo;Network Programming with Go&amp;rdquo; by Levon&lt;/a>.&lt;/p>
&lt;h2 id="how-to-unit-test">How to Unit Test?&lt;/h2>
&lt;p>Let&amp;rsquo;s pretend you have written the following RPC methods which you want to serve in your RPC server:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">// mathrpc.go
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">mathrpc&lt;/span>
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Args&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> {
&lt;span style="color:#a6e22e">A&lt;/span>, &lt;span style="color:#a6e22e">B&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>
}
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Quotient&lt;/span> &lt;span style="color:#66d9ef">struct&lt;/span> {
&lt;span style="color:#a6e22e">Quo&lt;/span>, &lt;span style="color:#a6e22e">Rem&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>
}
&lt;span style="color:#66d9ef">type&lt;/span> &lt;span style="color:#a6e22e">Arith&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>
&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">Arith&lt;/span>) &lt;span style="color:#a6e22e">Multiply&lt;/span>(&lt;span style="color:#a6e22e">args&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">Args&lt;/span>, &lt;span style="color:#a6e22e">reply&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#66d9ef">int&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span> {
&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">reply&lt;/span> = &lt;span style="color:#a6e22e">args&lt;/span>.&lt;span style="color:#a6e22e">A&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#a6e22e">args&lt;/span>.&lt;span style="color:#a6e22e">B&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>
}
&lt;span style="color:#66d9ef">func&lt;/span> (&lt;span style="color:#a6e22e">t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">Arith&lt;/span>) &lt;span style="color:#a6e22e">Divide&lt;/span>(&lt;span style="color:#a6e22e">args&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">Args&lt;/span>, &lt;span style="color:#a6e22e">quo&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">Quotient&lt;/span>) &lt;span style="color:#66d9ef">error&lt;/span> {
&lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#a6e22e">args&lt;/span>.&lt;span style="color:#a6e22e">B&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> {
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">error&lt;/span>.&lt;span style="color:#a6e22e">String&lt;/span>(&lt;span style="color:#e6db74">&amp;#34;divide by zero&amp;#34;&lt;/span>)
}
&lt;span style="color:#a6e22e">quo&lt;/span>.&lt;span style="color:#a6e22e">Quo&lt;/span> = &lt;span style="color:#a6e22e">args&lt;/span>.&lt;span style="color:#a6e22e">A&lt;/span> &lt;span style="color:#f92672">/&lt;/span> &lt;span style="color:#a6e22e">args&lt;/span>.&lt;span style="color:#a6e22e">B&lt;/span>
&lt;span style="color:#a6e22e">quo&lt;/span>.&lt;span style="color:#a6e22e">Rem&lt;/span> = &lt;span style="color:#a6e22e">args&lt;/span>.&lt;span style="color:#a6e22e">A&lt;/span> &lt;span style="color:#f92672">%&lt;/span> &lt;span style="color:#a6e22e">args&lt;/span>.&lt;span style="color:#a6e22e">B&lt;/span>
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">nil&lt;/span>
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>How would you unit test the above code? You can write code as follows:&lt;/p>
&lt;div class="highlight">&lt;pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-go" data-lang="go">&lt;span style="color:#75715e">//mathrpc_test.go
&lt;/span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">package&lt;/span> &lt;span style="color:#a6e22e">mathrpc&lt;/span>
&lt;span style="color:#f92672">import&lt;/span> (
&lt;span style="color:#e6db74">&amp;#34;testing&amp;#34;&lt;/span>
&lt;span style="color:#e6db74">&amp;#34;github.com/stretchr/testify/assert&amp;#34;&lt;/span>
)
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">TestMultiplyWithSuccess&lt;/span>(&lt;span style="color:#a6e22e">t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">testing&lt;/span>.&lt;span style="color:#a6e22e">T&lt;/span>) {
&lt;span style="color:#75715e">// Setup our test.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">arith&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> new(&lt;span style="color:#a6e22e">Arith&lt;/span>)
&lt;span style="color:#a6e22e">args&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">Args&lt;/span>{&lt;span style="color:#ae81ff">3&lt;/span>, &lt;span style="color:#ae81ff">2&lt;/span>}
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">reply&lt;/span> &lt;span style="color:#66d9ef">int&lt;/span>
&lt;span style="color:#75715e">// Perform our operation.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">arith&lt;/span>.&lt;span style="color:#a6e22e">Multiply&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">args&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">reply&lt;/span>)
&lt;span style="color:#75715e">// Perform our validation
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">assert&lt;/span>.&lt;span style="color:#a6e22e">NoError&lt;/span>(&lt;span style="color:#a6e22e">t&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
&lt;span style="color:#a6e22e">assert&lt;/span>.&lt;span style="color:#a6e22e">Equal&lt;/span>(&lt;span style="color:#a6e22e">t&lt;/span>, &lt;span style="color:#ae81ff">6&lt;/span>, &lt;span style="color:#a6e22e">reply&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;Did not multiply correctly!`&amp;#34;&lt;/span>)
}
&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">TestDivideWithSuccess&lt;/span>(&lt;span style="color:#a6e22e">t&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#a6e22e">testing&lt;/span>.&lt;span style="color:#a6e22e">T&lt;/span>) {
&lt;span style="color:#75715e">// Setup our test.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">arith&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> new(&lt;span style="color:#a6e22e">Arith&lt;/span>)
&lt;span style="color:#a6e22e">args&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">Args&lt;/span>{&lt;span style="color:#ae81ff">17&lt;/span>, &lt;span style="color:#ae81ff">8&lt;/span>}
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">reply&lt;/span> &lt;span style="color:#a6e22e">Quotient&lt;/span>
&lt;span style="color:#75715e">// Perform our operation.
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">err&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#a6e22e">arith&lt;/span>.&lt;span style="color:#a6e22e">Divide&lt;/span>(&lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">args&lt;/span>, &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#a6e22e">reply&lt;/span>)
&lt;span style="color:#75715e">// Perform our validation
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">assert&lt;/span>.&lt;span style="color:#a6e22e">NoError&lt;/span>(&lt;span style="color:#a6e22e">t&lt;/span>, &lt;span style="color:#a6e22e">err&lt;/span>)
&lt;span style="color:#a6e22e">assert&lt;/span>.&lt;span style="color:#a6e22e">Equal&lt;/span>(&lt;span style="color:#a6e22e">t&lt;/span>, &lt;span style="color:#ae81ff">2&lt;/span>, &lt;span style="color:#a6e22e">reply&lt;/span>.&lt;span style="color:#a6e22e">Quo&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;Did not return correct quotient`&amp;#34;&lt;/span>)
&lt;span style="color:#a6e22e">assert&lt;/span>.&lt;span style="color:#a6e22e">Equal&lt;/span>(&lt;span style="color:#a6e22e">t&lt;/span>, &lt;span style="color:#ae81ff">125&lt;/span>, &lt;span style="color:#a6e22e">reply&lt;/span>.&lt;span style="color:#a6e22e">Rem&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;Did not return correct remainder`&amp;#34;&lt;/span>)
}
&lt;/code>&lt;/pre>&lt;/div>&lt;p>As you can see, it&amp;rsquo;s not too difficult to write a unit test on an RPC; in essence, you can treat the RPC function as if was a plain function and write a plain unit test on it.&lt;/p></description></item></channel></rss>